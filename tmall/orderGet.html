<?
//exit;
set_time_limit(0);
mb_internal_encoding("UTF-8");
if(!$INCLUDE_COMM) include "PUBLIC_FUNC/ADMIN_V2/COMM_FUNC.inc";
if(!$IS_FUNC_CORE) include "PUBLIC_FUNC/ADMIN_V2/func_core.inc";
if(!$IS_FUNC_EXTRA) include "PUBLIC_FUNC/ADMIN_V2/func_extra.inc";
if(!$IS_FUNC_SOURCE_SITE_IMG) include "PUBLIC_FUNC/ADMIN_V2/func_source_site_img.inc";
if(!$IS_JSON_CLASS) include "PUBLIC_FUNC/ADMIN_V2/func_json_class.inc";
include "PUBLIC_FUNC/ADMIN_V2/func_image_v3.inc";
if(!$IS_TMALL_CONFIG) include "PUBLIC_FUNC/ADMIN_V2/tmall/config.inc.php";
if(!$IS_FUNC_TMALL_CORE) include "PUBLIC_FUNC/ADMIN_V2/tmall/func_tmall_core.inc";
include 'PUBLIC_FUNC/ADMIN_V2/tmall/jushita/JushitaTaobaoClient.php';
if(!$IS_WECHAT_CONFIG) include "PUBLIC_FUNC/ADMIN_V2/wechat/config.inc";
if(!$IS_FUNC_WECHAT_CORE) include "PUBLIC_FUNC/ADMIN_V2/wechat/func_wechat_core.inc";

$execution_proc_id = 68;
$execution_file = "68_orderGet";
$start_time = time();

/*   
$argv 구분은 공백으로 처리 한다.
첫번째 값은 trade_order_id 이면 단수로만 넣을 수 있다 (예:382401601242352)
/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/order/68_orderGet.html 640221953356820461 &

최근 3개월 매출 데이터 가져오기
/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/order/68_orderGet.html last_3_month &
*/

//$arr_only_this_oids = array('1069957924301363');
$arr_only_this_oids = array();
$is_yes_print = 0;
$is_proc_check = 1;
$is_last_3_month = 0;
$is_last_7_day = 0;
$and_trade_order_id = "";
//$api_sleep_sec = 300;
$api_sleep_sec = 18;
foreach($argv AS $key=>$value)
{
	if(!$value) continue;
	if($key ==0) // 이 파일 위치 값을 가지고 있어서 스킵
	{
		continue;
	}
	else if($key == 1)
	{
		$value = trim($value);
		if($value)
		{
			if($value == 'last_3_month')
			{
				$is_last_3_month = 1;
			}
			else if($value == 'last_7_day')
			{
				$is_last_7_day = 1;
			}
			else
			{
				$and_trade_order_id = $value;
				$is_proc_check = 0;
				$is_yes_print = 1;
			}
		}
	}
}

if($is_yes_print > 0)
{
	$echoPrint = 1;
	$echoBrStr = "\r\n";
}

$dbconn = dbSelect($tmall_db,dbConn($tmall_host));

$now_time = (int) date("G");
$arr_not_sms_time = array(1,2,3,4,5,6,7,8,9);
if($is_proc_check > 0)
{
	$result = mysql_query("SELECT is_proc,continue_stop_num FROM {$tmall_db}._proc_uid WHERE uid={$execution_proc_id}",$dbconn);
	$row = mysql_fetch_assoc($result);
	if($row['is_proc'] > 1)
	{
		$err = "Error - {$execution_file} - Already excution.";
		if($row['continue_stop_num'] > 1)
		{
			$wx_msg_ration = $row['continue_stop_num']%4;
			if($wx_msg_ration=='0')
			{
				foreach($arr_bf_admin_wx_msg_openId AS $bf_admin_id=>$wx_openId)
				{
					$msg_str = $err;
					$arr_vars = array(
						'wx_openId'=>$wx_openId,
						'msg_str'=>$msg_str,
						'msg_type'=>'text',
						'is_need_date_msg'=>1,
						'isPDO'=>0,
						'dbconn'=>$dbconn,
						'is_yes_print'=>$is_yes_print
					);
					$arr_wx_msg = func_wx_sent_msg($arr_vars);//To use this function, "wechat/config.inc, wechat/func_wechat_core.inc" must be included.
					unset($arr_vars);
					if($is_yes_print > 0)
					{
						echo "arr_wx_msg = ";
						print_r($arr_wx_msg);
					}
					unset($arr_wx_msg);
				}
			}			
		}
		dbQuery("UPDATE {$tmall_db}._proc_uid SET continue_stop_num=continue_stop_num+1 WHERE uid={$execution_proc_id}",$dbconn);
		dbClose($dbconn);
		/*
if($row['continue_stop_num'] > 1)
		{
			$sms_ration = $row['continue_stop_num']%4;
			if($sms_ration=='0')
			{
				if(!in_array($now_time, $arr_not_sms_time))
				{
					$cell_value = $ADMIN_CELL_PHONE;
					$cell_len = strlen($cell_value);
					if($cell_len == 11)
					{
						$sms = fsockopen_normal_sms($err, $cell_value, 0);
					}
				}
			}
		}
		$subject = "[BUYFINE-Tmall] {$err} - ".date("Y-m-d H");
		echo $subject."\r\n";
		fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
*/
		exit;
	}
	else
	{
		dbQuery("UPDATE {$tmall_db}._proc_uid SET is_proc=2, continue_stop_num=0 WHERE uid={$execution_proc_id}",$dbconn);
	}
}

$query = "SELECT trade_main_order_id FROM {$tmall_db}.tmall_payment_refund_tid WHERE version=1";//환불금액을 받은 주문번호
$result = dbQuery($query, $dbconn);
$arr_tmall_db_refund_tid = array();
while($row=mysql_fetch_assoc($result))
{
	$refund_tid = $row['trade_main_order_id'];
	//$arr_tmall_db_refund_tid[] = $refund_tid;
	$arr_tmall_db_refund_tid[$refund_tid] = 1;
}

$query = "SELECT trade_main_order_id FROM {$tmall_db}.tmall_payment_refund_skip_tid WHERE version=1";//매칭된상품이 없고 해외주문전 취소한 주문번호
$result = dbQuery($query, $dbconn);
$arr_tmall_db_refund_skip_tid = array();
while($row=mysql_fetch_assoc($result))
{
	$refund_tid = $row['trade_main_order_id'];
	$arr_tmall_db_refund_skip_tid[$refund_tid] = 1;
}

$query = "SELECT TPOS.order_status_code, TPOS.order_status, TPOS.bf_pa_status FROM {$tmall_db}.tmall_payment_order_status TPOS";
$result = dbQuery($query, $dbconn);
$arr_tmall_order_status_code = array();
$arr_bf_order_status_code = array();
while($row=mysql_fetch_assoc($result))
{
	$arr_tmall_order_status_code[$row['order_status']] = $row['order_status_code'];
	$arr_bf_order_status_code[$row['order_status']] = $row['bf_pa_status'];
}
	
/* Get sessionkey Key start  */
$arr_proc_uid_info = func_get_tmall_proc_uid(1, 0, 1, 0, $dbconn); //$uid=1, $sleep_num=0, $is_already_dbconn=0, $connIsPDO=0, $dbconn="" | func_get_tmall_proc_uid assign func_tmall_core.inc
$tmall_sessionkey = $arr_proc_uid_info['sessionkey'];
//echo $tmall_sessionkey;exit;
/* Get sessionkey Key end  */
dbClose($dbconn);

$total_results = 0;
/* Get total_results start */
$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);

$arr_err_wx_msg = array();
$arr_get_tid = array();
$arr_order_info = array();
$arr_err_info = array();
$arr_use_json_str = array();
$is_new_order_check_json = 0;

$arr_use_json_change_key = array(
	'tid'=>'trade_main_order_id',
	'shipping_type'=>'deliver_type',
	'alipay_no'=>'order_alipay_number',
	'created'=>'order_create_time',
	'pay_time'=>'order_paid_time',
	'status'=>'order_status',
	'payment'=>'pay_fee',
	'receiver_state'=>'receiver_province',
	'receiver_phone'=>'receiver_tel',
	'orders.oid'=>'trade_sub_order_id',
	'orders.num'=>'item_amount',
	'orders.discount_fee'=>'item_discount_fee',
	'orders.num_iid'=>'item_id',
	'orders.title'=>'item_name',
	'orders.outer_sku_id'=>'item_outer_code',
	'orders.outer_iid'=>'outer_iid',
	'orders.sku_id'=>'item_sku',#orders.sku_id|orders.sku_properties_name=>sub_orders.item_sku
	'orders.payment'=>'item_total_fee',
	'orders.price'=>'item_price',
	'orders.status'=>'sub_order_status'
);
$arr_use_cross_100_key = array('adjust_fee','pay_fee','discount_fee','point_fee','post_fee','total_fee','item_discount_fee','item_price','item_total_fee');
$is_tmall_i18n = 1;
if($and_trade_order_id)
{
	//!!!!!중요 - 만약 tmall oid를 단수로 가져와서 바이파인 디비에 업데이트 하려면 $is_new_order_check_json=1로 처리해주면 된다.
	//$is_new_order_check_json = 1;
	$is_new_order_check_json = 0;
	$apiName = "taobao.trade.fullinfo.get";
	//$apiName = "taobao.trades.sold.get";
	$apiParams = array(
		"format" => "json",
		"fields" => "seller_nick,buyer_nick,buyer_open_uid,title,type,created,sid,tid,seller_rate,buyer_rate,status,payment,discount_fee,adjust_fee,post_fee,total_fee,pay_time,end_time,modified,consign_time,buyer_obtain_point_fee,point_fee,real_point_fee,received_payment,commission_fee,pic_path,num_iid,num_iid,num,price,cod_fee,cod_status,shipping_type,receiver_name,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_mobile,receiver_phone,trade_from,orders.title,orders.pic_path,orders.price,orders.num,orders.iid,orders.num_iid,orders.sku_id,orders.refund_status,orders.status,orders.oid,orders.total_fee,orders.payment,orders.discount_fee,orders.adjust_fee,orders.sku_properties_name,orders.item_meal_name,orders.buyer_rate,orders.seller_rate,orders.outer_iid,orders.outer_sku_id,orders.refund_id,orders.seller_type,orders.order_from,oaid",
		"include_oaid"=>"true",
		"tid" => $and_trade_order_id
	);
	$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
	if(is_array($apiReturnJson))
	{
		if($is_yes_print > 0)
		{
			print_r($apiReturnJson);
		}
		if($apiReturnJson['trade']['tid'])
		{
			$tid = trim($apiReturnJson['trade']['tid']);
			if($tid)
			{
				$arr_get_tid[] = "'".$tid."'";
				$arr_order_info[$tid]['status'] = strtolower(trim($apiReturnJson['trade']['status']));
				$arr_order_info[$tid]['trade_from'] = strtolower(@trim(preg_replace("/\s+/"," ",$apiReturnJson['trade']['trade_from'])));
				$arr_order_info[$tid]['payment'] = trim($apiReturnJson['trade']['payment']);
				$arr_order_info[$tid]['discount_fee'] = trim($apiReturnJson['trade']['discount_fee']);
				$arr_order_info[$tid]['total_fee'] = trim($apiReturnJson['trade']['total_fee']);
				$arr_order_info[$tid]['oaid'] = "";
				if($apiReturnJson['trade']['oaid'])
				{
					$arr_order_info[$tid]['oaid'] = @trim($apiReturnJson['trade']['oaid']);
				}
				//print_r($apiReturnJson['trade']['orders']['order']);
				$refund_fee = 0;
				foreach($apiReturnJson['trade']['orders']['order'] AS $arr_each_order)
				{
					$arr_order_info[$tid]['each_item_discount_fee'] += $arr_each_order['discount_fee'];
					$refund_status = strtolower(trim($arr_each_order['refund_status']));
					//echo "refund_status = ".$refund_status."\r\n";
					if($refund_status == 'success')
					{
						$refund_fee += $arr_each_order['total_fee']-$arr_each_order['discount_fee'];
					}
				}
				$arr_order_info[$tid]['refund_fee'] = $refund_fee;
				$arr_order_info[$tid]['total_discount_fee'] = $arr_order_info[$tid]['discount_fee']+$arr_order_info[$tid]['each_item_discount_fee'];
				/*
				$arr_order_info[$tid]['adjust_fee'] = trim($apiReturnJson['trade']['adjust_fee']);
				$arr_order_info[$tid]['post_fee'] = trim($apiReturnJson['trade']['post_fee']);
				$arr_order_info[$tid]['pay_time'] = trim($apiReturnJson['trade']['pay_time']);
				$arr_order_info[$tid]['end_time'] = trim($apiReturnJson['trade']['end_time']);
				$arr_order_info[$tid]['modified'] = trim($apiReturnJson['trade']['modified']);
				$arr_order_info[$tid]['consign_time'] = trim($apiReturnJson['trade']['consign_time']);
				*/
				if($is_new_order_check_json > 0)
				{
					$each_item_discount_fee = 0;
					foreach($apiReturnJson['trade'] AS $get_key=>$get_value)
					{
						if($get_key == 'orders')
						{
							$loop_idx = 0;
							foreach($get_value['order'] AS $arr_order_value)
							{
								foreach($arr_order_value AS $loop_order_key=>$loop_order_value)
								{
									if($loop_order_key=='sku_id' || $loop_order_key=='sku_properties_name')
									{
										continue;
									}
									$temp_order_key = "orders.".$loop_order_key;
									if($arr_use_json_change_key[$temp_order_key])
									{
										$loop_order_key = $arr_use_json_change_key[$temp_order_key];
									}
									if(in_array($loop_order_key, $arr_use_cross_100_key))
									{
										$loop_order_value = $loop_order_value*100;
									}
									if($loop_order_key == 'sub_order_status')
									{
										$loop_order_value = strtolower($loop_order_value);
									}
									if($loop_order_key == 'order_from')
									{
										$loop_order_value = strtolower(@trim(preg_replace("/\s+/"," ",$loop_order_value)));
									}
									if($loop_order_key == 'item_discount_fee')
									{
										$each_item_discount_fee += $loop_order_value;
									}
									$loop_order_value = str_ireplace("'","`",$loop_order_value);
									$loop_order_value = str_ireplace("&","＆",$loop_order_value);
									$loop_order_value = str_ireplace("+","＋",$loop_order_value);
									$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx][$loop_order_key] = $loop_order_value;
								}
								$arr_order_value['sku_properties_name'] = str_ireplace("'","`",$arr_order_value['sku_properties_name']);
								$arr_order_value['sku_properties_name'] = str_ireplace("&","＆",$arr_order_value['sku_properties_name']);
								$arr_order_value['sku_properties_name'] = str_ireplace("+","＋",$arr_order_value['sku_properties_name']);
								$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['item_sku'] = $arr_order_value['sku_id']."|".$arr_order_value['sku_properties_name'];
								//$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['order_from'] = 'TAOBAO';
								$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['order_promotions'] = array();
								$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['order_tags'] = array();
								$loop_idx++;
							}
						}
						else
						{
							$get_value = str_ireplace("'","`",$get_value);
							$get_value = str_ireplace("&","＆",$get_value);
							$get_value = str_ireplace("+","＋",$get_value);
							if($is_yes_print > 0)
							{
								echo $get_key."=".$get_value."\r\n";
							}
							if($arr_use_json_change_key[$get_key])
							{
								$get_key = $arr_use_json_change_key[$get_key];
							}
							if(in_array($get_key, $arr_use_cross_100_key))
							{
								$get_value = $get_value*100;
							}
							if($get_key == 'order_status')
							{
								$get_value = strtolower($get_value);
							}
							if($get_key == 'trade_from')
							{
								$get_value = strtolower(@trim(preg_replace("/\s+/"," ",$get_value)));
							}
							$arr_use_json_str[$tid]['Order'][$get_key] = $get_value;
						}
					}
					$arr_use_json_str[$tid]['Order']['buyer_name'] = '';
					$arr_use_json_str[$tid]['Order']['seller_rate_status'] = 'false';
					$arr_use_json_str[$tid]['Order']['buyer_id'] = $apiReturnJson['trade']['buyer_nick'];
					$arr_use_json_str[$tid]['Order']['buyer_open_uid'] = $apiReturnJson['trade']['buyer_open_uid'];
					$arr_use_json_str[$tid]['Order']['buyer_rate_status'] = 'false';
					$arr_use_json_str[$tid]['Order']['order_promotions'] = array();
					$arr_use_json_str[$tid]['Order']['order_relation_bills'] = array();
					$arr_use_json_str[$tid]['Order']['order_tags'] = array();
					$arr_use_json_str[$tid]['Order']['pay_type'] = 'other';
					$arr_use_json_str[$tid]['Order']['receiver_district_code'] = '';
					$arr_use_json_str[$tid]['Order']['seller_id'] = '1706222708';
					$arr_use_json_str[$tid]['Order']['seller_type'] = 'B';
					$arr_use_json_str[$tid]['Order']['shop_id'] = '0';
					$arr_use_json_str[$tid]['Order']['total_discount_fee'] = $arr_use_json_str[$tid]['Order']['discount_fee']+$each_item_discount_fee;
				}
			}
			else
			{
				$err_str = "not exist";
				$arr_err_info[] =  "{$and_trade_order_id} - Get single order - ".$apiName." : ".$err_str;
			}
		}
		else
		{
			$err_key =implode(", ",array_keys($apiReturnJson));
			$err_str = $err_key." - ".implode(", ",$apiReturnJson);
			$arr_err_info[] =  "{$and_trade_order_id} - Get single order - ".$apiName." : ".$err_str;
		}
	}
	else
	{
		$arr_err_info[] = "{$and_trade_order_id} - Get single order - ".$apiName." : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
	}
	if($arr_order_info[$and_trade_order_id]['oaid'])
	{
		$apiName = "taobao.top.oaid.decrypt";//복호화 제한 에러가 발생하면 店铺管理 > 隐私保护 > 提额 여기가서 처리하면 됨
		$arr_decrypt_oaid_var = array(
			"oaid"=>$arr_order_info[$and_trade_order_id]['oaid'],
			"tid" => $and_trade_order_id,
			"scene" => "1005"
		);
		$apiParams = array(
			"format" => "json",
			"query_list"=>json_encode($arr_decrypt_oaid_var)
		);
		$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
		if(is_array($apiReturnJson))
		{
			if($is_yes_print > 0)
			{
				print_r($apiReturnJson);
			}
		}
	}
	unset($apiClass);
	unset($apiParams);
	unset($apiReturnJson);
}
else
{	
	if($is_last_3_month > 0)
	{
		$ago_days_mktime = mktime (date("H"), date("i"), date("s"), date("m"), date("d")-90, date("Y"));
		//$ago_days_mktime = mktime (date("H"), date("i"), date("s"), date("m"), date("d")-60, date("Y"));
		//$ago_days_mktime = mktime (date("H"), date("i"), date("s"), date("m"), date("d")-30, date("Y"));
	}
	else if($is_last_7_day > 0)
	{
		$ago_days_mktime = mktime (date("H"), date("i"), date("s"), date("m"), date("d")-15, date("Y"));
		$is_tmall_i18n = 0;
	}
	else
	{
		$ago_days_mktime = mktime (date("H"), date("i"), date("s"), date("m"), date("d")-3, date("Y"));
	}
	$start_created = date("Y-m-d",$ago_days_mktime)." 00:00:00";
	$end_created = date("Y-m-d")." 23:59:59";
	
	//$start_created = "2019-05-08 00:00:00";
	//$end_created = "2019-05-08 23:59:59";
	/* 	 	seller_nick,buyer_nick,buyer_open_uid,title,type,created,sid,tid,seller_rate,buyer_rate,status,payment,discount_fee,adjust_fee,post_fee,total_fee,pay_time,end_time,modified,consign_time,buyer_obtain_point_fee,point_fee,real_point_fee,received_payment,commission_fee,pic_path,num_iid,num_iid,num,price,cod_fee,cod_status,shipping_type,receiver_name,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_mobile,receiver_phone,orders.title,orders.pic_path,orders.price,orders.num,orders.iid,orders.num_iid,orders.sku_id,orders.refund_status,orders.status,orders.oid,orders.total_fee,orders.payment,orders.discount_fee,orders.adjust_fee,orders.sku_properties_name,orders.item_meal_name,orders.buyer_rate,orders.seller_rate,orders.outer_iid,orders.outer_sku_id,orders.refund_id,orders.seller_type
	*/
	$apiName = "taobao.trades.sold.get";
	$apiParams = array(
		"format" => "json",
		"fields" => "tid,status,payment,discount_fee,adjust_fee,post_fee,total_fee,pay_time,end_time,modified,consign_time,oaid",
		"start_created" => $start_created,
		"end_created" => $end_created,
		"page_no" => "1",
		"page_size" => "1"
	);
	if($is_tmall_i18n > 0)
	{
		$add_params = array("type" => "tmall_i18n");
		$apiParams = array_merge($apiParams, $add_params);
	}
	
	$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
	if(is_array($apiReturnJson))
	{
		//print_r($apiReturnJson);
		if((count($apiReturnJson['trades']['trade'])>0) && ($apiReturnJson['total_results']>0))
		{
			$total_results = $apiReturnJson['total_results'];
		}
		else
		{
			$err_key =implode(", ",array_keys($apiReturnJson));
			$err_str = $err_key." - ".implode(", ",$apiReturnJson);
			$arr_err_info[] =  "Get total_results - ".$apiName." : ".$err_str;
		}
	}
	else
	{
		$arr_err_info[] = "Get total_results - ".$apiName." : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
	}
	unset($apiClass);
	unset($apiParams);
	unset($apiReturnJson);
	sleep($api_sleep_sec);
}
/* Get total_results end */
//exit;
if($is_yes_print > 0)
{
	echo "total_results = {$total_results}\r\n";
}

$arr_buyer_message_info = array();
if($and_trade_order_id)
{
}
else
{
	if($total_results > 0)
	{
		$page_size = 100;
		
		if($is_last_3_month > 0)
		{
			//$str_fields = "tid,status,payment,discount_fee,adjust_fee,post_fee,total_fee,pay_time,end_time,modified,consign_time,orders.oid,orders.refund_status,orders.total_fee,orders.discount_fee";
			$is_new_order_check_json = 1;
		}
		else if($is_last_7_day > 0)
		{
			$is_new_order_check_json = 1;
		}
		else
		{
			/* 
				func/.../admin_v2/tmall/JushitaTaobaoClient.php 에서 이값을 적용하며, 이값은 리턴값 포멧중 json형식이 있는데 기본 자동으로 array로 변환에서 리턴 되지만 경우에 따라 json 파일 그대로 받아야 하는경우가 있기때문에 이값을 선언함
				no_need_json_arr_enter: echoBrStr=\r\n, no_need_json_arr_br: echoBrStr=<br />
			*/
			//$echoBrStr = "no_need_json_arr_enter"; 
			$is_new_order_check_json = 1;
		}
		
		if($is_new_order_check_json > 0)
		{
			$str_fields = "tid,adjust_fee,buyer_nick,buyer_open_uid,buyer_obtain_point_fee,shipping_type,discount_fee,alipay_no,has_buyer_message,created,pay_time,end_time,modified,consign_time,status,total_fee,payment,point_fee,post_fee,receiver_address,receiver_city,receiver_district,receiver_mobile,receiver_name,receiver_state,receiver_phone,receiver_zip,seller_nick,trade_from,orders.oid,orders.refund_status,orders.num,orders.discount_fee,orders.num_iid,orders.title,orders.outer_iid,orders.outer_sku_id,orders.price,orders.total_fee,orders.sku_id,orders.sku_properties_name,orders.payment,orders.status,orders.seller_type,orders.pic_path,orders.order_from,oaid";
			$page_size = 30;
		}
		
		$total_page_no = ceil($total_results/$page_size);
		if($is_yes_print > 0)
		{
			echo "total_page_no = {$total_page_no}\r\n";
		}
		
		/* Get onsale items start */
		//total_page = 432
		$start_page_no = 1;
		//$start_page_no = 371;
		//$total_page_no = 428;		
		
		for($page_no=$start_page_no; $page_no<=$total_page_no; $page_no++)
		{
			//echo "page_no = {$page_no}\r\n";
/* 	 	seller_nick,buyer_nick,buyer_open_uid,title,type,created,sid,tid,seller_rate,buyer_rate,status,payment,discount_fee,adjust_fee,post_fee,total_fee,pay_time,end_time,modified,consign_time,buyer_obtain_point_fee,point_fee,real_point_fee,received_payment,commission_fee,pic_path,num_iid,num_iid,num,price,cod_fee,cod_status,shipping_type,receiver_name,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_mobile,receiver_phone,orders.title,orders.pic_path,orders.price,orders.num,orders.iid,orders.num_iid,orders.sku_id,orders.refund_status,orders.status,orders.oid,orders.total_fee,orders.payment,orders.discount_fee,orders.adjust_fee,orders.sku_properties_name,orders.item_meal_name,orders.buyer_rate,orders.seller_rate,orders.outer_iid,orders.outer_sku_id,orders.refund_id,orders.seller_type

tid,status,payment,discount_fee,adjust_fee,post_fee,total_fee,pay_time,end_time,modified,consign_time,orders.refund_status,orders.total_fee,orders.discount_fee
*/
			//$echoBrStr = 'no_need_json_arr_enter';
			$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
			$apiName = "taobao.trades.sold.get";
			$apiParams = array(
				"format" => "json",
				"fields" => $str_fields,
				"start_created" => $start_created,
				"end_created" => $end_created,
				"page_no" => $page_no,
				"page_size" => $page_size
			);
			if($is_tmall_i18n > 0)
			{
				$add_params = array("type" => "tmall_i18n");
				$apiParams = array_merge($apiParams, $add_params);
			}
			
			if($echoBrStr == 'no_need_json_arr_enter')
			{
				$apiReturnJsonTemp = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
				echo $apiName." for page {$page_no}=".$apiReturnJsonTemp."\n";
				//$apiReturnJsonTemp = str_replace("\/","/",$apiReturnJsonTemp);
				$apiReturnJsonTemp = func_json_decode($apiReturnJsonTemp); 
				$apiReturnJson['trades'] = $apiReturnJsonTemp['trades_sold_get_response']['trades'];
				unset($apiReturnJsonTemp);
				//print_r($apiReturnJson);	
				//exit;
				continue;
			}
			else
			{
				$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
			}
			
			if(is_array($apiReturnJson))
			{
				if($is_yes_print > 0)
				{
					echo $apiName." for page {$page_no}=";
					print_r($apiReturnJson);
				}
				if(count($apiReturnJson['trades']['trade']) > 0)
				{
					$loop_i = 1;
					foreach($apiReturnJson['trades']['trade'] AS $arr_get)
					{
						$tid = trim($arr_get['tid']);
						
						if(count($arr_only_this_oids) > 0)
						{
							if(!in_array($tid, $arr_only_this_oids))
							{
								continue;						
							}
						}
						
						if($tid)
						{
							$arr_get_tid[] = "'".$tid."'";
							$arr_order_info[$tid]['status'] = strtolower(trim($arr_get['status']));
							$arr_order_info[$tid]['trade_from'] = strtolower(@trim(preg_replace("/\s+/"," ",$arr_get['trade_from'])));
							$arr_order_info[$tid]['adjust_fee'] = @trim($arr_get['adjust_fee']);
							$is_minus_check_discount = 0;
							if($arr_order_info[$tid]['adjust_fee'] < 0.01)
							{
								$is_minus_check_discount = 1;
							}
							$arr_order_info[$tid]['payment'] = @trim($arr_get['payment']);
							$arr_order_info[$tid]['discount_fee'] = @trim($arr_get['discount_fee']);
							$arr_order_info[$tid]['total_fee'] = @trim($arr_get['total_fee']);
							$arr_order_info[$tid]['oaid'] = "";
							if($arr_get['oaid'])
							{
								$arr_order_info[$tid]['oaid'] = @trim($arr_get['oaid']);
							}
							//print_r($arr_get['orders']['order']);
							$refund_fee = 0;
							foreach($arr_get['orders']['order'] AS $arr_each_order)
							{
								if($is_minus_check_discount>0 && $arr_each_order['discount_fee']<0.01)
								{
									$arr_each_order['discount_fee'] = 0;
								}
								$arr_order_info[$tid]['each_item_discount_fee'] += $arr_each_order['discount_fee'];
								$refund_status = strtolower(@trim($arr_each_order['refund_status']));
								//echo "refund_status = ".$refund_status."\r\n";
								if($refund_status == 'success')
								{
									$refund_fee += $arr_each_order['total_fee']-$arr_each_order['discount_fee'];
								}
							}
							$arr_order_info[$tid]['refund_fee'] = $refund_fee;
							$arr_order_info[$tid]['total_discount_fee'] = $arr_order_info[$tid]['discount_fee']+$arr_order_info[$tid]['each_item_discount_fee'];
							/*
							$arr_order_info[$tid]['post_fee'] = trim($arr_get['post_fee']);							
							$arr_order_info[$tid]['pay_time'] = trim($arr_get['pay_time']);
							$arr_order_info[$tid]['end_time'] = trim($arr_get['end_time']);
							$arr_order_info[$tid]['modified'] = trim($arr_get['modified']);
							$arr_order_info[$tid]['consign_time'] = trim($arr_get['consign_time']);
							*/
							if($is_new_order_check_json > 0)
							{
								$each_item_discount_fee = 0;
								foreach($arr_get AS $get_key=>$get_value)
								{
									if($get_key == 'orders')
									{
										$loop_idx = 0;
										foreach($get_value['order'] AS $arr_order_value)
										{
											//$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['trade_sub_order_id'] = date('YmdHis')."_".$loop_i.$loop_idx;
											foreach($arr_order_value AS $loop_order_key=>$loop_order_value)
											{
												if($loop_order_key=='sku_id' || $loop_order_key=='sku_properties_name')
												{
													continue;
												}
												
												$temp_order_key = "orders.".$loop_order_key;
												if($arr_use_json_change_key[$temp_order_key])
												{
													$loop_order_key = $arr_use_json_change_key[$temp_order_key];
												}
												if(in_array($loop_order_key, $arr_use_cross_100_key))
												{
													$loop_order_value = $loop_order_value*100;
												}
												if($loop_order_key == 'sub_order_status')
												{
													$loop_order_value = strtolower($loop_order_value);
												}
												if($loop_order_key == 'order_from')
												{
													$loop_order_value = strtolower(@trim(preg_replace("/\s+/"," ",$loop_order_value)));
												}
												if($loop_order_key == 'item_discount_fee')
												{
													$each_item_discount_fee += $loop_order_value;
												}
												$loop_order_value = str_ireplace("'","`",$loop_order_value);
												$loop_order_value = str_ireplace("&","＆",$loop_order_value);
												$loop_order_value = str_ireplace("+","＋",$loop_order_value);
												$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx][$loop_order_key] = $loop_order_value;
											}
											$arr_order_value['sku_properties_name'] = str_ireplace("'","`",$arr_order_value['sku_properties_name']);
											$arr_order_value['sku_properties_name'] = str_ireplace("&","＆",$arr_order_value['sku_properties_name']);
											$arr_order_value['sku_properties_name'] = str_ireplace("+","＋",$arr_order_value['sku_properties_name']);
											$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['item_sku'] = $arr_order_value['sku_id']."|".$arr_order_value['sku_properties_name'];
											//$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['order_from'] = 'TAOBAO';
											$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['order_promotions'] = array();
											$arr_use_json_str[$tid]['Order']['sub_orders'][$loop_idx]['order_tags'] = array();
											$loop_idx++;
										}
									}
									else
									{	
										$get_value = str_ireplace("'","`",$get_value);
										$get_value = str_ireplace("&","＆",$get_value);
										$get_value = str_ireplace("+","＋",$get_value);
										
										if($is_yes_print > 0)
										{
											echo $get_key."=".$get_value."\r\n";
										}
										
										if($arr_use_json_change_key[$get_key])
										{
											$get_key = $arr_use_json_change_key[$get_key];
										}
										if(in_array($get_key, $arr_use_cross_100_key))
										{
											$get_value = $get_value*100;
										}
										if($get_key == 'order_status')
										{
											$get_value = strtolower($get_value);
										}
										if($get_key == 'trade_from')
										{
											$get_value = strtolower(@trim(preg_replace("/\s+/"," ",$get_value)));
										}
										$arr_use_json_str[$tid]['Order'][$get_key] = $get_value;
									}
								}
								$arr_use_json_str[$tid]['Order']['buyer_name'] = '';
								$arr_use_json_str[$tid]['Order']['seller_rate_status'] = 'false';
								$arr_use_json_str[$tid]['Order']['buyer_id'] = $arr_get['buyer_nick'];
								$arr_use_json_str[$tid]['Order']['buyer_open_uid'] = $arr_get['buyer_open_uid'];
								$arr_use_json_str[$tid]['Order']['buyer_rate_status'] = 'false';
								$arr_use_json_str[$tid]['Order']['order_promotions'] = array();
								$arr_use_json_str[$tid]['Order']['order_relation_bills'] = array();
								$arr_use_json_str[$tid]['Order']['order_tags'] = array();
								$arr_use_json_str[$tid]['Order']['pay_type'] = 'other';
								$arr_use_json_str[$tid]['Order']['receiver_district_code'] = '';
								$arr_use_json_str[$tid]['Order']['seller_id'] = '1706222708';
								$arr_use_json_str[$tid]['Order']['seller_type'] = 'B';
								$arr_use_json_str[$tid]['Order']['shop_id'] = '0';
								$arr_use_json_str[$tid]['Order']['total_discount_fee'] = $arr_use_json_str[$tid]['Order']['discount_fee']+$each_item_discount_fee;
							}
						}
						else
						{
							$err_str = "tid not exist";
							$arr_err_info[] =  "Get order - page_no={$page_no} - ".$apiName." : ".$err_str;
						}
						$loop_i++;
					}
				}
				else
				{
					$err_key =implode(", ",array_keys($apiReturnJson));
					$err_str = $err_key." - ".implode(", ",$apiReturnJson);
					$arr_err_info[] =  "Get order - page_no={$page_no} - ".$apiName." : ".$err_str;
				}
			}
			else
			{
				$arr_err_info[] = "Get order - page_no={$page_no} - ".$apiName." : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
			}
			unset($apiClass);
			unset($apiParams);
			unset($apiReturnJson);
			
			if($page_no > 18)
			{
				//break;
			}
			if($is_new_order_check_json > 0)
			{
				//sleep(2);
			}
			else
			{
				//usleep(500000);//wait for 0.5 seconds
			}
			sleep($api_sleep_sec);
		}
		/* Get onsale items end */
	}
	else
	{
		$err = "Error - {$execution_file} - total_results zero err.";
		$subject = "[BUYFINE-Tmall] {$err} - ".date("Y-m-d H");
		echo $subject."\r\n";
		//fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
		if($is_proc_check > 0)
		{
			$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
			dbQuery("UPDATE {$tmall_db}._proc_uid SET is_proc=1 WHERE uid={$execution_proc_id}",$dbconn);
			dbClose($dbconn);
		}
		exit;
	}
}

//print_r($arr_use_json_str);
if($is_yes_print > 0)
{
	echo "arr_order_info = \r\n";
	print_r($arr_order_info);
	echo "arr_use_json_str = \r\n";
	print_r($arr_use_json_str);
}
//if($is_proc_check < 1)
if($is_new_order_check_json < 1)
{
	exit;
}

$t_get_num = count($arr_get_tid);
$arr_check_info = array();
$arr_discount_check = array();
$arr_price_check = array();
$arr_contiune_status = array('wait_buyer_pay');
$arr_status_check_pa_uid = array();
$arr_status_re_check_pa_uid = array();
if($t_get_num > 0)
{
	$arr_chunk_tid = array_chunk($arr_get_tid, 100);
	foreach($arr_chunk_tid AS $arr_tid)
	{
		$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
		$in_tid = implode(",",$arr_tid);
		$query = "
			SELECT
				TP.trade_main_order_id, TP.discount_fee, TP.total_discount_fee, TP.post_fee,
				P.pa_uid, P.pa_status, P.isAvailable, P.tNd_price, P.discount_price, P.is_status_check
			FROM
				{$tmall_db}.tmall_payment TP, {$payment_db}.payment_v2 P
			WHERE TP.pa_uid=P.pa_uid
			AND TP.trade_main_order_id IN ({$in_tid})
		";
		if($is_yes_print > 0)
		{
			echo $query."\r\n";
		}
		$result = dbQuery($query,$dbconn);
		while($row=mysql_fetch_assoc($result))
		{
			$tid = trim($row['trade_main_order_id']);
			$status = $arr_order_info[$tid]['status'];
			//echo $status."\r\n";
			if(in_array($status, $arr_contiune_status))
			{
				unset($arr_order_info[$tid]);
				if($arr_use_json_str[$tid])
				{
					unset($arr_use_json_str[$tid]);
				}
				continue;
			}
			
			$tmall_status = $arr_bf_order_status_code[$status];			
			$bf_status = $row['pa_status'];
			$tmall_price = $arr_order_info[$tid]['payment'];
			$tmall_price = str_replace(",","",$tmall_price);
			if($arr_order_info[$tid]['refund_fee'] > 0)
			{
				$tmall_price = $tmall_price-$arr_order_info[$tid]['refund_fee'];
			}
			if($ARR_TID_STATIC_TMALL_PRICE[$tid])
			{
				$tmall_price = $ARR_TID_STATIC_TMALL_PRICE[$tid];
			}
			
			$bf_price = $row['tNd_price'];
			if($arr_order_info[$tid]['total_discount_fee'] > 0)
			{
				$bf_price = $bf_price-$arr_order_info[$tid]['total_discount_fee'];
			}
			/*
if($arr_order_info[$tid]['post_fee'] > 0)
			{
				$bf_price = $bf_price+$arr_order_info[$tid]['post_fee'];
			}
			else if($row['post_fee'] > 0)
			{
				$bf_price = $bf_price+$row['post_fee'];
			}
*/
			if($ARR_TID_STATIC_BF_PRICE[$tid])
			{
				$bf_price = $ARR_TID_STATIC_BF_PRICE[$tid];
			}
			
			$compare_tmall_price = @number_format($tmall_price,2);
			$compare_bf_price = @number_format($bf_price,2);
			$is_loop_status_check = 0;
			if($compare_tmall_price != $compare_bf_price)
			{
				if($bf_status != 12)
				{
					$arr_price_check[] = "{$tid} - {$row['pa_uid']} - Not same price - Tmall={$compare_tmall_price} (status={$arr_order_info[$tid]['status']}), BF={$compare_bf_price} (status={$bf_status})";
					if($row['is_status_check'] < 1)
					{
						$arr_status_check_pa_uid[] = $row['pa_uid'];
						$is_loop_status_check = 1;
					}
				}
			}
			
			if($tmall_status==7 && $tmall_price<1)
			{
				$tmall_status = 12;
			}
			if($tmall_status>1 && $tmall_status<12)
			{
				if($bf_status>1 && $bf_status<8)
				{
				}
				else
				{
					$arr_check_info[] = "{$tid} - {$row['pa_uid']} - Not same status - Tmall={$tmall_status} ({$status}), BF={$bf_status}";
					if($row['is_status_check'] < 1)
					{
						$arr_status_check_pa_uid[] = $row['pa_uid'];
						$is_loop_status_check = 1;
					}
				}
			}
			else
			{
				if($tmall_status != $bf_status)
				{
					$arr_check_info[] = "{$tid} - {$row['pa_uid']} - Not same status - Tmall={$tmall_status} ({$status}), BF={$bf_status}";
					if($row['is_status_check'] < 1)
					{
						$arr_status_check_pa_uid[] = $row['pa_uid'];
						$is_loop_status_check = 1;
					}
				}
			}
			if($row['isAvailable'] < 1)
			{
				$arr_check_info[] = "{$tid} - {$row['pa_uid']} - Not isAvailable - Tmall={$tmall_status} ({$status}), BF={$bf_status}";
			}
			//$tmall_discount = $arr_order_info[$tid]['discount_fee']+$arr_order_info[$tid]['each_item_discount_fee'];
			$tmall_discount = $arr_order_info[$tid]['total_discount_fee'];
			$tmall_discount = str_replace(",","",$tmall_discount);
			if($tmall_discount>0 && $bf_status!=12)
			{
				//if($tmall_discount != $row['discount_fee'])
				//if($tmall_discount != $row['total_discount_fee'])
				$compare_tmall_discount = number_format($tmall_discount,2);
				$compare_bf_discount = number_format($row['discount_price'],2);
				if($compare_tmall_discount != $compare_bf_discount)
				{
					$arr_discount_check[] = "{$tid} - {$row['pa_uid']} - check discount_fee - Tmall status={$arr_order_info[$tid]['status']}, BF status={$bf_status}, total_fee={$arr_order_info[$tid]['total_fee']},  discount={$compare_tmall_discount} (BF={$compare_bf_discount}), payment={$arr_order_info[$tid]['payment']} (BF={$row['tNd_price']})";
				}
			}
			
			if($row['is_status_check']>0 && $is_loop_status_check<1)
			{
				$arr_status_re_check_pa_uid[] = $row['pa_uid'];
			}
			
			unset($arr_order_info[$tid]);
			if($arr_use_json_str[$tid])
			{
				unset($arr_use_json_str[$tid]);
			}
		}
		dbClose($dbconn);
		sleep(1);
	}	
	unset($arr_chunk_tid);
	unset($arr_get_tid);
}

if(count($arr_status_check_pa_uid) > 0)
{
	$dbconn = dbSelect($payment_db,dbConn($payment_host));
	$arr_status_check_pa_uid = array_unique($arr_status_check_pa_uid);
	$query = "UPDATE {$payment_db}.payment_v2 SET is_status_check=1 WHERE pa_uid IN (".implode(",",$arr_status_check_pa_uid).")";
	dbQuery($query,$dbconn);
	dbClose($dbconn);
	unset($arr_status_check_pa_uid);
	sleep(1);
}

if(count($arr_status_re_check_pa_uid) > 0)
{
	$dbconn = dbSelect($payment_db,dbConn($payment_host));
	$arr_status_re_check_pa_uid = array_unique($arr_status_re_check_pa_uid);
	$query = "UPDATE {$payment_db}.payment_v2 SET is_status_check=0 WHERE pa_uid IN (".implode(",",$arr_status_re_check_pa_uid).")";
	dbQuery($query,$dbconn);
	dbClose($dbconn);
	unset($arr_status_re_check_pa_uid);
	sleep(1);
}

$t_err_num = count($arr_err_info);
if($t_err_num > 0)
{
	$err = implode("<br />",$arr_err_info);	
	$subject = "[!!!BUYFINE-Tmall] Err - {$execution_file} - ".date("Y-m-d H:i:s");
	if($IS_ACTIVE_SOCK_EMAIL > 0)//$IS_ACTIVE_SOCK_EMAIL assign COMM_FUNC.inc
	{
		fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
	}
	unset($arr_err_info);
	unset($err);
}

$t_discount_num = count($arr_discount_check);
if($t_discount_num > 0)
{
	echo "arr_discount_check=";
	print_r($arr_discount_check);
	$err = implode("<br />",$arr_discount_check);	
	$subject = "[!!!BUYFINE-Tmall] check discount_fee - {$execution_file} - ".date("Y-m-d H:i:s");
	if($IS_ACTIVE_SOCK_EMAIL > 0)//$IS_ACTIVE_SOCK_EMAIL assign COMM_FUNC.inc
	{
		fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
	}
	unset($arr_discount_check);
	unset($err);
}

$t_price_num = count($arr_price_check);
if($t_price_num > 0)
{
	echo "arr_price_check=";
	print_r($arr_price_check);
	$err = implode("<br />",$arr_price_check);	
	$subject = "[!!!BUYFINE-Tmall] Not same price - {$execution_file} - ".date("Y-m-d H:i:s");
	if($IS_ACTIVE_SOCK_EMAIL > 0)//$IS_ACTIVE_SOCK_EMAIL assign COMM_FUNC.inc
	{
		fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
	}
	unset($arr_price_check);
	unset($err);
}

$new_order_count = 0;
$arr_new_order_err = array();
if(count($arr_order_info) > 0)
{
	$arr_contiune_status = array('wait_buyer_pay','trade_closed_by_taobao','trade_no_create_pay','trade_closed');
	$arr_skip_tid = array('376631568282427');//buyfine으로 주문정보가 안넘어오고 취소된경우
	$max_sock_timeout = 60;
	foreach($arr_order_info AS $tid=>$arr_value)
	{
		if(in_array($arr_value['status'], $arr_contiune_status))
		{
			continue;
		}
		else if($arr_tmall_db_refund_tid[$tid])//이 값은 디비에 존재함. 테이블 = tmall_payment_refund_tid
		{
			continue;
		}
		else if($arr_tmall_db_refund_skip_tid[$tid])//이 값은 디비에 존재함. 테이블 = tmall_payment_refund_skip_tid
		{
			continue;
		}
		/* $arr_tmall_db_refund_tid 대체함
		else if(in_array($tid, $ARR_TMALL_REFUND_GOODS_TID))
		{
			continue;
		}
		*/
		$tmall_status = $arr_bf_order_status_code[$arr_value['status']];
		if(in_array($tid, $arr_skip_tid))
		{
			if($tmall_status == 12)
			{
				continue;
			}	
		}
		
		if(!$arr_use_json_str[$tid])
		{
			$arr_check_info[] = "{$tid} - Check status - status={$tmall_status} ({$arr_value['status']}), payment={$arr_value['payment']}, discount_fee={$arr_value['discount_fee']}";
		}
		
		/* New order start */
		if($arr_use_json_str[$tid])
		{
			/* buyer_message API start */
			if($arr_use_json_str[$tid]['Order']['has_buyer_message'] == '1')
			{
				$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
				$apiName = "taobao.trade.get";
				$apiParams = array(
					"format" => "json",
					"fields" => "tid,buyer_message",
					"tid" => $tid
				);
				$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
				if(is_array($apiReturnJson))
				{
					if($is_yes_print > 0)
					{
						echo $apiName." - buyer_message =";
						print_r($apiReturnJson);
					}
					if($apiReturnJson['trade']['tid'] && $apiReturnJson['trade']['buyer_message'])
					{
						$apiReturnJson['trade']['buyer_message'] = str_ireplace("'","`",$apiReturnJson['trade']['buyer_message']);
						$apiReturnJson['trade']['buyer_message'] = str_ireplace("&","＆",$apiReturnJson['trade']['buyer_message']);
						$apiReturnJson['trade']['buyer_message'] = str_ireplace("+","＋",$apiReturnJson['trade']['buyer_message']);
						
						$arr_use_json_str[$tid]['Order']['buyer_message'] = $apiReturnJson['trade']['buyer_message'];
					}
				}
				unset($apiClass);
				unset($apiParams);
				unset($apiReturnJson);
				sleep($api_sleep_sec);
			}
			/* buyer_message API end */
			
			/* oaid decrypt API start */
			if($arr_use_json_str[$tid]['Order']['oaid'])
			{
				$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
				$apiName = "taobao.top.oaid.decrypt";//복호화 제한 에러가 발생하면 店铺管理 > 隐私保护 > 提额 여기가서 처리하면 됨
				$arr_decrypt_oaid_var = array(
					"oaid"=>$arr_use_json_str[$tid]['Order']['oaid'],
					"tid" => $tid,
					"scene" => "1005"
				);
				$apiParams = array(
					"format" => "json",
					"query_list"=>json_encode($arr_decrypt_oaid_var)
				);
				$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
				if(is_array($apiReturnJson))
				{
					if($is_yes_print > 0)
					{
						echo $apiName." - oaid decrypt=";
						print_r($apiReturnJson);
					}
					if($apiReturnJson['receiver_list']['receiver']['0']['tid'] && $apiReturnJson['receiver_list']['receiver']['0']['address_detail'] && $apiReturnJson['receiver_list']['receiver']['0']['name'])
					{
						/* receiver_address start */
						$is_match_value = 1;
						$arr_temp_value = explode("*", $arr_use_json_str[$tid]['Order']['receiver_address']);
						foreach($arr_temp_value AS $temp_value)
						{
							$temp_value =  @trim($temp_value);
							if(!$temp_value) continue;
							$temp_value = func_preg_match_replace_str($temp_value);
							if(!preg_match("/{$temp_value}/i", $apiReturnJson['receiver_list']['receiver']['0']['address_detail']))
							{
								$is_match_value = 0;
								break;
							}
						}
						unset($arr_temp_value);
						if($is_match_value > 0)
						{
							$arr_use_json_str[$tid]['Order']['receiver_address'] = $apiReturnJson['receiver_list']['receiver']['0']['address_detail'];
						}
						else
						{
							$arr_err_wx_msg[] = $apiName." {$tid} - address match err";
						}
						/* receiver_address end */
						/* receiver_name start */
						$is_match_value = 1;
						$arr_temp_value = explode("*", $arr_use_json_str[$tid]['Order']['receiver_name']);
						foreach($arr_temp_value AS $temp_value)
						{
							$temp_value =  @trim($temp_value);
							if(!$temp_value) continue;
							$temp_value = func_preg_match_replace_str($temp_value);
							if(!preg_match("/{$temp_value}/i", $apiReturnJson['receiver_list']['receiver']['0']['name']))
							{
								$is_match_value = 0;
								break;
							}
						}
						unset($arr_temp_value);
						if($is_match_value > 0)
						{
							$arr_use_json_str[$tid]['Order']['receiver_name'] = $apiReturnJson['receiver_list']['receiver']['0']['name'];
						}
						else
						{
							$arr_err_wx_msg[] = $apiName." {$tid} - name match err";
						}
						/* receiver_name end */
						/* receiver_mobile start */
						if($apiReturnJson['receiver_list']['receiver']['0']['mobile'])
						{
							$is_match_value = 1;
							$arr_temp_value = explode("*", $arr_use_json_str[$tid]['Order']['receiver_mobile']);
							foreach($arr_temp_value AS $temp_value)
							{
								$temp_value =  @trim($temp_value);
								if(!$temp_value) continue;
								$temp_value = func_preg_match_replace_str($temp_value);
								if(!preg_match("/{$temp_value}/i", $apiReturnJson['receiver_list']['receiver']['0']['mobile']))
								{
									$is_match_value = 0;
									break;
								}
							}
							if($is_match_value > 0)
							{
								$arr_use_json_str[$tid]['Order']['receiver_mobile'] = $apiReturnJson['receiver_list']['receiver']['0']['mobile'];
							}
							else
							{
								$arr_err_wx_msg[] = $apiName." {$tid} - mobile match err";
							}
						}
						/* receiver_mobile end */
						if($apiReturnJson['receiver_list']['receiver']['0']['city'])
						{
							$arr_use_json_str[$tid]['Order']['receiver_city'] = $apiReturnJson['receiver_list']['receiver']['0']['city'];
						}
						if($apiReturnJson['receiver_list']['receiver']['0']['district'])
						{
							$arr_use_json_str[$tid]['Order']['receiver_district'] = $apiReturnJson['receiver_list']['receiver']['0']['district'];
						}
						if($apiReturnJson['receiver_list']['receiver']['0']['state'])
						{
							$arr_use_json_str[$tid]['Order']['receiver_province'] = $apiReturnJson['receiver_list']['receiver']['0']['state'];
						}
					}
				}
				unset($apiClass);
				unset($apiParams);
				unset($apiReturnJson);
				sleep($api_sleep_sec);
			}
			/* oaid decrypt API end */
			
			$json_class = new Services_JSON(SERVICES_JSON_LOOSE_TYPE);
			$json_str = $json_class->encode($arr_use_json_str[$tid]);
			//echo $json_str."\r\n\r\n";
			unset($json_class);
			
			$arr_new_order_post = array(
				'topic'=>'tmall.oc.api.order.push',
				'sign_method'=>$tmall_signMethod,
				'timestamp'=>date("Y-m-d H:i:s"),
				'input_charset'=>"utf-8",
				'app_key'=>$tmall_order_app_secret,
				'content'=>trim($json_str),
				'alex_print'=>0
			);
			ksort($arr_new_order_post);
			$new_order_tmp = $tmall_order_app_secret;
			$arr_new_order_para = array();
			foreach($arr_new_order_post as $new_order_k=>$new_order_v)
			{
			    $new_order_tmp .= $new_order_k.$new_order_v;
			    $arr_new_order_para[] = $new_order_k."=".$new_order_v;
			}
			
			$new_order_tmp .= $tmall_order_app_secret;
			if($is_yes_print > 0)
			{
				echo "new_order_tmp = {$new_order_tmp}\r\n";
			}
			
			$arr_new_order_post['sign'] = strtoupper(md5($new_order_tmp));
			$arr_new_order_para[] = "sign=".$arr_new_order_post['sign'];
			unset($arr_new_order_post);
			
			$new_order_post_data = implode("&", $arr_new_order_para);			
			//echo $new_order_post_data."\r\n";
			$arr_new_order_loc_uri = parse_url($tmall_order_push_api_uri);
			$new_order_host = $arr_new_order_loc_uri['host'];
			$new_order_path = $arr_new_order_loc_uri['path'];
			$new_order_result_str = "";
			$new_order_fp = fsockopen($new_order_host, 80, $new_order_errno, $new_order_errstr, $max_sock_timeout);
			if($new_order_fp) 
			{
				$new_order_req = 'POST '.$new_order_path.' HTTP/1.1'.$crlf;
				$new_order_req .= 'Host: '.$new_order_host.$crlf;
				$new_order_req .= 'User-Agent: '.$user_agent.$crlf;
				$new_order_req .= 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8'.$crlf; 
				$new_order_req .= 'Content-Length: '.strlen($new_order_post_data).$crlf;
				$new_order_req .= 'Connection: close'.$crlf.$crlf;//Connection: close를 안해주면 접근 서버의 최대실행 시간까지 기다렸다가 오는것 같다.
				$new_order_req .= $new_order_post_data; 
				
				if($is_yes_print > 0)
				{
					echo "new_order_req = {$new_order_req}\r\n";
				}
				
				fwrite($new_order_fp, $new_order_req);
				stream_set_timeout($new_order_fp, $max_sock_timeout);
    			$arr_stream_info = stream_get_meta_data($new_order_fp);
    			if($arr_stream_info['timed_out'])
    			{
    				$arr_new_order_err[] = "arr_stream_info timed_out err {$tid} - ".$json_str;
    			}
    			else
    			{
				    $start_sock_stream_time = time();
				    $is_sock_timeout = 0;
					while (!feof($new_order_fp)) 
					{
						$temp_result_str = fgets($new_order_fp, 4096);
						$new_order_result_str .= $temp_result_str;
						
						$diff_sock_stream_time = time() - $start_sock_stream_time; 
						if($diff_sock_stream_time > $max_sock_timeout)
						{
							$is_sock_timeout = 1;
							break;
						}
					}
					if($is_sock_timeout > 0)
					{
						$arr_new_order_err[] = "loop parsing timeout err {$tid} - ".$json_str;
					}
					else
					{
						$new_order_result_json = "";
						$new_order_headerend = "";
						if($new_order_result_str)
						{
							$new_order_headerend = strpos($new_order_result_str,"\r\n\r\n");
							if (is_bool($new_order_headerend)) {
								$new_order_result_json = $new_order_result_str;
							} 
							else {
								$new_order_result_json = substr($new_order_result_str,$new_order_headerend+4,strlen($new_order_result_str) - ($new_order_headerend+4));
							}
							$new_order_result_json = trim($new_order_result_json);
							//echo $new_order_result_json."\r\n\r\n\r\n";
							$arr_new_order_json = func_json_decode($new_order_result_json);
							//print_r($arr_new_order_json);
							if(count($arr_new_order_json['order_receive_response']) > 0)
							{
								$new_order_count++;
							}
							else
							{
								$arr_new_order_err[] = "Result err {$tid} - ".$new_order_result_json;
							}
						}
						unset($new_order_result_str);
						unset($new_order_result_json);
						unset($new_order_headerend);
					}
				}
				fclose($new_order_fp);
			}
			else
			{
				$arr_new_order_err[] = "open err - {$tid} ".$json_str;
			}
		}
		/* New order end */
	}
	unset($arr_order_info);
	if(count($arr_use_json_str) > 0)
	{
		unset($arr_use_json_str);
	}
}

$t_new_order_err_num = count($arr_new_order_err);
if($t_new_order_err_num > 0)
{
	echo "arr_new_order_err=";
	print_r($arr_new_order_err);
	$err = implode("\r\n\r\n", $arr_new_order_err);	
	$subject = "[!!!BUYFINE-Tmall] New Order Err - {$execution_file} - ".date("Y-m-d H:i:s");
	if($IS_ACTIVE_SOCK_EMAIL > 0)//$IS_ACTIVE_SOCK_EMAIL assign COMM_FUNC.inc
	{
		fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,'text/plain');
	}
	unset($arr_new_order_err);
	unset($err);
}

$t_check_num = count($arr_check_info);
if($t_check_num > 0)
{
	echo "arr_check_info=";
	print_r($arr_check_info);
	if($is_last_3_month>0 || $is_last_7_day>0)
	{
		$err = implode("<br />",$arr_check_info);	
		$subject = "[!!!BUYFINE-Tmall] Check status - {$execution_file} - ".date("Y-m-d H:i:s");
		if($IS_ACTIVE_SOCK_EMAIL > 0)//$IS_ACTIVE_SOCK_EMAIL assign COMM_FUNC.inc
		{
			fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
		}
		unset($err);
	}
	unset($arr_check_info);
}

if($is_proc_check > 0)
{
	$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
	dbQuery("UPDATE {$tmall_db}._proc_uid SET is_proc=1 WHERE uid={$execution_proc_id}",$dbconn);
	dbClose($dbconn);
}

$check_msg_time = date("H");//00 through 23
$arr_not_msg_time = array('00','01','02','03','04','05','06','07');
if(count($arr_err_wx_msg)>0 && !in_array($check_msg_time, $arr_not_msg_time))
{
	foreach($arr_bf_admin_wx_msg_openId AS $bf_admin_id=>$wx_openId)
	{
		$wx_msg_str = implode("\n", $arr_err_wx_msg);
		$arr_wx_vars = array(
			'wx_openId'=>$wx_openId,
			'msg_str'=>$wx_msg_str,
			'msg_type'=>'text',
			'is_need_date_msg'=>1,
			'isPDO'=>0,
			'dbconn'=>'',
			'is_yes_print'=>$is_yes_print
		);
		$arr_wx_msg = func_wx_sent_msg($arr_wx_vars);//To use this function, "wechat/config.inc, wechat/func_wechat_core.inc" must be included.
		unset($arr_wx_vars);
		if($is_yes_print > 0)
		{
			echo "arr_wx_msg = ";
			print_r($arr_wx_msg);
		}
		unset($arr_wx_msg);
	}
	unset($arr_err_wx_msg);
}

$end_time = time(); 
$run_time = $end_time - $start_time;
if($is_new_order_check_json > 0)
{
	echo $execution_file." : ".date("Y-m-d H:i:s")." -> RunTime={$run_time}, total_results={$total_results}, total_tid={$t_get_num}, NewOrder={$new_order_count}, NewOrderErr={$t_new_order_err_num}, discount={$t_discount_num}, price={$t_price_num}, check={$t_check_num}, Err={$t_err_num} End\r\n";
}
else
{
	echo $execution_file." : ".date("Y-m-d H:i:s")." -> RunTime={$run_time}, total_results={$total_results}, total_tid={$t_get_num}, discount={$t_discount_num}, price={$t_price_num}, check={$t_check_num}, Err={$t_err_num} End\r\n";
}
?>
<?
//exit;
set_time_limit(0);
mb_internal_encoding("UTF-8");
if(!$INCLUDE_COMM) include "PUBLIC_FUNC/ADMIN_V2/COMM_FUNC.inc";
if(!$IS_FUNC_CORE) include "PUBLIC_FUNC/ADMIN_V2/func_core.inc";
if(!$IS_FUNC_EXTRA) include "PUBLIC_FUNC/ADMIN_V2/func_extra.inc";
if(!$IS_FUNC_SOURCE_SITE_IMG) include "PUBLIC_FUNC/ADMIN_V2/func_source_site_img.inc";
if(!$IS_JSON_CLASS) include "PUBLIC_FUNC/ADMIN_V2/func_json_class.inc";
include "PUBLIC_FUNC/ADMIN_V2/func_image_v3.inc";
if(!$IS_TMALL_CONFIG) include "PUBLIC_FUNC/ADMIN_V2/tmall/config.inc.php";
if(!$IS_TMALL_SCHEMA_CONFIG) include "PUBLIC_FUNC/ADMIN_V2/tmall/schema_config.inc";
if(!$IS_FUNC_TMALL_CORE) include "PUBLIC_FUNC/ADMIN_V2/tmall/func_tmall_core.inc";
include 'PUBLIC_FUNC/ADMIN_V2/tmall/jushita/JushitaTaobaoClient.php';
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/field/Field.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/field/OptionsField.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/enums/FieldType.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/util/StringUtil.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/exception/TopSchemaException.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/enums/TopSchemaErrorCode.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/field/InputField.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/field/SingleCheckField.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/field/MultiCheckField.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/field/ComplexField.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/value/ComplexValue.php";
include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/field/MultiComplexField.php";
//include "PUBLIC_FUNC/ADMIN_V2/tmall/top/schema/factory/SchemaWriter.php";
include "/home/html/BUYFINE/admin.buyfine.net/translate/title_use_c_value.inc"; // 상품명에 사용될 카테고리별 중문명
if(!$IS_ARR_EN_CA) include "/home/html/BUYFINE/www_v3.buyfine.net/files/etc/arr_category_en_navi.inc";

use Top\schema\field\InputField;
use Top\schema\field\SingleCheckField;
use Top\schema\field\MultiCheckField;
use Top\schema\field\ComplexField;
use Top\schema\value\ComplexValue;
use Top\schema\field\MultiComplexField;
//use Top\schema\factory\SchemaWriter;

$start_time = time();

$execution_file = "02_item_update_schema";
$execution_proc_id = 9;

if(!$_SERVER['HOSTNAME'])
{
	exec("hostname",$arr_out_comm_func_hostname,$return_comm_func_num);
	$_SERVER['HOSTNAME'] = strtolower(trim($arr_out_comm_func_hostname['0']));
	unset($arr_out_comm_func_hostname);
	unset($return_comm_func_num);
}
$is_work_server = 0;
if($_SERVER['HOSTNAME']=='ecs_web2.buyfine.net')
{
	$is_work_server = 1;
}

//$echoPrint = 1;
//$echoBrStr = "\r\n";

/* 
$IS_TMALL_PM_TIME = 1 일경우 테스트 하고 싶으면   update->only_admin_update, updateNimg->only_admin_updateNimg 이렇게 수정해서 처리하면 됨.
/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/02_item_update.html update db_all &  //tmall_item_updated_g_uid>is_check=0
/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/02_item_update.html update 7209101 &  //특정 상품 수정시 사용 
/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/02_item_update.html updateNimg 5939050 &  //특정 상품 이미지및정보 수정시 사용 
/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/02_item_update.html increment_update 7209101 description,vertical_image &  //특정 상품 특정 필드 수정

$key
	1 = update or API
	2 = g_uid or db_all…
	3 = 
		ASC OR DESC - !!!꼭 대문자로 할것
		or
		$is_increment_updatea = 1 이면  description,vertical_image 이값을 배열로처리해주고 해당 필드만 수정 처리한다. !!!중요 , 구분자로 선언한 필드값은 꼭!!! schema_item_field.inc에서 선언한값과 똑같이 할것.
*/

$is_server_del_img = 1;
$max_err_num = 44;
$is_yes_print = 0;
$is_and_g_uid = 0;
$in_g_uid = "";
$and_approve_status = "";
$and_is_color_changed = "";
$db_all_orderby_str = "";
$db_all_asc_orderby_str = "";
$is_db_all_update = 0;
$is_absolted_img_changed = 0;
$is_join_query = 0;
$join_tb_name = "";
$is_proc_reupdate = 0;
$is_proc_re_white_bg_img = 0;
$is_increment_updatea = 0;
$arr_increment_fields = array();
foreach($argv AS $key=>$value)
{
	if(!$value) continue;
	if($key =='0') 
	{
		continue;
	}
	else if($key == 1)
	{
		$value = trim($value);
		if($value == 'update')
		{
		}
		else if($value == 'proc_reupdate')//한번만 더 체크하기 위함임.
		{
			$is_proc_reupdate = 1;
		}
		else if($value == 'only_admin_update')
		{
			if($IS_TMALL_PM_TIME > 0)
			{
				$IS_TMALL_PM_TIME = 0;
			}
		}
		else if($value == 'updateNimg')
		{
			$is_absolted_img_changed = 1;
		}
		else if($value == 're_white_img')
		{
			//$is_absolted_img_changed = 1;
			$is_proc_re_white_bg_img = 1;
		}
		else if($value == 'increment_update')
		{
			$is_absolted_img_changed = 1;
			$is_increment_updatea = 1;
		}
		else if($value == 'only_admin_updateNimg')
		{
			$is_absolted_img_changed = 1;
			if($IS_TMALL_PM_TIME > 0)
			{
				$IS_TMALL_PM_TIME = 0;
			}
		}
		else
		{
		
		}
	}
	else if($key == 2)
	{
		$value = trim($value);
		$in_g_uid = $value;
		if($in_g_uid=='instock')
		{
			$and_approve_status = "AND TI.approve_status='{$in_g_uid}'";
			$execution_file = $execution_file."-".$in_g_uid;
			$execution_proc_id = 12;
		}
		else if($in_g_uid=='onsale')
		{
			$and_approve_status = "AND TI.approve_status='{$in_g_uid}'";
			$execution_file = $execution_file."-".$in_g_uid;
			$execution_proc_id = 13;
		}
		else if($in_g_uid=='color_change')
		{
			$and_is_color_changed = "AND GUG.is_color_changed=1";
			$execution_file = $execution_file."-".$in_g_uid;
			$execution_proc_id = 14;
		}
		else if($in_g_uid=='db_all')
		{
			$execution_file = $execution_file."-".$in_g_uid;
			$is_db_all_update = 1;
			$execution_proc_id = 9;
			$is_join_query = 1;
			$join_tb_name = "{$tmall_db}.tmall_item_update_temp_desc";
		}
		else
		{
			$is_yes_print = 1;
			$is_and_g_uid = 1;
		}
	}
	else if($key == 3)
	{
		$value = trim($value);
		if($value)
		{
			if($is_increment_updatea > 0)
			{
				$arr_increment_fields = explode(",",$value);
			}
			else
			{
				$db_all_orderby_str = $value;
				$execution_file = $execution_file."-".$db_all_orderby_str;
				if($db_all_orderby_str == 'ASC')
				{
					$db_all_asc_orderby_str = $db_all_orderby_str;
					$db_all_orderby_str = "";
					$execution_proc_id = 15;
					$is_join_query = 1;
					$join_tb_name = "{$tmall_db}.tmall_item_update_temp_asc";
				}
			}
		}
	}
}

if($is_yes_print > 0)
{
	$echoPrint = 1;
	$echoBrStr = "\r\n";
}

$dbconn = dbSelect($tmall_db,dbConn($tmall_host));

$is_proc_check = 0;
if($in_g_uid=='db_all' || $in_g_uid=='instock' || $in_g_uid=='onsale' || $in_g_uid=='color_change')
{
	$max_err_num = $max_err_num*16;
	
	if($IS_TMALL_PM_TIME < 1)//$IS_TMALL_PM_TIME assign config.inc.php
	{
		$is_proc_check = 1;
		$result = mysql_query("SELECT is_proc, continue_stop_num FROM {$tmall_db}._proc_uid WHERE uid={$execution_proc_id}",$dbconn);
		$row = mysql_fetch_assoc($result);
		if($row['is_proc'] > 1)
		{
			dbQuery("UPDATE {$tmall_db}._proc_uid SET continue_stop_num=continue_stop_num+1 WHERE uid={$execution_proc_id}",$dbconn);
			dbClose($dbconn);
			
			if($row['continue_stop_num'] > 99)//9분마다 한번씩 실행 되기 때문에 2시간 연속 계속 실행되고 있으면 확인해 볼것.
			{
				$err = "Error - {$execution_file} - Already excution - continue_stop_num={$row['continue_stop_num']}";
				$subject = "[BUYFINE-Tmall] {$err} - ".date("Y-m-d H");
				echo $subject."\r\n";
				fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
			}
			exit;
		}
		else
		{
			dbQuery("UPDATE {$tmall_db}._proc_uid SET is_proc=2, continue_stop_num=0 WHERE uid={$execution_proc_id}",$dbconn);
		}
	}
}

$and_temp_activ_b_code = "";
if(count($ARR_TMALL_TEMP_ACTIVE_B_CODE) > 0)
{
	if($is_and_g_uid < 1)
	{
		$and_temp_activ_b_code = "AND G.b_code IN (".implode(",",$ARR_TMALL_TEMP_ACTIVE_B_CODE).")";
	}
}

$is_max_img_continue_check = 0;
$max_img_update_uid = 78;
$max_img_continue_update_num = 6;
$db_all_limit_max_num = 1686; // 이 값을 크게 잡으면 쿼리 실행시 IN () $db_all_limit_max_num 만큼 실행 되기 때문에 너무 크게잡으면 쿼리부하가 있으므로 삼가하길 바람 (MAX = 300)
$default_orderby_str = "DESC";
if($db_all_orderby_str)
{
	$default_orderby_str = $db_all_orderby_str;
}
else if($db_all_asc_orderby_str)
{
	$default_orderby_str = $db_all_asc_orderby_str;
}

$order_by_str = "ORDER BY TI.g_uid {$default_orderby_str}";
$limit_str = "LIMIT 0,{$db_all_limit_max_num}";

$join_tb = "";
$arr_db_all_g_uid = array();
$arr_insert_g_uid = array();
$arr_img_changed_g_uid = array();
$and_max_err_count = 4;
if($in_g_uid=='db_all' || $in_g_uid=='color_change')
{
	//$IS_TMALL_USE_DONE_NUM assign config.inc.php
	
	if(count($ARR_TMALL_TEMP_ACTIVE_B_CODE) > 0)
	{
		$query = "
			SELECT
				GUG.g_uid, GUG.is_color_changed
			FROM
				{$tmall_db}.tmall_item_updated_g_uid GUG, {$tmall_db}.tmall_item TI, {$goods_db}.goods G
			WHERE GUG.g_uid=TI.g_uid 
			AND GUG.g_uid=G.g_uid 
			AND GUG.is_check=0
			AND GUG.err_count<{$and_max_err_count}
			{$and_is_color_changed}
			{$and_temp_activ_b_code}
			AND TI.api_result_num=7
			AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
			AND TI.is_del_img=0
			ORDER BY GUG.update_time {$default_orderby_str}
			{$limit_str}
		";
	}
	else
	{
		$query = "
			SELECT
				GUG.g_uid, GUG.is_color_changed
			FROM
				{$tmall_db}.tmall_item_updated_g_uid GUG, {$tmall_db}.tmall_item TI
			WHERE GUG.g_uid=TI.g_uid 
			AND GUG.is_check=0
			AND GUG.err_count<{$and_max_err_count}
			{$and_is_color_changed}
			AND TI.api_result_num=7
			AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
			AND TI.is_del_img=0
			ORDER BY GUG.update_time {$default_orderby_str}
			{$limit_str}
		";
	}
	if($is_yes_print > 0)
	{
		echo $query."\r\n";
	}
	
	//아래 쿼리는 특정 조건으로 먼저 업데이트 하고 싶은경우
	/* 
$query = "
		SELECT
			GUG.g_uid, GUG.is_color_changed
		FROM
			{$tmall_db}.tmall_item_updated_g_uid GUG, {$tmall_db}.tmall_item TI, {$goods_db}.goods G
		WHERE GUG.g_uid=TI.g_uid 
		AND GUG.g_uid=G.g_uid 
		AND G.b_code=3
		{$and_is_color_changed}
		AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
		ORDER BY GUG.update_time {$default_orderby_str}
		{$limit_str}
	";
*/
	//echo $query."\r\n";
	$result = dbQuery($query,$dbconn);
	while($row=mysql_fetch_assoc($result))
	{
		$arr_db_all_g_uid[] = $row['g_uid'];
		$arr_insert_g_uid[] = "(".$row['g_uid'].")";
		if($row['is_color_changed'] > 0)
		{
			$arr_img_changed_g_uid[] = $row['g_uid'];
		}
	}
	$db_all_count = count($arr_db_all_g_uid);
	
	$is_batch_add = 0;
	$is_batch_add = 1;
	//$is_batch_add = 0;
	
	if($is_yes_print > 0)
	{
		echo "db_all_count={$db_all_count}, default_orderby_str={$default_orderby_str}, is_batch_add={$is_batch_add} \r\n";
	}
	
	if($db_all_count<1 && count($ARR_TMALL_TEMP_ACTIVE_B_CODE)>0)
	{
		$db_all_count = 1;
	}
	
	if($db_all_count > 0)
	{
		if($is_batch_add > 0)
		{
			if($db_all_count < $db_all_limit_max_num)//무조건 $db_all_limit_max_num개씩 수정 정보를 보내기 위함.
			{
				if($db_all_count>0 && count($arr_db_all_g_uid)>0)
				{
					$sort_in_g_uid = implode(",",$arr_db_all_g_uid);
					$order_by_str = "
						ORDER BY
						(
							CASE WHEN TI.g_uid IN ({$sort_in_g_uid})
							THEN 1
							ELSE 0
							END
						) DESC, TI.g_uid DESC
					";
				}
				//COUNT(GUG.g_uid)
				if(count($ARR_TMALL_TEMP_ACTIVE_B_CODE) > 0)
				{
					$query = "
						SELECT 
							COUNT(*) AS batch_count 
						FROM 
							{$tmall_db}.tmall_item_updated_g_uid GUG, {$tmall_db}.tmall_item TI, {$goods_db}.goods G
						WHERE GUG.g_uid=TI.g_uid
						AND GUG.g_uid=G.g_uid
						AND GUG.is_batch_check=0
						AND GUG.err_count<{$and_max_err_count}
						{$and_is_color_changed}
						{$and_temp_activ_b_code}
						AND TI.api_result_num=7
						AND TI.is_del_img=0
						AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
					";
				}
				else
				{
					$query = "
						SELECT 
							COUNT(*) AS batch_count 
						FROM 
							{$tmall_db}.tmall_item_updated_g_uid GUG, {$tmall_db}.tmall_item TI
						WHERE GUG.g_uid=TI.g_uid
						AND GUG.is_batch_check=0
						AND GUG.err_count<{$and_max_err_count}
						{$and_is_color_changed}
						AND TI.api_result_num=7
						AND TI.is_del_img=0
						AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
					";
				}
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				$result = dbQuery($query,$dbconn);
				$row = mysql_fetch_assoc($result);
				//if($row['batch_count'] < 1)
				if($row['batch_count'] < $db_all_limit_max_num)
				{
					if(count($ARR_TMALL_TEMP_ACTIVE_B_CODE) > 0)
					{
						$query = "
							UPDATE 
								{$tmall_db}.tmall_item_updated_g_uid GUG, {$goods_db}.goods G 
							SET GUG.is_batch_check=0
							WHERE GUG.g_uid=G.g_uid
							{$and_temp_activ_b_code}
						";
					}
					else
					{
						$query = "UPDATE {$tmall_db}.tmall_item_updated_g_uid GUG SET GUG.is_batch_check=0";
					}
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
				}
				
				$and_not_in_g_uid = "";
				if($db_all_count>0 && count($arr_db_all_g_uid)>0)
				{
					$not_in_g_uid = implode(",",$arr_db_all_g_uid);
					$and_not_in_g_uid = "AND GUG.g_uid NOT IN ({$not_in_g_uid})";
				}
				//echo $not_in_g_uid."\r\n";
				$re_limit_num = $db_all_limit_max_num-$db_all_count;
				$re_limit_str = "LIMIT 0,{$re_limit_num}";
				if(count($ARR_TMALL_TEMP_ACTIVE_B_CODE) > 0)
				{
					$query = "
						SELECT
							GUG.g_uid, GUG.is_color_changed
						FROM
							{$tmall_db}.tmall_item_updated_g_uid GUG, {$tmall_db}.tmall_item TI, {$goods_db}.goods G
						WHERE GUG.g_uid=TI.g_uid
						AND GUG.g_uid=G.g_uid
						AND GUG.is_batch_check=0
						AND GUG.err_count<{$and_max_err_count}
						{$and_is_color_changed}
						{$and_temp_activ_b_code}
						AND TI.api_result_num=7
						AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
						AND TI.is_del_img=0
						{$and_not_in_g_uid}
						ORDER BY GUG.update_time {$default_orderby_str}
						{$re_limit_str}
					";
				}
				else
				{
					$query = "
						SELECT
							GUG.g_uid, GUG.is_color_changed
						FROM
							{$tmall_db}.tmall_item_updated_g_uid GUG, {$tmall_db}.tmall_item TI
						WHERE GUG.g_uid=TI.g_uid
						AND GUG.is_batch_check=0
						AND GUG.err_count<{$and_max_err_count}
						{$and_is_color_changed}
						AND TI.api_result_num=7
						AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
						AND TI.is_del_img=0
						{$and_not_in_g_uid}
						ORDER BY GUG.update_time {$default_orderby_str}
						{$re_limit_str}
					";
				}
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				$result = dbQuery($query,$dbconn);
				while($row=mysql_fetch_assoc($result))
				{
					$arr_db_all_g_uid[] = $row['g_uid'];
					$arr_insert_g_uid[] = "(".$row['g_uid'].")";
					if($row['is_color_changed'] > 0)
					{
						$arr_img_changed_g_uid[] = $row['g_uid'];
					}
				}
			}
		}
		
		$query = "TRUNCATE TABLE {$join_tb_name}";
		//echo $query."\r\n";
		dbQuery($query, $dbconn);
		$arr_chunk_insert_g_uid = array_chunk($arr_insert_g_uid, 500);
		foreach($arr_chunk_insert_g_uid AS $arr_update_g_uid)
		{
			$insert_g_uid = implode(",",$arr_update_g_uid);
			$query = "INSERT INTO {$join_tb_name} (g_uid) VALUES {$insert_g_uid}";
			//echo $query."\r\n";
			dbQuery($query, $dbconn);
		}
		unset($arr_chunk_insert_g_uid);
		unset($arr_insert_g_uid);
		
		$in_g_uid = implode(",",$arr_db_all_g_uid);
	}
	else
	{
		if($is_proc_check > 0)
		{
			dbQuery("UPDATE {$tmall_db}._proc_uid SET is_proc=1 WHERE uid={$execution_proc_id}",$dbconn);
			dbClose($dbconn);
		}
		echo "db_all = no product. \r\n";
		exit;
	}
}
else
{
	if($in_g_uid)
	{
		$is_numeric = is_numeric($in_g_uid);
		if($is_numeric)
		{
			$query = "
				SELECT
					GUG.g_uid, GUG.is_color_changed
				FROM
					{$tmall_db}.tmall_item_updated_g_uid GUG
				WHERE GUG.g_uid={$in_g_uid}
			";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			$result = dbQuery($query,$dbconn);
			$row = mysql_fetch_assoc($result);
			if($row['is_color_changed'] > 0)
			{
				$arr_img_changed_g_uid[] = $row['g_uid'];
			}
		}
	}	
}

$AND_STR = "";
if($is_join_query < 1)
{
	$in_g_uid = trim($in_g_uid);
	if($in_g_uid)
	{
		$AND_STR = "AND TI.g_uid IN ({$in_g_uid})";
	}
	if(!$AND_STR)
	{
		if($is_proc_check > 0)
		{
			dbQuery("UPDATE {$tmall_db}._proc_uid SET is_proc=1 WHERE uid={$execution_proc_id}",$dbconn);
			dbClose($dbconn);
		}
		echo "db_all = no product-2. \r\n";
		exit;
	}
}

$arr_price_basic_info = func_get_price_basic_info($dbconn, '');
$margin_rate = $arr_price_basic_info['margin_rate'];
$exchange_rate = $arr_price_basic_info['exchange_rate'];
$exchange_rate_krw_cny = $arr_price_basic_info['exchange_rate_krw_cny'];
$exchange_rate_eur = $arr_price_basic_info['exchange_rate_eur'];
$exchange_rate_gbp = $arr_price_basic_info['exchange_rate_gbp'];
unset($arr_price_basic_info);

/* Get sessionkey Key start  */
$arr_proc_uid_info = func_get_tmall_proc_uid(1, 0, 1, 0, $dbconn); //$uid=1, $sleep_num=0, $is_already_dbconn=0, $connIsPDO=0, $dbconn="" | func_get_tmall_proc_uid assign func_tmall_core.inc
$tmall_sessionkey = $arr_proc_uid_info['sessionkey'];
//echo $tmall_sessionkey;exit;
/* Get sessionkey Key end  */

$arr_tmall_ca = array();
$query = "SELECT c_value, cid, c_name FROM {$tmall_db}.tmall_goods_category";
$result = dbQuery($query, $dbconn);
while($row=mysql_fetch_assoc($result))
{
	$arr_tmall_ca[$row['cid']]['c_value'] = $row['c_value'];
	$arr_tmall_ca[$row['cid']]['c_name'] = $row['c_name'];
}

$arr_inactive_c_code = array();
$query = "SELECT c_code FROM {$tmall_db}.{$TMALL_CATEGORY_MATCH_TB} WHERE is_active<2";
$result = dbQuery($query, $dbconn);
while($row=mysql_fetch_assoc($result))
{
	$arr_inactive_c_code[] = $row['c_code'];
}

$arr_inactive_b_code = array();
$query = "SELECT b_code FROM {$tmall_db}.tmall_goods_brand_schema WHERE is_active<1";
$result = dbQuery($query, $dbconn);
while($row=mysql_fetch_assoc($result))
{
	$arr_inactive_b_code[] = $row['b_code'];
}

if($is_join_query > 0)
{
	$query = "
		SELECT
			TI.num_iid, TI.only_tmall_uid, TI.product_id, TI.outer_id, TI.price, TI.last_paid_max_price, TI.approve_status, TI.cid AS was_cid, TI.is_schema, TI.list_time AS sku_markettime,
			G.g_uid, G.view_g_uid, G.isAvailable, G.img_cache_num, G.img_host, G.site_code, G.sl_uid, G.c_value, G.g_cost, G.g_cost_h, G.tax_percent, G.tax_percent_h, G.shipping_fee, G.shipping_fee_h, G.normal_sale_rate, G.g_title AS real_g_title, G.tmall_img_uri, G.color_ct, G.is_fixed_price, G.fixed_price_info,
			GI.g_title_cn, GI.color_img_list, GI.still_img_list, GI.is_translate, GI.is_tmall,
			GIH.g_info, GIH.g_info_cn,
			GB.b_code, GB.b_name, GB.b_name_cn, GB.margin_rate,
			SI.url AS site_name, SI.is_auto_stock, SI.stock_update_data_type,
			TGCM.parent_cid, TGCM.cid, TGCM.scid, TGCM.c_code, TGCM.is_prop, TGCM.gender_prop
		FROM
			{$join_tb_name} TIUT, {$tmall_db}.tmall_item TI, {$goods_db}.goods G, {$goods_db}.goods_info GI, {$goods_db}.goods_info_html GIH, {$goods_db}.goods_brand GB, {$goods_db}.site_info SI, {$tmall_db}.{$TMALL_CATEGORY_MATCH_TB} TGCM{$tb_api_result}
		WHERE TIUT.g_uid=TI.g_uid
		AND TIUT.g_uid=G.g_uid
		AND TIUT.g_uid=GI.g_uid
		AND TIUT.g_uid=GIH.g_uid
		AND G.b_code=GB.b_code
		AND G.site_code=SI.site_code
		AND TGCM.c_code=G.c_code
		{$and_temp_activ_b_code}
		AND TI.api_result_num=7
		AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
		{$and_approve_status}
		{$order_by_str}
	";
}
else
{
	$query = "
		SELECT
			TI.num_iid, TI.only_tmall_uid, TI.product_id, TI.outer_id, TI.last_paid_max_price, TI.price, TI.approve_status, TI.cid AS was_cid, TI.is_schema, TI.list_time AS sku_markettime,
			G.g_uid, G.view_g_uid, G.isAvailable, G.img_cache_num, G.img_host, G.site_code, G.sl_uid, G.c_value, G.g_cost, G.g_cost_h, G.tax_percent, G.tax_percent_h, G.shipping_fee, G.shipping_fee_h, G.normal_sale_rate, G.g_title AS real_g_title, G.tmall_img_uri, G.color_ct, G.is_fixed_price, G.fixed_price_info,
			GI.g_title_cn, GI.color_img_list, GI.still_img_list, GI.is_translate, GI.is_tmall,
			GIH.g_info, GIH.g_info_cn,
			GB.b_code, GB.b_name, GB.b_name_cn, GB.margin_rate,
			SI.url AS site_name, SI.is_auto_stock, SI.stock_update_data_type,
			TGCM.parent_cid, TGCM.cid, TGCM.scid, TGCM.c_code, TGCM.is_prop, TGCM.gender_prop
		FROM
			{$tmall_db}.tmall_item TI, {$goods_db}.goods G, {$goods_db}.goods_info GI, {$goods_db}.goods_info_html GIH, {$goods_db}.goods_brand GB, {$goods_db}.site_info SI, {$tmall_db}.{$TMALL_CATEGORY_MATCH_TB} TGCM{$tb_api_result}
		WHERE TI.g_uid=G.g_uid
		AND TI.g_uid=GI.g_uid
		AND TI.g_uid=GIH.g_uid
		AND G.b_code=GB.b_code
		AND G.site_code=SI.site_code
		AND TGCM.c_code=G.c_code
		{$and_temp_activ_b_code}
		AND TI.api_result_num=7
		AND TI.is_tmall_use>{$IS_TMALL_USE_DONE_NUM}
		{$AND_STR}
		{$and_approve_status}
		{$order_by_str}
	";
}
if($is_yes_print > 0)
{
	echo $query."\r\n";
}
//exit;
$result = dbQuery($query,$dbconn);
dbClose($dbconn);
/*  
	update loop start  
	가격, 상품명, 상품설명, props, property_alias, input_pids, input_str, seller_cids - taobao.item.update
	활성화/비활성화 - taobao.item.update.listing / taobao.item.update.delisting
	칼라/사이즈 - taobao.item.sku.add / taobao.item.sku.delete 
*/
$is_root_auto_bg_copy = 0;
$max_err_str = "";
$init_stock_num = 3;
$t_run_num = 0;
$t_re_stock_num = 0;
$check_err_num = 0;
$check_soldout_num = 0;
$arr_colorNsize_change_item = array();
$arr_err_info = array();
$arr_err_cid = array();
$arr_check_info = array();
$arr_update_info_g_uid = array();
$arr_onsale_num_iid = array();
$arr_instock_num_iid = array();
$arr_success_query_err = array();
$arr_check_bad_size = array();
$arr_notfound_g_uid = array();
$arr_sku_notfound_g_uid = array();
$arr_err_null_img_bf_view_g_uid = array();
$arr_err_null_img_usbf_view_g_uid = array();
$arr_err_null_img_cosmos_prodinc = array();
$arr_re_updateNimg_g_uid = array();
while($row=mysql_fetch_assoc($result))
{
	if($IS_TMALL_PM_TIME > 0)//$IS_TMALL_PM_TIME assign config.inc.php
	{
		echo date("Y-m-d H:i:s")."= Not working - PM TIME at Now\r\n";
		break;
	}
	
	$t_run_num++;
	if($check_err_num > $max_err_num)
	{
		$max_err_str = "MAX err MaxNum={$max_err_num}";
		break;
	}
	
	if($check_soldout_num > $max_err_num)
	{
		$max_err_str = "MAX continue soldout MaxNum={$max_err_num}";
		break;
	}
	
	$is_static_cid = 0;
	if(count($ARR_G_UID_TMALL_STATIC_CID[$row['g_uid']]) > 0)//$ARR_G_UID_TMALL_STATIC_CID assign config.inc.php
	{
		$is_static_cid = 1;
		$row['cid'] = $ARR_G_UID_TMALL_STATIC_CID[$row['g_uid']]['cid'];
		$row['parent_cid'] = $ARR_G_UID_TMALL_STATIC_CID[$row['g_uid']]['parent_cid'];
	}
	else if(count($ARR_B_CODE_TMALL_STATIC_CID[$row['b_code']]) > 0)//$ARR_B_CODE_TMALL_STATIC_CID assign config.inc.php
	{
		$is_static_cid = 1;
		$row['cid'] = $ARR_B_CODE_TMALL_STATIC_CID[$row['b_code']]['cid'];
		$row['parent_cid'] = $ARR_B_CODE_TMALL_STATIC_CID[$row['b_code']]['parent_cid'];
	}
	if(count($ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO[$row['b_code']][$row['g_uid']]) > 0)//$ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO assign config.inc.php
	{
		$row['parent_cid'] = $ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO[$row['b_code']][$row['g_uid']]['parent_cid'];
		$row['cid'] = $ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO[$row['b_code']][$row['g_uid']]['cid'];
		$row['c_code'] = $ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO[$row['b_code']][$row['g_uid']]['c_code'];
		$row['c_value'] = $ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO[$row['b_code']][$row['g_uid']]['c_value'];
		$row['is_prop'] = $ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO[$row['b_code']][$row['g_uid']]['is_prop'];
		$row['gender_prop'] = $ARR_REPLACE_TMALL_CID_B_CODE_G_UID_BASE_INFO[$row['b_code']][$row['g_uid']]['gender_prop'];
	}
	else if(count($ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO[$row['b_code']][$row['c_code']]) > 0)//$ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO assign config.inc.php
	{
		$row['parent_cid'] = $ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO[$row['b_code']][$row['c_code']]['parent_cid'];
		$row['cid'] = $ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO[$row['b_code']][$row['c_code']]['cid'];
		$row['c_code'] = $ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO[$row['b_code']][$row['c_code']]['c_code'];
		$row['c_value'] = $ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO[$row['b_code']][$row['c_code']]['c_value'];
		$row['is_prop'] = $ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO[$row['b_code']][$row['c_code']]['is_prop'];
		$row['gender_prop'] = $ARR_REPLACE_TMALL_CID_B_CODE_C_CODE_BASE_INFO[$row['b_code']][$row['c_code']]['gender_prop'];
	}
	
	$arr_tmall_skip_vars = array(
		'parent_cid'=>$row['parent_cid'],
		'cid'=>$row['cid']
	);
	$arr_tmall_skip_result = func_tmall_img_skip_OR_no_isAvailable($arr_tmall_skip_vars);
	unset($arr_tmall_skip_vars);
	if($arr_tmall_skip_result['is_skip'] > 0)
	{
		unset($arr_tmall_skip_result);
		continue;
	}
	/* func_tmall_img_skip_OR_no_isAvailable 대체
if(count($ARR_TMALL_CONTINUE_PARENT_CID) > 0)
	{
		if(in_array($row['parent_cid'], $ARR_TMALL_CONTINUE_PARENT_CID))
		{
			continue;
		}
	}
	if(count($ARR_TMALL_CONTINUE_CID) > 0)
	{
		if(in_array($row['cid'], $ARR_TMALL_CONTINUE_CID))
		{
			continue;
		}
	}
*/
	
	
	$is_schema_update_success = 0;
	$db_is_schema = $row['is_schema'];
	$db_sku_markettime = "";
	$static_sku_markettime = "";
	$tmall_created_date = "";
	$tmall_created_term_day = 0;
	if($db_is_schema > 1)
	{
		$arr_sku_markettime = explode(" ", $row['sku_markettime']);
		if($arr_sku_markettime['0'] != '0000-00-00')
		{
			$db_sku_markettime = $arr_sku_markettime['0'];
		}
	}
	$num_iid = $row['num_iid'];
	$product_id = $row['product_id'];
	$outer_id = $row['outer_id'];
	$g_uid = $row['g_uid'];
	$view_g_uid = $row['view_g_uid'];
	$was_cid = $row['was_cid'];	
	$cid = $row['cid'];	
	$scid = $row['scid'];
	$c_code = $row['c_code'];
	$bf_c_value = $row['c_value'];
	$b_code_t = $row['b_code'];
	$b_codeNc_value = $row['b_code']."^".$row['c_value'];
	$arr_ca_name = func_ca_view($bf_c_value);
	$ca_name_str = implode(">",$arr_ca_name);
	$db_price = $row['price'];
	$arr_c_value = explode("_", $row['c_value']);
	$parent_c1 = $arr_c_value['0'];
	$bf_ca2_str = $arr_c_value['0']."_".$arr_c_value['1']; 
	$db_tmall_img_uri = $row['tmall_img_uri'];
	$only_tmall_uid = $row['only_tmall_uid'];
	$is_wget_re_proc = 0;
	if(in_array($row['site_code'], $ARR_BF_SOURCE_SITE_CODE))
	{
		if($is_work_server > 0)
		{
			$is_wget_re_proc = 1;
		}
	}
	$now_tmall_desc = "";
	$now_bf_desc = "";
	
	$color_prop_id = "";
	if($arr_color_prop_id_cid[$cid])
	{
		$color_prop_id = $arr_color_prop_id_cid[$cid];
	}
	
	$size_prop_id = "";
	$get_size_prop_id_idx = $cid;
	if(in_array($cid, $arr_gender_size_prop_id_cid))
	{
		$get_size_prop_id_idx = $cid."_".$c_code;
	}
	
	if($row['only_tmall_uid'] > $schema_change_us_size_tmall_uid)
	{
		if($arr_us_size_prop_id_cid[$get_size_prop_id_idx])
		{
			$size_prop_id = $arr_us_size_prop_id_cid[$get_size_prop_id_idx];
		}
	}
	else
	{
		if($arr_size_prop_id_cid[$get_size_prop_id_idx])
		{
			$size_prop_id = $arr_size_prop_id_cid[$get_size_prop_id_idx];
		}
	}
	
	if(count($arr_tmall_update_skip_g_uid) > 0)
	{
		if(in_array($g_uid, $arr_tmall_update_skip_g_uid))
		{
			if($is_increment_updatea>0 && $is_tmall_watermark_proc>0 && count($arr_event_watermark_img_g_uid)>0)//$is_tmall_watermark_proc, $arr_event_watermark_img_g_uid assign config.inc.php
			{
			}
			else
			{
				if($is_yes_print > 0)
				{
					echo "arr_tmall_update_skip_g_uid = Skip\r\n";
				}
				continue;
			}
		}
	}
	if(in_array($row['site_code'], $arr_tmall_update_skip_site_code))
	{
		if($is_yes_print > 0)
		{
			echo "arr_tmall_update_skip_site_code = Skip\r\n";
		}
		continue;
	}
	if(in_array($row['b_code'], $arr_tmall_update_skip_b_code))
	{
		if($is_yes_print > 0)
		{
			echo "arr_tmall_update_skip_b_code = Skip\r\n";
		}
		continue;
	}
	
	if($ARR_TMALL_STATIC_STOCK[$g_uid])
	{
		$loop_init_stock_num = $ARR_TMALL_STATIC_STOCK[$g_uid];
	}
	else
	{
		$loop_init_stock_num = $init_stock_num;
	}
	
	$is_no_delete_goods = 0;
	$is_no_soldout_goods = 0;
	if(count($ARR_TMALL_NO_SOLDOUT_G_UID) > 0)
	{
		if(in_array($g_uid, $ARR_TMALL_NO_SOLDOUT_G_UID))
		{
			$row['isAvailable'] = 2;
			$is_no_delete_goods = 1;
		}
	}
	if(count($ARR_TMALL_NO_SOLDOUT_B_CODE) > 0)
	{
		if(in_array($b_code_t, $ARR_TMALL_NO_SOLDOUT_B_CODE))
		{
			$row['isAvailable'] = 2;
			$is_no_delete_goods = 1;
			$is_no_soldout_goods = 1;
		}
	}
	
	$is_wget_re_right_now_success = 0;
	$is_loop_delistNdel = 0;
	$is_loop_delisting = 0;
	$is_loop_img_change = 0;
	$is_loop_img_max_update = 0;
	$is_max_img_change_continue_update = 0;
	$is_max_white_bg_change_continue_update = 0;
	if($row['isAvailable'] == 2)
	{
		if($is_absolted_img_changed > 0)
		{
			$is_loop_img_change = 1;
		}
		else if(in_array($g_uid, $arr_img_changed_g_uid))
		{
			$is_loop_img_change = 1;
		}
	}
	else
	{
		$is_loop_delisting  = 1;
	}
	if($is_yes_print > 0)
	{
		echo "is_loop_img_change-1 = {$is_loop_img_change}\r\n";
	}
	
	if($is_loop_delisting < 1)
	{	
		$arr_brand_vars = array(
			'b_code'=>$b_code_t,
			'b_name'=>$row['b_name'],
			'b_name_cn'=>$row['b_name_cn'],
			'cid'=>$cid
		);
		$arr_brand_name = func_tmall_replace_brand_name($arr_brand_vars);
		if($is_yes_print > 0)
		{
			echo "arr_brand_name = ";
			print_r($arr_brand_name);
		}
		$b_name = $arr_brand_name['b_name'];
		$title_b_name = $arr_brand_name['title_b_name'];
		$search_en_b_name = $arr_brand_name['search_en_b_name'];
		$search_no_urlencode = $arr_brand_name['search_no_urlencode'];
		
		$app_short_title = "";
		if($arr_short_title_max_len_cid[$cid])
		{
			if($ARR_TMALL_APP_ETC_TITLE[$bf_c_value])
			{
				$app_short_title = $ARR_TMALL_APP_ETC_TITLE[$bf_c_value];
			}
			else if($ARR_TMALL_APP_CA_2_TITLE[$bf_ca2_str])
			{
				$app_short_title = $ARR_TMALL_APP_CA_2_TITLE[$bf_ca2_str];
			}	
		}
		$app_short_b_name = "";
		if($app_short_title)
		{
			if($ARR_TMALL_APP_B_CODE_TITLE[$b_code_t])
			{
				$app_short_b_name = $ARR_TMALL_APP_B_CODE_TITLE[$b_code_t];
			}
			else if($row['b_name_cn'])
			{
				$app_short_b_name = $row['b_name_cn'];
			}
			else
			{
				$app_short_b_name = $b_name;
			}
			$app_short_b_name = str_ireplace(" + ","+",$app_short_b_name);
			$app_short_b_name = str_ireplace(" ＆ ","＆",$app_short_b_name);
			
			$app_short_bname_max_len = $arr_short_title_max_len_cid[$cid]-3;
			$app_short_bname_mb_len = mb_strlen($app_short_b_name, 'UTF-8');
			if($app_short_bname_mb_len > $app_short_bname_max_len)
			{
				$app_short_b_name = mb_substr($app_short_b_name, 0, $app_short_bname_max_len, 'UTF-8'); 
			}
			
			$app_short_title = $app_short_b_name." ".$app_short_title;
		}
		
		$err_default_str = "num_iid={$num_iid}, c_code={$c_code}, c_value={$bf_c_value}, c_name={$ca_name_str}, b_code={$b_code_t}, b_name={$b_name}";
	
		if(!$row['g_title_cn'])
		{
			if($arr_tmall_title_use_b_codeNc_value[$b_codeNc_value])
			{
				$row['g_title_cn'] = $arr_tmall_title_use_b_codeNc_value[$b_codeNc_value]; // $arr_tmall_title_use_b_codeNc_value assign  tmall/config.inc.php
			}
			else if($arr_tmall_title_use_c_value[$row['c_value']])
			{
				$row['g_title_cn'] = $arr_tmall_title_use_c_value[$row['c_value']]; // $arr_tmall_title_use_c_value assign  tmall/config.inc.php
			}
			else
			{
				$row['g_title_cn'] = $arr_translate_title_use_c_value[$row['c_value']]; // $arr_translate_title_use_c_value assign  admin.buyfine.net/translate/title_use_c_value.inc
			}
			
			if($arr_tmall_add_title_use_b_code[$b_code_t])// $arr_tmall_add_title_use_b_code assign  tmall/config.inc.php
			{
				$row['g_title_cn'] = $arr_tmall_add_title_use_b_code[$b_code_t]." ".$row['g_title_cn'];
			}
		}
		else
		{
			if($arr_tmall_title_use_b_codeNc_value[$b_codeNc_value])
			{
				if(preg_match("/女式/i", $row['g_title_cn']))
				{
					$row['g_title_cn'] = $arr_tmall_title_use_b_codeNc_value[$b_codeNc_value]; // $arr_tmall_title_use_b_codeNc_value assign  tmall/config.inc.php
				}
				else if(preg_match("/男式/i", $row['g_title_cn']))
				{
					$row['g_title_cn'] = $arr_tmall_title_use_b_codeNc_value[$b_codeNc_value]; // $arr_tmall_title_use_b_codeNc_value assign  tmall/config.inc.php
				}
			}
			else if($arr_tmall_title_use_c_value[$row['c_value']])
			{
				if(preg_match("/女式/i", $row['g_title_cn']))
				{
					$row['g_title_cn'] = $arr_tmall_title_use_c_value[$row['c_value']]; // $arr_tmall_title_use_c_value assign  tmall/config.inc.php
				}
				else if(preg_match("/男式/i", $row['g_title_cn']))
				{
					$row['g_title_cn'] = $arr_tmall_title_use_c_value[$row['c_value']]; // $arr_tmall_title_use_c_value assign  tmall/config.inc.php
				}
			}
			
			if($arr_tmall_add_title_use_b_code[$b_code_t])// $arr_tmall_add_title_use_b_code assign  tmall/config.inc.php
			{
				$row['g_title_cn'] = $arr_tmall_add_title_use_b_code[$b_code_t]." ".$row['g_title_cn'];
			}
		}
		
		$total_now_img_upload_count = 0;
		$total_new_img_upload_count = 0;
		
		$now_tmall_no_s_title = "";
		$now_tmall_approve_status = "";
		$now_tmall_input_pids = "";
		$now_tmall_input_str = "";
		$now_tmall_price_str = "";
		$now_tmall_price_num = 0;
		$arr_api_return_value = array();
		$is_need_get_img_info = 1;
		include "/home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/api_item_get.inc";//Required var = $num_iid, $g_uid, $cid  |  Return var = $arr_api_return_value, $arr_err_info
		if($is_yes_print > 0)
		{
			echo "is_item_get_already_del = {$is_item_get_already_del}\r\n";
		}
		if($is_item_get_already_del > 0)//$is_item_get_already_del assign api_item_get.inc
		{
			$arr_notfound_g_uid[] = $g_uid;
			continue;
		}
		if($IS_NEED_COMPARE_DESC > 0)
		{
			$now_tmall_desc = $arr_api_return_value[$g_uid]['desc'];
		}
		if($arr_api_return_value[$g_uid]['created'])
		{
			$arr_created_date = explode(" ",$arr_api_return_value[$g_uid]['created']);
			if(count($arr_created_date) > 1)
			{
				if($arr_created_date['0'] && $arr_created_date['0']!='0000-00-00')
				{
					$arr_date_term = func_dateNhour_term($arr_api_return_value[$g_uid]['created'], date("Y-m-d H:i:s"));
					if($arr_date_term['date'])
					{
						$tmall_created_term_day = $arr_date_term['date'];
					}
					if($is_yes_print > 0)
					{
						echo "created arr_date_term=";
						print_r($arr_date_term);
					}
					$arr_created_date = explode("-",$arr_created_date['0']);
					if(count($arr_created_date) > 2)
					{
						$tmall_created_date = $arr_created_date['0']."-".$arr_created_date['1']."-01";
					}
				}
			}
		}
		$total_now_img_upload_count = count($arr_api_return_value[$g_uid]['arr_item_img']);
		if($is_loop_img_change<1 && $total_now_img_upload_count>1)
		{
			if(preg_match("/T24ImoXq8XXXXXXXXX-1706222708.jpg/i", $arr_api_return_value[$g_uid]['arr_item_img']['1']['url']))
			{
				$is_loop_img_change = 1;
			}
			else if(preg_match("/T2XFStXEhXXXXXXXXX-1706222708.jpg/i", $arr_api_return_value[$g_uid]['arr_item_img']['1']['url']))
			{
				$is_loop_img_change = 1;
			}
			else if(preg_match("/T2TbXBXyXaXXXXXXXX-1706222708.jpg/i", $arr_api_return_value[$g_uid]['arr_item_img']['1']['url']))
			{
				$is_loop_img_change = 1;
			}
			else if(preg_match("/T2t9dEXvXaXXXXXXXX-1706222708.jpg/i", $arr_api_return_value[$g_uid]['arr_item_img']['1']['url']))
			{
				$is_loop_img_change = 1;
			}
		}
		if($is_yes_print > 0)
		{
			echo "is_loop_img_change-2 = {$is_loop_img_change}\r\n";
		}
	/* 	 
	Get arr_prop_img Array
	(
	    [0] => Array
	        (
	            [id] => 20989295258
	            [position] => 1
	            [properties] => 1627207:28320
	            [url] => http://img.alicdn.com/bao/uploaded/i1/1706222708/TB2kRA5cXXXXXbDXXXXXXXXXXXX_!!1706222708.jpg
	        )
	
	)
	*/
		$total_get_color_img_count = count($arr_api_return_value[$g_uid]['arr_prop_img']);
		if($is_loop_img_change<1 && $total_get_color_img_count==1)//칼라이미지가 한개만 있는데 no image로 처리된거 다시 이미지 가져옴.
		{
			if(preg_match("/i4\/1706222708\/TB22A5pcXXXXXcKXXXXXXXXXXXX_!!1706222708.jpg/i", $arr_api_return_value[$g_uid]['arr_prop_img']['0']['url']))
			{
				$is_loop_img_change = 1;
				if($is_yes_print > 0)
				{
					echo "is_loop_img_change-3 = {$is_loop_img_change}\r\n";
				}
			}
		}
		
		$now_tmall_no_s_title = strtolower(func_tmall_str_no_space($arr_api_return_value[$g_uid]['title'], 1));		
		$now_tmall_approve_status = trim(strtolower($arr_api_return_value[$g_uid]['approve_status']));
		$now_tmall_input_pids = trim($arr_api_return_value[$g_uid]['input_pids']);
		$now_tmall_input_str = trim($arr_api_return_value[$g_uid]['input_str']);
		$now_tmall_price_num = intval($arr_api_return_value[$g_uid]['price']);
		$now_tmall_price_str = str_replace(",","",$now_tmall_price_num);
		//$now_tmall_price_str = str_replace(".","",$now_tmall_price_str);
		$now_tmall_price_str = trim($now_tmall_price_str);
		$api_get_cid = $arr_api_return_value[$g_uid]['cid'];
		if($is_yes_print > 0)
		{
			echo "Get arr_sku ";
			print_r($arr_api_return_value[$g_uid]['arr_sku']);
			echo "Get cid = {$arr_api_return_value[$g_uid]['cid']}, now cid={$cid}, was db cid={$was_cid}\r\n";
			echo "Get props = {$arr_api_return_value[$g_uid]['props']}\r\n";
			echo "Get input_pids = {$arr_api_return_value[$g_uid]['input_pids']}\r\n";
			echo "Get input_str = {$arr_api_return_value[$g_uid]['input_str']}\r\n";
			echo "Get now_img_upload_count = {$total_now_img_upload_count}\r\n";
			echo "Get arr_item_img ";
			print_r($arr_api_return_value[$g_uid]['arr_item_img']);
			echo "Get arr_prop_img ";
			print_r($arr_api_return_value[$g_uid]['arr_prop_img']);
		}
		
		$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
		
		if($is_max_img_continue_check > 0)
		{
			if($is_proc_re_white_bg_img>0 || $is_loop_img_change>0)
			{
				if($IS_TMALL_PM_TIME<1 && $max_img_update_uid>0)//$IS_TMALL_PM_TIME assign config.inc.php
				{
					$is_loop_img_max_update = 1;
					$result_loop_check = mysql_query("SELECT is_proc, continue_stop_num FROM {$tmall_db}._proc_uid WHERE uid={$max_img_update_uid}",$dbconn);
					$row_loop_check = mysql_fetch_assoc($result_loop_check);
					if($row_loop_check['continue_stop_num'] > 0)
					{
						if($row_loop_check['continue_stop_num'] > $max_img_continue_update_num)
						{
							if($is_proc_re_white_bg_img > 0)
							{
								$is_max_white_bg_change_continue_update = 1;
							}
							else
							{
								$is_max_img_change_continue_update = 1;
							}
						}
						else
						{
							dbQuery("UPDATE {$tmall_db}._proc_uid SET continue_stop_num=continue_stop_num+1, update_time=now() WHERE uid={$max_img_update_uid}",$dbconn);
						}
					}
					else
					{
						dbQuery("UPDATE {$tmall_db}._proc_uid SET continue_stop_num=1, update_time=now() WHERE uid={$max_img_update_uid}",$dbconn);
					}
				}
			}
		
			if($is_max_white_bg_change_continue_update > 0)
			{
				dbClose($dbconn);
				$re_white_err = "continue 1 - {$execution_file} - max_img_continue_update_num - continue_stop_num={$row['continue_stop_num']} - ".date("Y-m-d H");
				echo $re_white_err."\r\n";
				continue;
			}
			else if($is_max_img_change_continue_update > 0)
			{
				if($is_absolted_img_changed > 0)
				{
					dbClose($dbconn);
					$re_white_err = "continue 2 - {$execution_file} - max_img_continue_update_num - continue_stop_num={$row['continue_stop_num']} - ".date("Y-m-d H");
					echo $re_white_err."\r\n";
					continue;
				}
				else
				{
					dbClose($dbconn);
					$re_white_err = "continue 3 - {$execution_file} - max_img_continue_update_num - continue_stop_num={$row['continue_stop_num']} - ".date("Y-m-d H");
					echo $re_white_err."\r\n";
					continue;
					/*
	$is_loop_img_max_update = 0;
					$is_loop_img_change = 0;
	*/
				}
			}
		}
		
		if($is_loop_img_change<1 && $total_now_img_upload_count>1 && $is_max_img_change_continue_update<1)
		{
			$is_second_img_change = 0;
			foreach($arr_api_return_value[$g_uid]['arr_item_img'] AS $item_img_key=>$arr_item_img_value)
			{
				if($item_img_key<2) continue;
				if(preg_match("/T24ImoXq8XXXXXXXXX-1706222708.jpg/i", $arr_item_img_value['url']))
				{
					$is_second_img_change = 1;
					break;
				}
				else if(preg_match("/T2XFStXEhXXXXXXXXX-1706222708.jpg/i", $arr_item_img_value['url']))
				{
					$is_second_img_change = 1;
					break;
				}
				else if(preg_match("/T2TbXBXyXaXXXXXXXX-1706222708.jpg/i", $arr_item_img_value['url']))
				{
					$is_second_img_change = 1;
					break;
				}
				else if(preg_match("/T2t9dEXvXaXXXXXXXX-1706222708.jpg/i", $arr_item_img_value['url']))
				{
					$is_second_img_change = 1;
					break;
				}
			}
			
			if($is_second_img_change > 0)
			{
				$query_c_i = "SELECT COUNT(*) AS c_i_ct FROM {$tmall_db}.tmall_item_img_change_num_iid WHERE num_iid='{$num_iid}'";
				if($is_yes_print > 0)
				{
					echo $query_c_i."\r\n";
				}
				$result_c_i = dbQuery($query_c_i,$dbconn);
				$row_c_i = mysql_fetch_assoc($result_c_i);
				if($row_c_i['c_i_ct'] > 0)
				{
				}
				else
				{
					$query_c_i = "INSERT INTO {$tmall_db}.tmall_item_img_change_num_iid (num_iid,regist_time) VALUES ('{$num_iid}',now())";
					if($is_yes_print > 0)
					{
						echo $query_c_i."\r\n";
					}
					dbQuery($query_c_i,$dbconn);
					$is_loop_img_change = 1;
					if($is_yes_print > 0)
					{
						echo "is_loop_img_change-4 = {$is_loop_img_change}\r\n";
					}
				}
			}
		}
		
		$arr_img_g_uid = func_replace_img_g_uidNdir($row['view_g_uid']);
		$img_g_uid = $arr_img_g_uid['img_g_uid'];
		$is_static_img_info = 0;
		$arr_topdown = func_get_tmall_goods_topdown($g_uid, $dbconn, $row['site_code'], 1, $cid);
		$arr_color = $arr_topdown['arr_color'];
		$arr_ori_color_str = $arr_topdown['arr_ori_color_str'];
		$arr_size = $arr_topdown['arr_size'];	
		if($is_yes_print > 0)
		{
			echo "arr_topdown=\r\n";
			print_r($arr_topdown);
		}
		
		if(count($arr_color) < 1)
		{
			dbClose($dbconn);
			$arr_err_info[$g_uid][] = "{$err_default_str} : color zero err : query={$query_ei}";
			$arr_err_cid[$g_uid] = $cid;
			$check_err_num++;
			continue;
		}
		
		$is_need_vertical_img = 0;
		if(in_array($cid, $arr_vertical_img_cid))
		{
			$is_need_vertical_img = 1;
		}
		$is_need_white_bg_img = 1;
		if(in_array($cid, $arr_no_need_white_bg_img_cid))//$arr_no_need_white_bg_img_cid assign schema_config.inc
		{
			$is_need_white_bg_img = 0;
		}
		
		$arr_already_update_tmall_img_uri_g_uid = array();
		$is_absolute_need_item_images = 0;
		$arr_stillcut_uri = array();
		$arr_stillcut_html = array();
		$arr_img_color_name_overlap_check = array();
		$arr_wap_desc = array();
		
		$query_ei = "SELECT id,position,is_major,img_type,url,properties,url_or_byte_key,modified_time FROM {$tmall_db}.tmall_picture_info WHERE g_uid={$g_uid} ORDER BY position ASC";
		if($is_yes_print > 0)
		{
			echo $query_ei."\r\n";
		}
		$result_ei = dbQuery($query_ei,$dbconn);
		$db_position = 1;
		$db_vertical_idx = 1;
		$db_white_bg_idx = 1;
		$arr_db_picture_info = array();
		$arr_db_sort_item_img = array();
		$arr_db_del_picture_id = array();
		$arr_vertical_img_id = array();
		$arr_white_bg_img_id = array();
		$arr_img_tmall_no_s_color = array();
		$t_db_img_upload_count = 0;
		$t_db_color_img_count = 0;
		$now_db_tmall_img_uri = "";
		while($row_ei=mysql_fetch_assoc($result_ei))
		{
			$arr_db_del_picture_id[] = $row_ei['id'];
			
			$arr_db_url_or_byte_key = explode("___",$row_ei['url_or_byte_key']);
			$img_db_key = $arr_db_url_or_byte_key['0'];
			
			$row_ei['url'] = trim($row_ei['url']);
			$row_ei['url'] = func_tmall_img_uri_replace($row_ei['url']);
			
			if($row_ei['img_type'] == 4)//vertical
			{
				$arr_db_picture_info[$g_uid]['vertical_img'][$db_vertical_idx]['id'] = $row_ei['id'];
				$arr_db_picture_info[$g_uid]['vertical_img'][$db_vertical_idx]['url'] = $row_ei['url'];
				$arr_db_picture_info[$g_uid]['vertical_img'][$db_vertical_idx]['modified'] = $row_ei['modified_time'];
				$db_vertical_idx++;
				$arr_db_sort_item_img['04_'.$db_position] = $db_position;
				$arr_vertical_img_id[$db_vertical_idx] = $row_ei['id'];
			}
			else if($row_ei['img_type'] == 5)//white_bg
			{
				$arr_db_picture_info[$g_uid]['white_bg_img'][$db_white_bg_idx]['id'] = $row_ei['id'];
				$arr_db_picture_info[$g_uid]['white_bg_img'][$db_white_bg_idx]['url'] = $row_ei['url'];
				$arr_db_picture_info[$g_uid]['white_bg_img'][$db_white_bg_idx]['modified'] = $row_ei['modified_time'];
				$db_white_bg_idx++;
				$arr_db_sort_item_img['05_'.$db_position] = $db_position;
				$arr_white_bg_img_id[$db_white_bg_idx] = $row_ei['id'];
			}
			else if($row_ei['properties'])
			{
				$arr_db_picture_info[$g_uid]['color_img'][$img_db_key]['url'] = $row_ei['url'];
				$arr_db_picture_info[$g_uid]['color_img'][$img_db_key]['properties'] = $row_ei['properties'];
				$arr_db_picture_info[$g_uid]['color_img'][$img_db_key]['position'] = $db_position;
				if($row_ei['is_major'] == 1)
				{
					$arr_db_sort_item_img['01_'.$db_position] = $db_position;
					
					$is_tmall_img_host = 0;
					foreach($ARR_TMALL_IMG_CHECK_HOST_STR AS $check_host_str)//$ARR_TMALL_IMG_CHECK_HOST_STR assign COMM_FUNC.inc
					{
						if(preg_match("/{$check_host_str}/i", $row_ei['url']))
						{
							$is_tmall_img_host = 1;
							break;
						}
					}
					
					$is_tmall_img_dir = 0;
					foreach($ARR_TMALL_IMG_URI_EXPLODE_STR AS $loop_explode_str)//$ARR_TMALL_IMG_URI_EXPLODE_STR assign COMM_FUNC.inc
					{
						$arr_tmall_img_uri = explode($loop_explode_str, $row_ei['url']);
						if(count($arr_tmall_img_uri) > 1)
						{
							$is_tmall_img_dir = 1;
							break;
						}
					}
					
					if($is_yes_print > 0)
					{
						echo "loop is_tmall_img_host={$is_tmall_img_host}\r\n";
						echo "loop is_tmall_img_dir={$is_tmall_img_dir}\r\n";
					}
					
					if($is_tmall_img_host>0 && $is_tmall_img_dir>0)
					{
						$now_db_tmall_img_uri = str_ireplace(".jpg","",$arr_tmall_img_uri['1']);
					}
				}
				else
				{
					$arr_db_sort_item_img['03_'.$db_position] = $db_position;
				}
				if(!in_array($row_ei['url'], $arr_stillcut_uri))
				{
					$arr_stillcut_uri[] = $row_ei['url'];
					$arr_wap_desc['03_stillcut'][] = "image^|{$row_ei['url']}_600x600.jpg";
					$stillcut_color_str = "";
					if(!$arr_img_color_name_overlap_check[$img_db_key])
					{
						$arr_wap_desc['03_stillcut'][] = "text^|{$arr_ori_color_str[$img_db_key]}";
						$stillcut_color_str = "<br /><div style='font-weight:bold;font-size:13px;'>{$arr_ori_color_str[$img_db_key]}</div><br />";
						$arr_img_color_name_overlap_check[$img_db_key] = 1;
					}
					$arr_stillcut_html[] = "<div><img src=\"{$row_ei['url']}\" /></div>{$stillcut_color_str}";
				}
				$t_db_img_upload_count++;
			}
			else
			{
				$arr_db_sort_item_img['02_'.$db_position] = $db_position;
				if(!in_array($row_ei['url'], $arr_stillcut_uri))
				{
					$arr_stillcut_uri[] = $row_ei['url'];
					$arr_stillcut_html[] = "<div><img src=\"{$row_ei['url']}\" /></div>";
					$arr_wap_desc['03_stillcut'][] = "image^|{$row_ei['url']}_600x600.jpg";
				}
				$t_db_img_upload_count++;
			}
			
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['id'] = $row_ei['id'];
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['url'] = $row_ei['url'];
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['modified'] = $row_ei['modified_time'];
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['position'] = $db_position;
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['properties'] = $row_ei['properties'];
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['img_type'] = $row_ei['img_type'];
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['is_major'] = $row_ei['is_major'];
			$arr_db_picture_info[$g_uid]['picture_info'][$db_position]['url_or_byte_key'] = $row_ei['url_or_byte_key'];
			
			if($row_ei['img_type'] == 1)//color img
			{
				$arr_img_tmall_no_s_color[$img_db_key] = $img_db_key;
				$t_db_color_img_count++;
			}
			
			$db_position++;
		}
		
		if($total_now_img_upload_count < $tmall_default_img_count)
		{
			if($t_db_img_upload_count > $total_now_img_upload_count)
			{
				$total_now_img_upload_count = $t_db_img_upload_count;
				//$is_absolute_need_item_images = 1;
			}
		}
		
		if(count($arr_stillcut_html) < 1)
		{
			$query_ei = "SELECT id, properties, url, color_str, is_use_desc, modified_time FROM {$tmall_db}.tmall_item_propimg WHERE num_iid='{$num_iid}' ORDER BY position ASC";
			$result_ei = dbQuery($query_ei,$dbconn);
			$arr_item_propimg_id = array(); //삭제시 이용
			$img_idx = 1;
			while($row_ei=mysql_fetch_assoc($result_ei))
			{
				$is_propimg_color = 0;
				$no_s_temp_color_img_props = strtolower(func_tmall_str_no_space($row_ei['color_str'], 1));
				foreach($arr_color AS $temp_color_str)
				{
					$temp_color_str = trim($temp_color_str);
					if(!$temp_color_str) continue;
					$arr_temp_color_str = explode("^|^", $temp_color_str);
					$no_s_temp_color_str = $arr_temp_color_str['1'];
					if($no_s_temp_color_img_props == $no_s_temp_color_str)
					{
						$is_propimg_color = 1;
						break;
					}
				}
				if($is_propimg_color<1) 
				{
					if($row['site_code']==123 && $no_s_temp_color_img_props=='onecolor')
					{
						$is_propimg_color = 1;
					}
					else
					{
						continue;
					}
				}
				
				$row_ei['url'] = trim($row_ei['url']);
				$row_ei['url'] = func_tmall_img_uri_replace($row_ei['url']);
				if($row_ei['url'] && $row_ei['is_use_desc']>0)
				{
					if(!in_array($row_ei['url'], $arr_stillcut_uri))
					{
						$arr_stillcut_uri[] = $row_ei['url'];
						$arr_wap_desc['03_stillcut'][] = "image^|{$row_ei['url']}_600x600.jpg";
						$stillcut_color_str = "";
						if(!$arr_img_color_name_overlap_check[$no_s_temp_color_img_props])
						{
							$arr_wap_desc['03_stillcut'][] = "text^|{$row_ei['color_str']}";
							$stillcut_color_str = "<br /><div style='font-weight:bold;font-size:13px;'>{$row_ei['color_str']}</div><br />";
							$arr_img_color_name_overlap_check[$no_s_temp_color_img_props] = 1;
						}
						$arr_stillcut_html[] = "<div><img src=\"{$row_ei['url']}\" /></div>{$stillcut_color_str}";
					}
				}
				
				$arr_temp_item_propimg_id = explode("_", $row_ei['id']);
				if(count($arr_temp_item_propimg_id) < 2)
				{
					$color_properties = "";
					$prop_img_type = 3;
					$url_or_byte_key = $no_s_temp_color_img_props."___".$img_idx;
					if(count($arr_db_picture_info[$g_uid]['color_img'][$no_s_temp_color_img_props]) < 1)
					{
						$arr_db_picture_info[$g_uid]['color_img'][$no_s_temp_color_img_props]['url'] = $row_ei['url'];
						$arr_db_picture_info[$g_uid]['color_img'][$no_s_temp_color_img_props]['properties'] = $row_ei['properties'];
						$arr_db_picture_info[$g_uid]['color_img'][$no_s_temp_color_img_props]['position'] = $img_idx;
						$color_properties = $row_ei['properties'];
						$prop_img_type = 1;
						$url_or_byte_key = $no_s_temp_color_img_props;
					}
					
					$is_major_color_img = 0;
					if($img_idx == 1)
					{
						$arr_db_sort_item_img['01_'.$db_position] = $db_position;
						$is_major_color_img = 1;
					}
					else
					{
						$arr_db_sort_item_img['03_'.$db_position] = $db_position;
					}
					
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['id'] = $row_ei['id'];
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['url'] = $row_ei['url'];
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['modified'] = $row_ei['modified_time'];
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['position'] = $img_idx;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['properties'] = $color_properties;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['img_type'] = $prop_img_type;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['is_major'] = $is_major_color_img;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['url_or_byte_key'] = $url_or_byte_key;
					
					$arr_item_propimg_id[$img_idx] = $row_ei['id'];
					$img_idx++;
					$db_position++;
				}
			}
			$query_ei = "SELECT id, url, is_use_desc, modified_time FROM {$tmall_db}.tmall_item_img WHERE num_iid='{$num_iid}' ORDER BY position ASC";
			$result_ei = dbQuery($query_ei,$dbconn);
			$arr_item_img_id = array(); //삭제시 이용
			$img_idx = 1;
			while($row_ei=mysql_fetch_assoc($result_ei))
			{
				$row_ei['url'] = trim($row_ei['url']);
				$row_ei['url'] = func_tmall_img_uri_replace($row_ei['url']);
				if($row_ei['url'] && $row_ei['is_use_desc']>0)
				{
					if(!in_array($row_ei['url'], $arr_stillcut_uri))
					{
						$arr_stillcut_uri[] = $row_ei['url'];
						$arr_stillcut_html[] = "<div><img src=\"{$row_ei['url']}\" /></div>";
						$arr_wap_desc['03_stillcut'][] = "image^|{$row_ei['url']}_600x600.jpg";
					}
				}
				$arr_temp_item_img_id = explode("_", $row_ei['id']);
				if(count($arr_temp_item_img_id) < 2)
				{
					$arr_db_sort_item_img['02_'.$db_position] = $db_position;
					
					$url_or_byte_key = "still_|_cut___".$img_idx;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['id'] = $row_ei['id'];
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['url'] = $row_ei['url'];
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['modified'] = $row_ei['modified_time'];
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['position'] = $img_idx;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['properties'] = "";
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['img_type'] = 2;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['is_major'] = 0;
					$arr_db_picture_info[$g_uid]['picture_info'][$img_idx]['url_or_byte_key'] = $url_or_byte_key;
					
					$arr_item_img_id[$img_idx] = $row_ei['id'];
					$img_idx++;
					$db_position++;
				}
			}
		}
		unset($arr_stillcut_uri);
	
		$count_each_color_db_info = count($arr_db_picture_info[$g_uid]['color_img']);
		$count_color = count($arr_color);
		
		$is_need_attach_barcode = 0;
		$is_need_attach_label = 0;
		$barcode_img_loc = "";
		//if(in_array($cid, $arr_need_diaopai_cid))//$arr_need_diaopai_cid assign schema_config.inc
		if($arr_need_diaopai_cid[$cid])//$arr_need_diaopai_cid assign schema_config.inc
		{
			$query_ei = "SELECT url AS attach_img FROM {$tmall_db}.tmall_picture_attach_img WHERE g_uid={$g_uid}";
			$result_ei = dbQuery($query_ei,$dbconn);
			$row_ei = mysql_fetch_assoc($result_ei);
			if($row_ei['attach_img'])
			{
				$is_need_attach_barcode = 1;
				$barcode_img_loc = $row_ei['attach_img'];
			}
		}
		//if(in_array($cid, $arr_need_label_cid))//$arr_need_label_cid assign schema_config.inc
		if($arr_need_label_cid[$cid])//$arr_need_label_cid assign schema_config.inc
		{
			if($is_need_attach_barcode > 0)//신규 등록 할때 에는 $is_need_attach_barcode, $is_need_attach_label를 따로 처리하였으나 수정시에는 신규등록시 이값들이 입력 된것들만 한해서 처리해줘야 하기때문에 이렇게 처리하였음.
			{
				$is_need_attach_label = 1;
			}
		}
		
		if($is_yes_print > 0)
		{
			echo "count_each_color_db_info({$count_each_color_db_info}) = count_color({$count_color}) \r\n";
			echo "arr_item_propimg_id \r\n";
			print_r($arr_item_propimg_id);
			echo "arr_item_img_id \r\n";
			print_r($arr_item_img_id);
			echo "arr_db_picture_info \r\n";
			print_r($arr_db_picture_info);
			echo "arr_db_sort_item_img = ";
			print_r($arr_db_sort_item_img);
			echo "arr_db_del_picture_id = ";
			print_r($arr_db_del_picture_id);
			echo "is_need_attach_barcode = {$is_need_attach_barcode}\r\n";
			echo "barcode_img_loc = {$barcode_img_loc}\r\n";
			echo "is_need_attach_label = {$is_need_attach_label}\r\n";
			
			echo "arr_inactive_c_code \r\n";
			print_r($arr_inactive_c_code);
		}
		
		$is_check_just_proc_img = 0;
		$is_just_need_vertical_img = 0;
		$is_just_need_white_bg_img = 0;
		if($is_need_vertical_img>0 && count($arr_db_picture_info[$g_uid]['vertical_img'])<1 && $is_loop_img_change<1 && $is_max_img_change_continue_update<1)
		{
			$is_just_need_vertical_img = 1;
			$is_check_just_proc_img = 1;
		}
		else if($is_need_white_bg_img>0 && count($arr_db_picture_info[$g_uid]['white_bg_img'])<1 && $is_loop_img_change<1 && $is_max_img_change_continue_update<1)
		{
			$is_just_need_white_bg_img = 1;
			$is_check_just_proc_img = 1;
		}
		else if($is_need_white_bg_img>0 && $is_proc_re_white_bg_img>0 && $is_loop_img_change<1 && $is_max_img_change_continue_update<1)
		{
			$is_just_need_white_bg_img = 1;
			$is_check_just_proc_img = 1;
		}
		
		$is_not_same_img_count = 0;
		if($is_loop_img_change<1 && $count_color>$count_each_color_db_info && $is_max_img_change_continue_update<1)
		{
			//Black~~0^1^2^3^4^5***Amber~~6***Dark Brown~~7
			$arr_now_bf_db_color_img_list = explode("***", $row['color_img_list']);
			if(count($arr_now_bf_db_color_img_list) > $count_each_color_db_info)
			{
				//$is_not_same_img_count = 1;//일단 이건보류
			}
			unset($arr_now_bf_db_color_img_list);
		}
		if($is_loop_img_change<1)
		{
			$arr_ct_db_color_img_list = func_get_color_img_list_ct($row['color_img_list']);
			if($is_yes_print > 0)
			{
				echo "arr_img_tmall_no_s_color - 1 = ";
				print_r($arr_img_tmall_no_s_color);
				echo "arr_ct_db_color_img_list = ";
				print_r($arr_ct_db_color_img_list);
			}
			$ct_db_total_color_img_list = $arr_ct_db_color_img_list['ct_img_list'];
			$ct_db_color_img_list = $arr_ct_db_color_img_list['ct_color_img'];
			if($ct_db_total_color_img_list>0 && $ct_db_color_img_list>0)
			{
				$arr_vars = array(
					'arr_now_color_img_name'=>$arr_ct_db_color_img_list['color_str'],
					'arr_was_color_img_name'=>$arr_img_tmall_no_s_color,
					'arr_ori_color_str'=>$arr_ori_color_str,
					'is_yes_print'=>$is_yes_print
				);
				if($is_yes_print>0)
				{
					echo "arr_vars = ";
					echo("<pre>");print_r($arr_vars);echo("</pre>");
				}
				$arr_compare_result = func_color_img_name_compare($arr_vars);
				if($is_yes_print>0)
				{
					echo "arr_compare_result = ";
					echo("<pre>");print_r($arr_compare_result);echo("</pre>");
				}
				$is_need_tmall_color_img_change = $arr_compare_result['is_need_change'];
				if($arr_compare_result['only_tmall_is_need_change'] > 0)
				{
					$is_need_tmall_color_img_change = $arr_compare_result['only_tmall_is_need_change'];
				}
				unset($arr_vars);
				unset($arr_compare_result);
				
				$is_re_img_ct = 0;
				if($is_need_tmall_color_img_change > 0)
				{
					$is_re_img_ct = 1;
				}
				if($ct_db_color_img_list > $t_db_color_img_count)
				{
					//$is_re_img_ct = 1;//일단보류
				}
				else if($ct_db_total_color_img_list > $t_db_img_upload_count)
				{
					//$is_re_img_ct = 1;//일단보류
				}
				else if($ct_db_total_color_img_list>1 && $t_db_img_upload_count==2)
				{
					//$is_re_img_ct = 1;//일단보류
				}
				if($is_re_img_ct>0 && $is_max_img_change_continue_update<1)
				{
					if(in_array($row['site_code'], $ARR_USBF_IMG_SITE_CODE))
					{
						$is_loop_img_change = 1;
						if($is_yes_print > 0)
						{
							echo "is_loop_img_change-5 = {$is_loop_img_change}\r\n";
						}
					}
					else
					{
						if($is_not_same_img_count<1 && $is_max_img_change_continue_update<1)
						{
							$is_not_same_img_count = 1;
						}
					}
				}
			}
			unset($arr_ct_db_color_img_list);
		}
		
		if($is_loop_img_change<1 && $is_max_img_change_continue_update<1)
		{
			$query_ei = "SELECT view_g_uid, is_re, is_tmall_side_update FROM {$source_site_grep_db}.wget_re_right_now WHERE view_g_uid='{$row['view_g_uid']}' AND update_num<6 AND err_update_num<6";
			if($is_yes_print > 0)
			{
				echo $query_ei."\r\n";
			}
			$result_ei = dbQuery($query_ei,$dbconn);
			$row_ei = mysql_fetch_assoc($result_ei);
			if($row_ei['view_g_uid'])
			{
				$is_wget_is_re = "{$row_ei['is_re']}";
				if($is_yes_print > 0)
				{
					echo "is_re = {$is_wget_is_re}, is_tmall_side_update = {$row_ei['is_tmall_side_update']}\r\n";
				}
				if($is_wget_is_re=='0' || $row_ei['is_tmall_side_update']>0)
				{
					$is_loop_img_change = 1;
					if($is_yes_print > 0)
					{
						echo "is_loop_img_change-6 = {$is_loop_img_change}\r\n";
					}
				}
			}
		}
		
		
		$query_ei = "SELECT item_price FROM {$tmall_db}.tmall_payment_each WHERE g_uid={$g_uid}";
		if($is_yes_print > 0)
		{
			echo $query_ei."\r\n";
		}
		$result_ei = dbQuery($query_ei, $dbconn);
		$arr_paid_goods_item_price = array();
		while($row_ei=mysql_fetch_assoc($result_ei))
		{
			$arr_paid_goods_item_price[] = $row_ei['item_price'];
		}
		$is_paid_goods_ct = count($arr_paid_goods_item_price);
		$paid_goods_max_item_price = 0;
		if($is_paid_goods_ct > 0)
		{
			if($is_paid_goods_ct > 1)
			{
				rsort($arr_paid_goods_item_price);//역순 정렬
			}
			$paid_goods_max_item_price = $arr_paid_goods_item_price['0'];
		}
		
		if($is_yes_print > 0)
		{
			echo "is_need_tmall_color_img_change - 1 =  {$is_need_tmall_color_img_change}\r\n";
			echo "img total ct  : now={$ct_db_total_color_img_list}, was={$t_db_img_upload_count}\r\n";
			echo "is_loop_img_change = {$is_loop_img_change}\r\n";
			echo "is_not_same_img_count = {$is_not_same_img_count}\r\n";
			echo "is_just_need_vertical_img = {$is_just_need_vertical_img}\r\n";
			echo "is_just_need_white_bg_img = {$is_just_need_white_bg_img}\r\n";
			echo "is_paid_goods_ct = ".$is_paid_goods_ct."\r\n";
			echo "paid_goods_max_item_price = ".$paid_goods_max_item_price."\r\n";
		}
		
		$row['site_name'] = str_replace("-","_",$row['site_name']);//net-a-poter 처럼 -대쉬가있는경우 관련테이블 쿼리시 에러가 발생하므로 해당 테이블명을 _ 언더바로 처리 하였음.
		//$is_paid_goods_ct = 0;
		if($is_loop_img_change>0 || $is_just_need_vertical_img>0  || $is_just_need_white_bg_img>0 || $is_not_same_img_count>0)
		{
			//이미지 변경이고 한번이라도 결제된 상품이면 taobao.picture.upload 에 등록된 이미지는 삭제를 하지않고 디비에서만 삭제처리해준다. 이유는 구매된 상품의 상세보기에서는 주문했을때의 이미지 값을 가지고 있기때문임 (참고: 단 item.img.delete, item.propimg.delete api는 실행함 이유는 해당 api는 이미지 개수 제한이 있기때문임) - 15.06.29 추가
			/*
$query_ei = "SELECT COUNT(*) AS paid_goods_ct FROM {$tmall_db}.tmall_payment_each WHERE g_uid={$g_uid}";
			$result_ei = dbQuery($query_ei,$dbconn);
			$row_ei = mysql_fetch_assoc($result_ei);
			$is_paid_goods_ct = $row_ei['paid_goods_ct'];
			if($is_yes_print > 0)
			{
				echo $query_ei."\r\n";
				echo "is_paid_goods_ct = ".$is_paid_goods_ct."\r\n";
			}
*/
			
			/* 
			colorinfo, stillinfo, td_color_size, tmall-props start 
			이렇게 loop내에 쿼리를 하는 이유는 소스사이트 이미지 가져오는 툴이 2개이상이 생겨 어쩔수 없이 loop에서 처리함. (colorinfo, stillinfo정보를 가져오기 위함) 
			*/
			
			if(count($ARR_TMALL_STATIC_IMG_INFO[$g_uid]) > 0) //$ARR_TMALL_STATIC_IMG_INFO assign config.inc.php
			{
				$row['colorinfo'] = $ARR_TMALL_STATIC_IMG_INFO[$g_uid]['colorinfo'];
				$row['stillinfo'] = $ARR_TMALL_STATIC_IMG_INFO[$g_uid]['stillinfo'];
				$is_static_img_info = 1;
				$this_db_name = $tmall_db;
				$this_db_host = $tmall_host;
			}
			else
			{
				if(in_array($row['site_code'], $ARR_BF_SOURCE_SITE_CODE))
				{
					$this_db_name = $source_site_grep_db;
					$this_db_host = $source_site_grep_host;
					$source_site_tb_name_1 = "{$row['site_name']}_{$row['site_code']}_goods";
					$source_site_tb_name_2 = "{$row['site_name']}_{$row['site_code']}_goods_info";
					$query_ei = "
						SELECT 
							SGI.each_color_img AS colorinfo, SGI.stillcut_img AS stillinfo
						FROM 
							{$this_db_name}.{$source_site_tb_name_1} SG, {$this_db_name}.{$source_site_tb_name_2} SGI 
						WHERE SG.s_pid=SGI.s_pid 
						AND SG.view_g_uid='{$row['view_g_uid']}'
					";
				}
				else
				{
					$this_db_name = $cosmos_db;
					$this_db_host = $cosmos_host;
					$query_ei = "SELECT colorinfo, stillinfo FROM {$this_db_name}.cgColorMain WHERE prodinc='{$img_g_uid}'";
				}
			}
			
			if($is_yes_print > 0)
			{
				echo "is_static_img_info = ".$is_static_img_info."\r\n";
				echo $query_ei."\r\n";
			}
			if($is_static_img_info < 1)
			{
				$is_already_colorinfo_done = 0;
				if(!in_array($row['site_code'], $ARR_BF_SOURCE_SITE_CODE))
				{
					if($row['is_auto_stock'] > 0)//코스모스에서 바이파인으로 이전 준비중인 사이트중에 혹 $source_site_grep_db에 이미지 정보가 있으면 가져오기 위함
					{
						$query_2_ei = "
							SELECT 
								SGI.each_color_img AS colorinfo, SGI.stillcut_img AS stillinfo
							FROM 
								{$source_site_grep_db}.{$row['site_name']}_{$row['site_code']}_goods SG, {$source_site_grep_db}.{$row['site_name']}_{$row['site_code']}_goods_info SGI 
							WHERE SG.s_pid=SGI.s_pid 
							AND SG.view_g_uid='{$row['view_g_uid']}'
						";
						if($is_yes_print > 0)
						{
							echo $query_2_ei."\r\n";
						}
						$result_2_ei = dbQuery($query_2_ei,$dbconn);
						$row_2_ei = mysql_fetch_assoc($result_2_ei);
						if($row_2_ei['colorinfo'])
						{
							$is_already_colorinfo_done = 1;
							$row['colorinfo'] = $row_2_ei['colorinfo'];
							$row['stillinfo'] = $row_2_ei['stillinfo'];
						}
					}
				}
				
				if($is_already_colorinfo_done < 1)
				{
					$result_ei = dbQuery($query_ei,$dbconn);
					$row_ei = mysql_fetch_assoc($result_ei);
					$row['colorinfo'] = $row_ei['colorinfo'];
					$row['stillinfo'] = $row_ei['stillinfo'];
				}
			}
			if($is_yes_print > 0)
			{
				echo "colorinfo = ".$row['colorinfo']."\r\n";
			}
			if($is_not_same_img_count>0 && $is_static_img_info<1)
			{
				$arr_colorinfo = explode("***",$row['colorinfo']);
				$arr_new_colorinfo = array();
				foreach($arr_colorinfo AS $temp_colorinfo)
				{
					$temp_colorinfo = trim($temp_colorinfo);
					if(!$temp_colorinfo) continue;
					$arr_new_colorinfo[] = $temp_colorinfo;
				}
				unset($arr_colorinfo);
				$count_new_colorinfo = count($arr_new_colorinfo);
				unset($arr_new_colorinfo);
				if($count_new_colorinfo > $count_each_color_db_info)
				{
					/*
					$is_loop_img_change = 1;
					$is_just_need_vertical_img = 0;
					if($is_yes_print > 0)
					{
						echo "is_loop_img_change-6 = {$is_loop_img_change}\r\n";
					}
					*/
				}
				if($is_loop_img_change < 1)
				{
					$arr_ct_db_colorinfo = func_get_color_img_list_ct($row['colorinfo']);
					if($is_yes_print > 0)
					{
						echo "arr_img_tmall_no_s_color - 2 = ";
						print_r($arr_img_tmall_no_s_color);
						echo "arr_ct_db_colorinfo = ";
						print_r($arr_ct_db_colorinfo);
					}
					$ct_db_all_color_img = $arr_ct_db_colorinfo['ct_img_list'];
					$ct_db_color_image = $arr_ct_db_colorinfo['ct_color_img'];
					
					$arr_vars = array(
						'arr_now_color_img_name'=>$arr_ct_db_colorinfo['color_str'],
						'arr_was_color_img_name'=>$arr_img_tmall_no_s_color,
						'arr_ori_color_str'=>$arr_ori_color_str,
						'is_yes_print'=>$is_yes_print
					);
					if($is_yes_print>0)
					{
						echo "arr_vars = ";
						echo("<pre>");print_r($arr_vars);echo("</pre>");
					}
					$arr_compare_result = func_color_img_name_compare($arr_vars);
					if($is_yes_print>0)
					{
						echo "arr_compare_result - 2 = ";
						echo("<pre>");print_r($arr_compare_result);echo("</pre>");
					}
					$is_need_tmall_color_img_change = $arr_compare_result['is_need_change'];
					if($arr_compare_result['only_tmall_is_need_change'] > 0)
					{
						$is_need_tmall_color_img_change = $arr_compare_result['only_tmall_is_need_change'];
					}
					unset($arr_vars);
					unset($arr_compare_result);
					if($ct_db_all_color_img>0 && $ct_db_color_image>0)
					{
						if($is_need_tmall_color_img_change>0)
						{
							$is_loop_img_change = 1;
							$is_just_need_vertical_img = 0;
							$is_just_need_white_bg_img = 0;
							$is_check_just_proc_img = 0;
							if($is_yes_print > 0)
							{
								echo "is_loop_img_change-7 = {$is_loop_img_change}\r\n";
							}
						}
					}
					unset($arr_ct_db_colorinfo);
				}
			}
		}
		unset($arr_img_tmall_no_s_color);
		
		if($is_proc_check > 0)
		{
			$result_break = mysql_query("SELECT is_loop_break FROM {$tmall_db}._proc_uid WHERE uid={$execution_proc_id}",$dbconn);
			$row_break = mysql_fetch_assoc($result_break);
			if($row_break['is_loop_break'] > 0)
			{
				dbQuery("UPDATE {$tmall_db}._proc_uid SET is_loop_break=0 WHERE uid={$execution_proc_id}",$dbconn);
				dbClose($dbconn);
				
				$err = "Error - {$execution_file} - Loop Break";
				$subject = "[BUYFINE-Tmall] {$err} - ".date("Y-m-d H");
				echo $subject."\r\n";
				fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
				
				break;
			}
		}
		
		if($row['margin_rate'])
		{
			$margin_rate_n = $row['margin_rate'];
		}
		else
		{
			$margin_rate_n = $margin_rate;
		} 
		$arr_price_info = func_get_price_v2($row['g_cost'], $row['g_cost_h'], $row['tax_percent'], $row['tax_percent_h'], $row['shipping_fee'], $row['shipping_fee_h'], $row['normal_sale_rate'], $margin_rate_n, $exchange_rate, $exchange_rate_krw_cny, 0, $row['g_uid'], $row['sl_uid'], $row['c_value'], $row['site_code'], $b_code_t, 0, 0, 0, $is_yes_print, $tmall_get_p_type, $row['is_fixed_price'], $row['fixed_price_info']);//$tmall_get_p_type assign config.inc.php
		
		//고정 가격이므로 마진 값을 수정하지 않는다.
		if(in_array($row['g_uid'], $ARR_TMALL_STATIC_PRICE_G_UID))//$ARR_TMALL_STATIC_PRICE_G_UID assign COMM_FUNC.inc
		{
			if(count($ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]) > 1)//$ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO assign config.inc.php
			{
				/*
				if($ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]['type'] == 'margin_upNdot_up')
				{
					$arr_price_info['bf_selling_price'] = ceil($arr_price_info['bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
					$arr_price_info['bf_selling_price'] = ceil($arr_price_info['bf_selling_price']*$ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]['normal_dot_up']);
					
					$arr_price_info['sp_bf_selling_price'] = ceil($arr_price_info['sp_bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
					$arr_price_info['sp_bf_selling_price'] = ceil($arr_price_info['sp_bf_selling_price']*$ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]['selling_dot_up']);
				}
				else
				{
					$arr_price_info['bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]['normal_price'];
					$arr_price_info['sp_bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]['selling_price'];
				}
				*/
				$arr_price_info['bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]['normal_price'];
				$arr_price_info['sp_bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row['g_uid']]['selling_price'];
			}
		}
		else
		{
			if($TMALL_MARGIN_UP_DOT_P > 0) //$TMALL_MARGIN_UP_DOT_P assign COMM_FUNC.inc
			{
				$arr_margin_up_price_info = func_get_price_v2($row['g_cost'], $row['g_cost_h'], $row['tax_percent'], $row['tax_percent_h'], $row['shipping_fee'], $row['shipping_fee_h'], $row['normal_sale_rate'], $margin_rate_n, $exchange_rate, $exchange_rate_krw_cny, 0, $row['g_uid'], $row['sl_uid'], $row['c_value'], $row['site_code'], $b_code_t, 0, 0, $TMALL_MARGIN_UP_DOT_P, $is_yes_print, $tmall_get_p_type, $row['is_fixed_price'], $row['fixed_price_info']);//$tmall_get_p_type assign config.inc.php
				if($arr_margin_up_price_info['bf_selling_price']<$arr_price_info['bf_selling_price']) $arr_margin_up_price_info['bf_selling_price']=$arr_price_info['bf_selling_price'];
				if($arr_margin_up_price_info['sp_bf_selling_price']<$arr_price_info['sp_bf_selling_price']) $arr_margin_up_price_info['sp_bf_selling_price']=$arr_price_info['sp_bf_selling_price'];
				$arr_price_info['bf_selling_price'] = $arr_margin_up_price_info['bf_selling_price'];
				$arr_price_info['sp_bf_selling_price'] = $arr_margin_up_price_info['sp_bf_selling_price'];
				unset($arr_margin_up_price_info);
				/*
				$arr_price_info['bf_selling_price'] = ceil($arr_price_info['bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
				$arr_price_info['sp_bf_selling_price'] = ceil($arr_price_info['sp_bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
				*/
			}
			
			$db_last_paid_max_price = $row['last_paid_max_price'];
			if($db_last_paid_max_price>0 && $arr_price_info['sp_bf_selling_price']<$db_last_paid_max_price)
			{
				$arr_price_info['sp_bf_selling_price'] = $db_last_paid_max_price;
			}
		}
		
		if($is_yes_print > 0)
		{
			echo "arr_paid_goods_item_price=\r\n";
			print_r($arr_paid_goods_item_price);
			echo "sp_bf_selling_price = ".$arr_price_info['sp_bf_selling_price']."\r\n";
		}
		if($paid_goods_max_item_price>0 && $paid_goods_max_item_price>$arr_price_info['sp_bf_selling_price'])
		{
			$arr_price_info['sp_bf_selling_price'] = $paid_goods_max_item_price;
		}
		//$arr_price_info['sp_bf_selling_price'] = 1566;
		
		if($arr_price_info['bf_selling_price'] < $arr_price_info['sp_bf_selling_price'])
		{
			$arr_price_info['bf_selling_price'] = $arr_price_info['sp_bf_selling_price'];
			$arr_price_info['sp_bf_str'] = "";
		}
		$add_on_sale_g_title = "";
		if($arr_price_info['sp_bf_str'])
		{
			//$add_on_sale_g_title = "【特惠】 ";
			$add_on_sale_g_title = "【特惠】";
			//$add_on_sale_g_title = "[特惠] ";
		}

		/* DP list start */
		$dp_html_str = "";
		if(($row['sl_uid']==2) && (in_array($row['site_code'], $ARR_ACTIVE_DP_SITE_CODE)))
		{
			$dp_site_name = str_replace("-","_",$row['site_name']);
			$query_dp = "SELECT dp_s_pid_list FROM {$source_site_grep_db}.{$dp_site_name}_{$row['site_code']}_dp_s_pid  WHERE view_g_uid='{$row['view_g_uid']}'";
			$result_dp = dbQuery($query_dp,$dbconn);
			$row_dp = mysql_fetch_assoc($result_dp);
			if($row_dp['dp_s_pid_list'])
			{
				$arr_dp_s_pid_list = explode("|",$row_dp['dp_s_pid_list']);
				$arr_in_dp_s_pid = array();
				foreach($arr_dp_s_pid_list AS $dp_s_pid)
				{
					$dp_s_pid = trim($dp_s_pid);
					if(!$dp_s_pid) continue;
					$arr_in_dp_s_pid[] = "'".$dp_s_pid."'";
				}
				unset($arr_dp_s_pid_list);
				unset($row_dp);
				if(count($arr_in_dp_s_pid) > 0)
				{
					$in_dp_s_pid = implode(",",$arr_in_dp_s_pid);
					unset($arr_in_dp_s_pid);
					$query_dp = "SELECT g_uid FROM {$source_site_grep_db}.{$dp_site_name}_{$row['site_code']}_goods WHERE s_pid IN ({$in_dp_s_pid}) AND is_use=1 AND g_uid>0";
					$result_dp = dbQuery($query_dp,$dbconn);
					$arr_in_dp_g_uid = array();
					while($row_dp=mysql_fetch_assoc($result_dp))
					{
						$arr_in_dp_g_uid[] = $row_dp['g_uid'];
					}
					
					if(count($arr_in_dp_g_uid) > 0)
					{
						$in_dp_g_uid = implode(",",$arr_in_dp_g_uid);
						
						$query_dp = "SELECT g_uid, url FROM {$tmall_db}.tmall_picture_info WHERE g_uid IN ({$in_dp_g_uid}) AND img_type=1 AND is_major=1 ORDER BY position ASC";
						$result_dp = dbQuery($query_dp,$dbconn);
						$arr_dp_picture_info_g_uid = array();
						while($row_dp=mysql_fetch_assoc($result_dp))
						{
							if(!$arr_dp_picture_info_g_uid[$row_dp['g_uid']])
							{
								$arr_dp_picture_info_g_uid[$row_dp['g_uid']] = $row_dp['url'];
							}
						}
						
						$query_dp = "
							SELECT 
								TI.num_iid, TI.outer_id, TI.last_paid_max_price, TI.pic_url,
								G.g_uid, G.view_g_uid, G.img_cache_num, G.isAvailable, G.isSoldout, G.site_code, G.sl_uid, G.g_title, G.g_cost, G.g_cost_h, G.tax_percent, G.tax_percent_h, G.shipping_fee, G.shipping_fee_h, G.normal_sale_rate, G.is_new_img, G.n_code, G.c_value, G.color_ct, G.is_fixed_price, G.fixed_price_info,
								GIH.g_info,
								GB.b_code, GB.b_name, GB.b_name_cn, GB.margin_rate
							FROM 
								{$tmall_db}.tmall_item TI, {$goods_db}.goods G, {$goods_db}.goods_info_html GIH, {$goods_db}.goods_brand GB
							WHERE TI.g_uid=G.g_uid 
							AND TI.g_uid=GIH.g_uid
							AND G.b_code=GB.b_code
							AND TI.g_uid IN ({$in_dp_g_uid})
							ORDER BY G.c_code ASC
						";
						if($is_yes_print > 0)
						{
							echo $query_dp."\r\n";
						}
						$result_dp = dbQuery($query_dp,$dbconn);
						while($row_dp=mysql_fetch_assoc($result_dp))
						{
							if($arr_dp_picture_info_g_uid[$row_dp['g_uid']])
							{
								$row_dp['pic_url'] = $arr_dp_picture_info_g_uid[$row_dp['g_uid']];
							}
							else
							{
								$row_dp['pic_url'] = trim($row_dp['pic_url']);
							}
							if(!$row_dp['pic_url']) continue;
							$full_s_img = $row_dp['pic_url']."_200x200.jpg";
							$full_s_img = func_tmall_img_uri_replace($full_s_img);
							$dp_b_codeNc_value = $row_dp['b_code']."^".$row_dp['c_value'];
							
							if($arr_tmall_title_use_b_codeNc_value[$dp_b_codeNc_value])
							{
								$dp_g_title_cn = $arr_tmall_title_use_b_codeNc_value[$dp_b_codeNc_value]; // $arr_tmall_title_use_b_codeNc_value assign  tmall/config.inc.php
							}
							else if($arr_tmall_title_use_c_value[$row_dp['c_value']])
							{
								$dp_g_title_cn = $arr_tmall_title_use_c_value[$row_dp['c_value']]; // $arr_tmall_title_use_c_value assign  tmall/config.inc.php
							}
							else
							{
								$dp_g_title_cn = $arr_translate_title_use_c_value[$row_dp['c_value']];
							}
							if($row_dp['b_name_cn'])
							{
								$db_title_b_name = $row_dp['b_name']."/".$row_dp['b_name_cn'];
							}
							else
							{
								$db_title_b_name = $row_dp['b_name'];
							}
							$dp_title = $db_title_b_name." ".$dp_g_title_cn." ".$row_dp['outer_id']; // $send_box_test_str assign config.inc.php
							
							if($row_dp['margin_rate'])
							{
								$dp_margin_rate_n = $row_dp['margin_rate'];
							}
							else
							{
								$dp_margin_rate_n = $margin_rate;
							}
							
							$arr_dp_price_info = func_get_price_v2($row_dp['g_cost'], $row_dp['g_cost_h'], $row_dp['tax_percent'], $row_dp['tax_percent_h'], $row_dp['shipping_fee'], $row_dp['shipping_fee_h'], $row_dp['normal_sale_rate'], $margin_rate_n, $exchange_rate, $exchange_rate_krw_cny, 0, $row_dp['g_uid'], $row_dp['sl_uid'], $row_dp['c_value'], $row_dp['site_code'], $row_dp['b_code'], 0, 0, 0, $is_yes_print, $tmall_get_p_type, $row_dp['is_fixed_price'], $row_dp['fixed_price_info']);//$tmall_get_p_type assign config.inc.php
							
							//고정 가격이므로 마진 값을 수정하지 않는다.
							if(in_array($row_dp['g_uid'], $ARR_TMALL_STATIC_PRICE_G_UID))//$ARR_TMALL_STATIC_PRICE_G_UID assign COMM_FUNC.inc
							{
								if(count($ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]) > 1)//$ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO assign config.inc.php
								{
									/*
									if($ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]['type'] == 'margin_upNdot_up')
									{
										$arr_dp_price_info['bf_selling_price'] = ceil($arr_dp_price_info['bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
										$arr_dp_price_info['bf_selling_price'] = ceil($arr_dp_price_info['bf_selling_price']*$ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]['normal_dot_up']);
										
										$arr_dp_price_info['sp_bf_selling_price'] = ceil($arr_dp_price_info['sp_bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
										$arr_dp_price_info['sp_bf_selling_price'] = ceil($arr_dp_price_info['sp_bf_selling_price']*$ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]['selling_dot_up']);
									}
									else
									{
										$arr_dp_price_info['bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]['normal_price'];
										$arr_dp_price_info['sp_bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]['selling_price'];
									}
									*/
									$arr_dp_price_info['bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]['normal_price'];
									$arr_dp_price_info['sp_bf_selling_price'] = $ARR_ONLY_TMALL_STATIC_PRICE_G_UID_INFO[$row_dp['g_uid']]['selling_price'];
								}
							}
							else
							{
								if($TMALL_MARGIN_UP_DOT_P > 0) //$TMALL_MARGIN_UP_DOT_P assign COMM_FUNC.inc
								{
									$arr_margin_up_price_info = func_get_price_v2($row_dp['g_cost'], $row_dp['g_cost_h'], $row_dp['tax_percent'], $row_dp['tax_percent_h'], $row_dp['shipping_fee'], $row_dp['shipping_fee_h'], $row_dp['normal_sale_rate'], $margin_rate_n, $exchange_rate, $exchange_rate_krw_cny, 0, $row_dp['g_uid'], $row_dp['sl_uid'], $row_dp['c_value'], $row_dp['site_code'], $row_dp['b_code'], 0, 0, $TMALL_MARGIN_UP_DOT_P, $is_yes_print, $tmall_get_p_type, $row_dp['is_fixed_price'], $row_dp['fixed_price_info']);//$tmall_get_p_type assign config.inc.php
									if($arr_margin_up_price_info['bf_selling_price']<$arr_dp_price_info['bf_selling_price']) $arr_margin_up_price_info['bf_selling_price']=$arr_dp_price_info['bf_selling_price'];
									if($arr_margin_up_price_info['sp_bf_selling_price']<$arr_dp_price_info['sp_bf_selling_price']) $arr_margin_up_price_info['sp_bf_selling_price']=$arr_dp_price_info['sp_bf_selling_price'];
									$arr_dp_price_info['bf_selling_price'] = $arr_margin_up_price_info['bf_selling_price'];
									$arr_dp_price_info['sp_bf_selling_price'] = $arr_margin_up_price_info['sp_bf_selling_price'];
									unset($arr_margin_up_price_info);
									/*
									$arr_dp_price_info['bf_selling_price'] = ceil($arr_dp_price_info['bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
									$arr_dp_price_info['sp_bf_selling_price'] = ceil($arr_dp_price_info['sp_bf_selling_price']*$TMALL_MARGIN_UP_DOT_P);
									*/
								}
								
								$db_dp_last_paid_max_price = $row_dp['last_paid_max_price'];
								if($db_dp_last_paid_max_price>0 && $arr_dp_price_info['sp_bf_selling_price']<$db_dp_last_paid_max_price)
								{
									$arr_dp_price_info['sp_bf_selling_price'] = $db_dp_last_paid_max_price;
								}
							}
							
							if($arr_dp_price_info['bf_selling_price'] < $arr_dp_price_info['sp_bf_selling_price'])
							{
								$arr_dp_price_info['bf_selling_price'] = $arr_dp_price_info['sp_bf_selling_price'];
								$arr_dp_price_info['sp_bf_str'] = "";
							}
							$dp_now_is_sale = 0;
							if($arr_dp_price_info['sp_bf_str'])
							{
								//$dp_title = "【特惠】 ".$dp_title;
								$dp_title = "【特惠】".$dp_title;
								//$dp_title = "[特惠] ".$dp_title;
								$dp_now_is_sale = 1;
							}
							
							if($row_dp['isAvailable']>0 && $tmall_no_sale_soldout_g_cost_usd>0)//$tmall_no_sale_soldout_g_cost_usd assign tmall/config.inc.php
							{
								$arr_tmall_skip_vars = array(
									'is_no_need_continue'=>1,
									'tmall_no_sale_soldout_g_cost_usd'=>$tmall_no_sale_soldout_g_cost_usd,
									'g_cost'=>$row_dp['g_cost'],
									'g_cost_h'=>$row_dp['g_cost_h'],
									'c_value'=>$row_dp['c_value'],
									'now_is_sale'=>$dp_now_is_sale,
									'is_yes_print'=>$is_yes_print
								);
								$arr_tmall_skip_result = func_tmall_img_skip_OR_no_isAvailable($arr_tmall_skip_vars);
								unset($arr_tmall_skip_vars);
								if($arr_tmall_skip_result['is_skip'] > 0)
								{
									$row_dp['isAvailable'] = 0;
								}
								unset($arr_tmall_skip_result);
							}
							
							$dp_soldout_str = "";
							$db_price_color = "#b70032";
							if($row_dp['isAvailable']<2 || $row_dp['isSoldout']>0)
							{
								$dp_soldout_str = "<div style=\"text-align:left;margin-top:5px;font-weight:bold;color:#d27e93;\">抱歉，该商品无货 - Sorry, this item is not available.</div>";
								$db_price_color = "#57584f";
							}
							
							$dp_price_str = "<strong style=\"color:{$db_price_color};\">".number_format($arr_dp_price_info['sp_bf_selling_price'])."元</strong>";
							if(($arr_dp_price_info['sp_bf_str']) && ($arr_dp_price_info['bf_selling_price']>$arr_dp_price_info['sp_bf_selling_price']))//now_sale
							{
								$dp_price_str = "<span style=\"text-decoration:line-through;margin-right:13px;color:#57584f;\">".number_format($arr_dp_price_info['bf_selling_price'])."元</span><strong style=\"color:{$db_price_color};\">".number_format($arr_dp_price_info['sp_bf_selling_price'])."元</strong>";
							}
							
							$row_dp['g_info'] = g_info_str_replace($row_dp['g_info'], $row_dp['site_code']);
							
							if($row_dp['color_ct'] > 1)
							{
								$more_colors_str = " &nbsp;<img src='http://img.alicdn.com/imgextra/i1/1706222708/T2TxsVXdNaXXXXXXXX_!!1706222708.jpg' alt='更多颜色' />";
							}
							else
							{
								$more_colors_str = "";
							}
	
							//http://detail.tmall.hk/hk/item.htm?id=26948984179
							$dp_html_str .= "
								<div style=\"width:750px;text-align:center;overflow:hidden;margin-top:30px;color:#57584f;\">
									<ul style='overflow:hidden;width:750px;margin:0 auto;padding:10px 0 0 10px;text-align:left;border-top:2px solid #585858;'>
										<li style=\"float:left;\">
											<a href=\"http://detail.tmall.com/item.htm?id={$row_dp['num_iid']}\" target=\"_blank\"><img src=\"{$full_s_img}\" alt=\"{$row_dp['b_name']}\" border=\"0\" /></a>
										</li>
										<li style=\"float:left;margin-left:20px;\">
											<div style=\"text-align:left;font-weight:bold;\"><a href=\"http://detail.tmall.com/item.htm?id={$row_dp['num_iid']}\" style=\"color:#57584f;text-decoration:none;\" target=\"_blank\">{$dp_title}{$more_colors_str}</a></div>
											<div style=\"text-align:left;margin-top:3px;\"><a href=\"http://detail.tmall.com/item.htm?id={$row_dp['num_iid']}\" style=\"color:#57584f;text-decoration:none;\" target=\"_blank\">价格 : {$dp_price_str}</a></div>
											{$dp_soldout_str}
											<div style=\"width:520px;margin-top:10px;\">
												<p style=\"text-align:left;padding:0 0 0 0px;\">
													{$row_dp['g_info']}
												</p>
											</div>
										</li>
									</ul>
								</div>
							";
						}
						unset($arr_dp_picture_info_g_uid);
					}
				}
			}
		}
		
		if($is_yes_print > 0)
		{
			echo "dp_html_str = ".$dp_html_str."\r\n";
		}
		/* DP list end */
		
		$add_title_str = "";
		if($row['real_g_title'])
		{
			if(count($ARR_PARTNER_ADD_TITLE_STR['tmall']) > 0)
			{
				$row['real_g_title'] = str_ireplace("&amp;","&",$row['real_g_title']);
				$row['real_g_title'] = preg_replace("/\s+/"," ",$row['real_g_title']);
				foreach($ARR_PARTNER_ADD_TITLE_STR['tmall'] AS $key_add_str=>$value_add_str)
				{
					if(preg_match("/{$key_add_str}/i", $row['real_g_title']))
					{
						$add_title_str = $value_add_str;
						break;
					}
				}
			}
		}
		$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str." ".$outer_id; // $send_box_test_str assign config.inc.php
		if($is_yes_print > 0)
		{
			echo "title - 1 = ".$title."\r\n";
		}	
		$title_len = mb_strlen($title, 'UTF-8');
		$max_title_len = $tmall_max_title_len;//$tmall_max_title_len assign schema_config.inc
		if($arr_title_max_len_cid[$cid])
		{
			$max_title_len = $arr_title_max_len_cid[$cid];
		}
		
		$is_title_b_name_replace = 0;
		if(count($arr_on_sale_title_b_name_replace_b_code) > 0)//$arr_on_sale_title_b_name_replace_b_code assign config.inc.php 이값은 세일문자가 들어가는경우 영문브랜드명만 사용하기 위함.
		{
			if($add_on_sale_g_title)
			{
				$is_title_b_name_replace = 1;
			}
		}
		$title_byte_len = strlen($title);
		$is_already_max_title_byte_len = 0;
		$is_already_title_b_name = 0;
		$is_already_title_outer_id = 0;
		if($title_byte_len>$tmall_max_title_byte_len || $is_title_b_name_replace>0 || $add_title_str)//$tmall_max_title_byte_len assign schema_config.inc
		{
			$is_already_max_title_byte_len = 1;
			$arr_title_b_name = explode("/", $title_b_name);
			if(count($arr_title_b_name) > 1)
			{
				$title_b_name = trim($arr_title_b_name['0']);
				$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str." ".$outer_id; // $send_box_test_str assign config.inc.php
				$title_len = mb_strlen($title, 'UTF-8');
				$is_already_title_b_name = 1;
			}
			unset($arr_title_b_name);
			if($is_yes_print > 0)
			{
				echo "title - 2 = ".$title."\r\n";
			}
			if($title_len > $max_title_len)
			{
				$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str; // $send_box_test_str assign config.inc.php
				$is_already_title_outer_id = 1;
			}
			if($is_yes_print > 0)
			{
				echo "title - 3 = ".$title."\r\n";
			}
		}
		
		if($is_yes_print > 0)
		{
			echo "is_already_max_title_byte_len = ".$is_already_max_title_byte_len."\r\n";
			echo "is_already_title_b_name = ".$is_already_title_b_name."\r\n";
			echo "is_already_title_outer_id = ".$is_already_title_outer_id."\r\n";
		}
		if($title_len > $max_title_len)
		{
			if($is_already_title_b_name < 1)
			{
				$arr_title_b_name = explode("/", $title_b_name);
				if(count($arr_title_b_name) > 1)
				{
					$title_b_name = trim($arr_title_b_name['0']);
					$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str." ".$outer_id; // $send_box_test_str assign config.inc.php
					$title_len = mb_strlen($title, 'UTF-8');
				}
				unset($arr_title_b_name);
				if($is_yes_print > 0)
				{
					echo "title - 2 = ".$title."\r\n";
				}
			}
			if($is_already_title_outer_id < 1)
			{
				if($title_len > $max_title_len)
				{
					$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str; // $send_box_test_str assign config.inc.php
				}
				if($is_yes_print > 0)
				{
					echo "title - 3 = ".$title."\r\n";
				}
			}
		}
		
		if(in_array($b_code_t, $arr_no_color_title_b_code))
		{
		}
		else if($is_already_max_title_byte_len > 0)
		{
		}
		else
		{
			if(count($arr_color) == 1)
			{	
				$arr_temp_title = explode("^|^", $arr_color['0']);
				if($arr_temp_title['1']!='onecolor' && $arr_temp_title['1']!='nocolor')
				{
					$is_need_color_title = 1;
					if(count($arr_no_color_title_skip_str) > 0)//$arr_no_color_title_skip_str assign config.inc.php 칼라값중에 사용하지 못하는 문자가 있기때문에 이 문자가 포함되면 상품명에 칼라값을 포함 시키지 않는다.
					{
						foreach($arr_no_color_title_skip_str AS $no_color_title_skip_str)
						{
							if(preg_match("/{$no_color_title_skip_str}/i", $arr_temp_title['0']))
							{
								$is_need_color_title = 0;
							}	
						}
					}
					
					if(count($arr_on_sale_no_color_title_b_code)>0 && $add_on_sale_g_title)//$arr_on_sale_no_color_title_b_code assign config.inc.php 이값은 세일문자열값이 들어갈경우만 처리해줌
					{
						if(in_array($b_code_t, $arr_on_sale_no_color_title_b_code))
						{
							$is_need_color_title = 0;
						}
					}
					
					if($is_need_color_title > 0)
					{
						//$title = $send_box_test_str.$title_b_name." ".$row['g_title_cn']." ".$arr_temp_title['0']." ".$outer_id; // $send_box_test_str assign config.inc.php
						$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str." ".$outer_id." ".$arr_temp_title['0'];
						$color_len = mb_strlen($arr_temp_title['0'], 'UTF-8');
						$title_len = mb_strlen($title, 'UTF-8');
						if($title_len > $max_title_len)
						{
							$arr_title_b_name = explode("/", $title_b_name);
							if(count($arr_title_b_name) > 1)
							{
								$title_b_name = trim($arr_title_b_name['0']);
								$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str." ".$outer_id." ".$arr_temp_title['0'];
								$title_len = mb_strlen($title, 'UTF-8');
							}
							unset($arr_title_b_name);
							if($is_yes_print > 0)
							{
								echo "title - 4 = ".$title."\r\n";
							}
						}
						
						$max_color_len = 9;
						if($add_on_sale_g_title)
						{
							$max_color_len = 6;
						}
						$title_byte_len = strlen($title);
						if($title_len>$max_title_len || $color_len>$max_color_len || $title_byte_len>$tmall_max_title_byte_len)
						{
							//$title = $send_box_test_str.$title_b_name." ".$row['g_title_cn']." ".$arr_temp_title['0']; // $send_box_test_str assign config.inc.php
							$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str." ".$outer_id; 
							$title_len = mb_strlen($title, 'UTF-8');
							if($title_len > $max_title_len)
							{
								$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str; // $send_box_test_str assign config.inc.php
							}
							if($is_yes_print > 0)
							{
								echo "title - 5 = ".$title."\r\n";
							}
						}
					}
				}
			}
		}
		
		if(count($arr_on_sale_no_pid_title_b_code)>0 && $add_on_sale_g_title)//$arr_on_sale_no_pid_title_b_code assign config.inc.php 이값은 세일문자열값이 들어갈경우만 처리해줌
		{
			if(in_array($b_code_t, $arr_on_sale_no_pid_title_b_code))
			{
				$title = $send_box_test_str.$add_on_sale_g_title.$title_b_name." ".$row['g_title_cn'].$add_title_str; // $send_box_test_str assign config.inc.php
			}
		}
		
		/* 1dept : tmall- props, sku_props start */
		$arr_required_props = array();
		$props = "";
		$property_alias = "";
		$arr_property_alias = array();
		$arr_input_info = array();
		if(!in_array($cid, $arr_no_need_id_prop_cid))
		{
			if(!in_array($cid, $arr_no_need_id_schema_prop_cid))
			{
				if($arr_other_pid_cid[$cid])
				{
					$pid_num_str = $arr_other_pid_cid[$cid];
				}
				else
				{
					$pid_num_str = $default_product_num_pid;
				}
				$arr_input_info[] = "{$pid_num_str}:{$outer_id}";//상품번호
			}
		}
		if($arr_cid_leather_material_input[$cid])//$arr_cid_leather_material_input assign config.inc.php
		{
			$arr_input_info[] = $arr_cid_leather_material_input[$cid];
		}
		
		$seller_cids = "";
		$arr_seller_cids = array();
		if($scid)
		{
			$arr_seller_cids[] = $scid;
		}
		if($arr_tmall_b_code_scid[$row['b_code']])
		{
			$arr_seller_cids[] = $arr_tmall_b_code_scid[$row['b_code']];
		}
		//print_r($arr_seller_cids);
		/*
		if($arr_tmall_c1_scid[$parent_c1])
		{
			$arr_seller_cids[] = $arr_tmall_c1_scid[$parent_c1];
		}
		*/
		$t_sku_count = 0;
		
		if($ARR_G_UID_TMALL_STATIC_PROP[$row['g_uid']])//$ARR_G_UID_TMALL_STATIC_PROP assign config.inc.php
		{
			$props = $ARR_G_UID_TMALL_STATIC_PROP[$row['g_uid']];
		}
		else if($ARR_CID_TMALL_STATIC_PROP[$cid])//$ARR_CID_TMALL_STATIC_PROP assign config.inc.php
		{
			$props = $ARR_CID_TMALL_STATIC_PROP[$cid];
		}
		else if($row['is_prop'] > 0)
		{
			$query_ei = "SELECT props, property_alias FROM {$tmall_db}.tmall_goods_category_props_match WHERE c_code={$row['c_code']}";
			$result_ei = dbQuery($query_ei,$dbconn);
			$row_ei = mysql_fetch_assoc($result_ei);
			if($row_ei['props'])
			{
				$props = trim($row_ei['props']);
				$row_ei['property_alias'] = trim($row_ei['property_alias']);
				if($row_ei['property_alias'])
				{
					$arr_temp_property_alias = explode(";",$row_ei['property_alias']);
					$arr_new_property_alias = array();
					foreach($arr_temp_property_alias AS $temp_property_alias)
					{
						$arr_loop_temp  = explode(":",$row_ei['property_alias']);
						$loop_idx = 0;
						foreach($arr_loop_temp AS $loop_value)
						{
							$loop_value = trim($loop_value);
							if(!$loop_value) continue;
							$loop_idx++;
						}
						if($loop_idx == 3)
						{
							$arr_new_property_alias[] = $row_ei['property_alias'];
						}
					}
					
					if(count($arr_new_property_alias) > 0)
					{
						$db_property_alias = implode(";", $arr_new_property_alias);
						$arr_property_alias[] = $db_property_alias;
					}
				}
			}
			else
			{
				dbClose($dbconn);
				$arr_err_info[$g_uid][] = "props_err, cid={$cid}, {$err_default_str}";
				$arr_err_cid[$g_uid] = $cid;
				$check_err_num++;
				continue;
			}
		}
		
		if(count($arr_api_return_value[$g_uid]['arr_sku']) > 0)
		{
			$now_tmall_sku_count = count($arr_api_return_value[$g_uid]['arr_sku']);
		}
		else
		{
			$now_tmall_sku_count = 0;
		}
		if($is_yes_print > 0)
		{
			echo "now_tmall_sku_count={$now_tmall_sku_count}\r\n";
		}
		
		/* 2dept : sku_props start */	
		$arr_var_update_sku_props = array(
			'num_iid'=>$num_iid,
			'cid'=>$cid,
			'arr_size'=>$arr_size,
			'arr_ori_color_str'=>$arr_ori_color_str,
			'init_stock_num'=>$loop_init_stock_num,
			'dbconn'=>$dbconn,
			'now_tmall_sku_count'=>$now_tmall_sku_count,
			'is_schema'=>1
		);
		//print_r($arr_var_update_sku_props);
		$arr_sku_update_props_result = func_tmall_get_update_sku_info($arr_var_update_sku_props);
		if($is_yes_print > 0)
		{
			echo "arr_sku_update_props_result=\r\n";
			print_r($arr_sku_update_props_result);
		}
		if(count($arr_sku_update_props_result['arr_check_info']) > 0)
		{
			foreach($arr_sku_update_props_result['arr_check_info'] AS $check_info)
			{
				$arr_check_info[$g_uid][] = $check_info;
			}
		}
		if($arr_sku_update_props_result['result'] < 1)
		{
			dbClose($dbconn);
			$arr_err_info[$g_uid][] = "{$err_default_str} : ".$arr_sku_update_props_result['err'];
			$arr_err_cid[$g_uid] = $cid;
			$check_err_num++;
			unset($arr_sku_update_props_result);
			continue;
		}
		$arr_sku_id = array();
		$arr_sku_id = $arr_sku_update_props_result['arr_sku_id'];
		$arr_del_sku_properties = array();
		$arr_del_sku_properties = $arr_sku_update_props_result['arr_del_sku_properties'];
		$arr_add_sku_property = array();
		$arr_add_sku_property = $arr_sku_update_props_result['arr_add_sku_property'];
		$arr_add_sku_alias_value = array();
		$arr_add_sku_alias_value = $arr_sku_update_props_result['arr_add_sku_alias_value'];
		$arr_add_color_property = array();
		$arr_add_color_property = $arr_sku_update_props_result['arr_add_color_property'];//추후에 추가된 칼라이미지 가져올때 이용할 것 
		$arr_sku_props = array();
		$arr_sku_props = $arr_sku_update_props_result['arr_sku_props'];
		/*
	$arr_required_props = array_merge($arr_required_props, $arr_sku_props);
		$arr_required_props = array_unique($arr_required_props);
	*/
		$arr_db_was_property_alias = array();
		$arr_db_was_property_alias = $arr_sku_update_props_result['arr_db_was_property_alias'];//schema로 넘어오면서 사용하지 않음.
		$is_need_sku_insert_db = 0;
		if(count($arr_db_was_property_alias) < 1)
		{
			if(count($arr_sku_update_props_result['arr_add_property_alias']) > 0)
			{
				$arr_db_was_property_alias = $arr_sku_update_props_result['arr_add_property_alias'];
				unset($arr_sku_update_props_result['arr_add_property_alias']);
				$is_need_sku_insert_db = 1;
			}
		}
		
		$arr_add_property_alias = array();
		$arr_add_property_alias = $arr_sku_update_props_result['arr_add_property_alias'];
		if(count($arr_add_property_alias) > 0)
		{
			$arr_new_db_was_property_alias = array();
			foreach($arr_db_was_property_alias AS $db_was_property_alias)
			{
				$db_was_property_alias = @trim($db_was_property_alias);
				if(!$db_was_property_alias) continue;
				$arr_loop_db_was_property_alias = explode(":", $db_was_property_alias);
				$new_db_was_pv = $arr_loop_db_was_property_alias['0'].":".$arr_loop_db_was_property_alias['1'];
				foreach($arr_add_property_alias AS $add_property_alias)
				{
					$add_property_alias = @trim($add_property_alias);
					if(!$add_property_alias) continue;
					$arr_loop_add_property_alias = explode(":", $add_property_alias);
					$new_add_pv = $arr_loop_add_property_alias['0'].":".$arr_loop_add_property_alias['1'];
					if($new_db_was_pv == $new_add_pv)
					{
						$db_was_property_alias = $add_property_alias;
						break;
					}
				}
				$arr_new_db_was_property_alias[] = $db_was_property_alias;
			}
			if(count($arr_new_db_was_property_alias) > 0)
			{
				$arr_db_was_property_alias = array_merge($arr_new_db_was_property_alias, $arr_add_property_alias);
				$arr_db_was_property_alias = array_unique($arr_db_was_property_alias);
				unset($arr_new_db_was_property_alias);
			}
		}
		$arr_now_ori_size = $arr_sku_update_props_result['arr_now_ori_size'];
		$arr_color_img_props = array();
		$arr_size_props = array();
		if($is_yes_print > 0)
		{
			echo "arr_db_was_property_alias=\r\n";
			print_r($arr_db_was_property_alias);
		}
		if(count($arr_db_was_property_alias) > 0)
		{
			if($is_need_sku_insert_db > 0)//tmall_item_skus 테이블에 sku하나도 없는경우가 있어 한개값을 새로 인서트 처리한다.
			{
				if(count($arr_api_return_value[$g_uid]['arr_sku']) > 0)
				{
					$new_sku_id = $arr_api_return_value[$g_uid]['arr_sku']['0']['sku_id'];
					$new_sku_properties = $arr_api_return_value[$g_uid]['arr_sku']['0']['properties'];
					$new_sku_outer_id = $arr_api_return_value[$g_uid]['arr_sku']['0']['outer_id'];
					$arr_new_skus_alias_str = array();
					$arr_new_sku_alias_value = explode(";", $arr_api_return_value[$g_uid]['arr_sku']['0']['properties_name']);
					if($arr_new_sku_alias_value['0'])//color
					{
						$arr_new_sku_color_alias_value = explode(":", $arr_new_sku_alias_value['0']);
						$last_new_sku_color_idx = count($arr_new_sku_color_alias_value)-1;
						$arr_new_skus_alias_str[] = $arr_new_sku_color_alias_value[$last_new_sku_color_idx];
						unset($arr_new_sku_color_alias_value);
					}
					if($arr_new_sku_alias_value['1'])//size
					{
						$arr_new_sku_size_alias_value = explode(":", $arr_new_sku_alias_value['1']);
						$last_new_sku_size_idx = count($arr_new_sku_size_alias_value)-1;
						$arr_new_skus_alias_str[] = $arr_new_sku_size_alias_value[$last_new_sku_size_idx];
						unset($arr_new_sku_size_alias_value);
					}
					unset($arr_new_sku_alias_value);
					$new_skus_alias_str = "";
					if(count($arr_new_skus_alias_str) > 0)
					{
						$new_skus_alias_str = implode(";",$arr_new_skus_alias_str);
					}
					$query_ei = "INSERT INTO {$tmall_db}.tmall_item_skus (sku_id,num_iid,g_uid,sku_price,sku_quantity,sku_properties,sku_alias_value,sku_outer_id) VALUES ('{$new_sku_id}','{$num_iid}',{$g_uid},{$arr_price_info['sp_bf_selling_price']},{$loop_init_stock_num},'{$new_sku_properties}','{$new_skus_alias_str}','{$new_sku_outer_id}')";
					if($is_yes_print > 0)
					{
						echo $query_ei."\r\n";
					}
					dbQuery($query_ei,$dbconn);
				}
			}
			
			$query_ei = "UPDATE {$tmall_db}.tmall_item_info_prop SET property_alias='".implode(";",$arr_db_was_property_alias)."' WHERE num_iid='{$num_iid}'";
			dbQuery($query_ei, $dbconn);
			if($is_yes_print > 0)
			{
				echo $query_ei."\r\n";
			}
			
			foreach($arr_db_was_property_alias AS $temp_colorNsize_props)
			{
				$temp_colorNsize_props = trim($temp_colorNsize_props);
				if(!$temp_colorNsize_props) continue;
				$arr_temp_colorNsize_props = explode(":", $temp_colorNsize_props);
				$no_s_temp_colorNsize_props = strtolower(func_tmall_str_no_space($arr_temp_colorNsize_props['2'], 1));
				foreach($arr_color AS $temp_color_str)
				{
					$temp_color_str = trim($temp_color_str);
					if(!$temp_color_str) continue;
					$arr_temp_color_str = explode("^|^", $temp_color_str);
					$no_s_temp_color_str = $arr_temp_color_str['1'];
					if($is_yes_print > 0)
					{
						echo "1 - {$no_s_temp_colorNsize_props}={$no_s_temp_color_str}\r\n";
					}
					if($no_s_temp_colorNsize_props == $no_s_temp_color_str)
					{
						$v_color_img_props = $arr_temp_colorNsize_props['0'].":".$arr_temp_colorNsize_props['1'];
						if(in_array($v_color_img_props, $arr_color_img_props))
						{
							continue;
						}
						if($is_yes_print > 0)
						{
							echo "{$no_s_temp_colorNsize_props}={$no_s_temp_color_str}\r\n";
						}
						$arr_color_img_props[$no_s_temp_color_str] = $v_color_img_props;
						break;
					}
				}
				foreach($arr_topdown['arr_merge_size'] AS $temp_size_str)
				{
					$temp_size_str = trim($temp_size_str);
					if(!$temp_size_str && $temp_size_str!='0') continue;
					$no_s_temp_size_str = strtolower(func_tmall_str_no_space($temp_size_str, 1));
					if($no_s_temp_colorNsize_props == $no_s_temp_size_str)
					{
						if(count($arr_onesize_replace_cid[$cid]) > 0)
						{
							foreach($arr_onesize_replace_cid[$cid] AS $key_onesize=>$value_onesize)
							{
								if($key_onesize == $no_s_temp_size_str)
								{
									$no_s_temp_size_str = strtolower($value_onesize);
									break;
								}
							}
						}
						
						$arr_size_props[$no_s_temp_size_str] = $arr_temp_colorNsize_props['0'].":".$arr_temp_colorNsize_props['1'];
						break;
					}
				}
			}
		}
		
		if($is_yes_print > 0)
		{
			echo "arr_color_img_props=\r\n";
			print_r($arr_color_img_props);
			echo "arr_size_props=\r\n";
			print_r($arr_size_props);
		}
		if(count($arr_color_img_props) < 1)
		{
			$is_loop_img_change = 0;
		}
		
		$arr_property_alias = array_merge($arr_property_alias, $arr_db_was_property_alias);
		$arr_property_alias = array_unique($arr_property_alias);	
		$next_sku_outer_id_num = $arr_sku_update_props_result['next_sku_outer_id_num'];
		$is_topdown_changed = $arr_sku_update_props_result['is_topdown_changed'];
		$t_sku_count = $arr_sku_update_props_result['t_sku_count'];
		$arr_sku_quantity = $arr_sku_update_props_result['arr_sku_quantity'];
		$arr_reset_sku_quantity_sku_id = $arr_sku_update_props_result['arr_reset_sku_quantity_sku_id'];
		$is_sku_quantity_change = 0;
		if(count($arr_reset_sku_quantity_sku_id) > 0)
		{
			$is_sku_quantity_change = 1;
		}
		
		$count_sku_barcode = count($arr_sku_update_props_result['arr_sku_id']) + count($arr_sku_update_props_result['arr_add_sku_property']) - count($arr_sku_update_props_result['arr_del_sku_properties']);
		$arr_sku_barcode = array();
		$sku_barcode = "";
		if($count_sku_barcode > 0)
		{
			for($i_sku_barcode=0; $i_sku_barcode<$count_sku_barcode; $i_sku_barcode++)
			{
				$arr_sku_barcode[] = "0000000000000";
			}
			if(count($arr_sku_barcode) > 0)
			{
				$sku_barcode = implode(",",$arr_sku_barcode);
				unset($arr_sku_barcode);	
			}
		}
		
		unset($arr_sku_update_props_result);
		
		if(count($arr_sku_props) < 1)
		{
			$arr_err_info[$g_uid][] = "{$err_default_str} : arr_sku_props count zero err";
			$arr_err_cid[$g_uid] = $cid;
			continue;
		}
		
		if($row['isAvailable']>0 && $is_no_soldout_goods<1)
		{
			$arr_tmall_skip_vars = array(
				'is_no_need_continue'=>1,
				'b_code'=>$b_code_t,
				'is_yes_print'=>$is_yes_print
			);
			$arr_tmall_skip_result = func_tmall_img_skip_OR_no_isAvailable($arr_tmall_skip_vars);
			unset($arr_tmall_skip_vars);
			if($arr_tmall_skip_result['is_skip'] > 0)
			{
				$row['isAvailable'] = 0;
			}
			unset($arr_tmall_skip_result);
		}
		
		/* 2dept : sku_props end */
		/* 2dept : props start */
		//Required props props = brand, price, Required or Optional sku_props = color/size값인데 onecolor, onesize를 제외하고는 값을 무조건 채운다. 
		/* 3dept : Required props start */
		/* 4dept : brand props start */
		$arr_var_brand_props = array(
			'b_code'=>$b_code_t,
			'b_name'=>$b_name,
			'search_en_b_name'=>$search_en_b_name,
			'parent_cid'=>$row['parent_cid'],
			'cid'=>$cid,
			'c_code'=>$c_code,
			'outer_id'=>$outer_id,
			'g_uid'=>$g_uid,
			'dbconn'=>$dbconn,
			'search_no_urlencode'=>$search_no_urlencode,
			'is_need_tmall_b_code'=>0
		);
		if($is_yes_print > 0)
		{
			print_r($arr_var_brand_props);
		}
		$arr_brand_props_result = func_tmall_get_props_brand($arr_var_brand_props);//array return value = result, err, props, customer_props
		if($is_yes_print > 0)
		{
			echo "arr_brand_props_result = \r\n";
			print_r($arr_brand_props_result);
		}
		if($arr_brand_props_result['result']<1 && $row['isAvailable']>1)
		{
			dbClose($dbconn);
			$arr_err_info[$g_uid][] = "{$err_default_str} : ".$arr_brand_props_result['err'];
			$arr_err_cid[$g_uid] = $cid;
			$check_err_num++;
			unset($arr_brand_props_result);
			continue;
		}
		if($arr_brand_props_result['props'])
		{
			$arr_required_props[] = $arr_brand_props_result['props'];
			if($arr_brand_props_result['customer_props'])
			{
				$arr_input_info[] = $arr_brand_props_result['customer_props'];
			}
		}
		else if($arr_brand_props_result['customer_props'])
		{
			$arr_input_info[] = $arr_brand_props_result['customer_props'];
		}
		$brand_story_html = "";
		$brand_story_uri = "";
		if($arr_brand_props_result['brand_story_html'])
		{
			$brand_story_html = $arr_brand_props_result['brand_story_html'];
			$brand_story_uri = $arr_brand_props_result['brand_story_uri'];
		}
		unset($arr_var_brand_props);
		unset($arr_brand_props_result);
		/* 4dept : brand props end */
	
		/* 4dept : price props start */
		if(!in_array($cid, $arr_no_need_price_props_cid))//$arr_no_need_price_props_cid assign config.inc.php
		{
			//echo "sp_bf_selling_price = ".$arr_price_info['sp_bf_selling_price']."\r\n";
			$arr_var_price_props = array(
				'cid'=>$cid,
				'sp_bf_selling_price'=>$arr_price_info['sp_bf_selling_price'],
				'dbconn'=>$dbconn
			);
			$arr_price_props_result = func_tmall_get_props_price($arr_var_price_props);//array return value = result, err, props, check_info
			//echo "func_tmall_get_props_price \r\n";
			//print_r($arr_price_props_result);
			if($arr_price_props_result['check_info'])
			{
				$arr_check_info[$g_uid][] = $arr_price_props_result['check_info'];
			}
			if($arr_price_props_result['result'] < 1)
			{
				dbClose($dbconn);
				$arr_err_info[$g_uid][] = "{$err_default_str} : ".$arr_price_props_result['err'];
				$arr_err_cid[$g_uid] = $cid;
				$check_err_num++;
				unset($arr_price_props_result);
				continue;
			}
			if($arr_price_props_result['props'])
			{
				$arr_required_props[] = $arr_price_props_result['props'];
			}
			unset($arr_var_price_props);
			unset($arr_price_props_result);
		}
		/* 4dept : price props end */
		
		//echo "props-1 = ".$props."\r\n";
		if($row['gender_prop'])
		{
			$arr_required_props[] = $row['gender_prop'];
		}
		
		$db_sku_market_y = "";
		$db_sku_market_m = "";
		$sku_market_season = "";
		$sku_market_start_date = "";
		$is_static_season = 0;
		if($arr_tmall_g_uid_base_date_value[$g_uid])//$arr_tmall_g_uid_base_date_value assign config.inc.php
		{
			$db_sku_markettime = $arr_tmall_g_uid_base_date_value[$g_uid];
			$is_static_season = 1;
		}
		if($db_sku_markettime)
		{
			$arr_db_sku_markettime = explode("-",$db_sku_markettime);
			$db_sku_market_y = $arr_db_sku_markettime['0'];
			$db_sku_market_m = $arr_db_sku_markettime['1'];
		}
		$temp_static_sku_markettime = "";
		$update_sku_markettime_q = "";
		if(count($arr_tmall_c_value_base_year_prop_value[$bf_c_value]) > 0)
		{
			$year_y_idx = date('Y');
			$year_m_idx = date('m');
			if($db_sku_market_y) $year_y_idx=$db_sku_market_y;
			if($db_sku_market_m) $year_m_idx=$db_sku_market_m;
			$query_ei = "SELECT season_year, season_str, pid, vid FROM {$tmall_db}.tmall_goods_c_value_base_each_year_prop WHERE c_value='{$bf_c_value}' AND season_year='{$year_y_idx}'";
			if($is_yes_print > 0)
			{
				echo $query_ei."\r\n";
			}
			$result_ei = dbQuery($query_ei,$dbconn);
			$row_ei = mysql_fetch_assoc($result_ei);
			if($row_ei['season_year'] && $row_ei['season_str'] && $row_ei['pid'] && $row_ei['vid'])
			{
				$arr_required_props[] = $row_ei['pid'].":".$row_ei['vid'];
				$sku_market_start_date = $row_ei['season_year']."-".$arr_tmall_4_season_start_date[$row_ei['season_str']];
				if($sku_market_start_date && $db_sku_markettime)
				{
					if($sku_market_start_date != $db_sku_markettime)
					{
						$db_sku_markettime = $sku_market_start_date;
						$update_sku_markettime_q = "UPDATE {$tmall_db}.tmall_item SET list_time='{$db_sku_markettime} 00:00:00' WHERE num_iid='{$num_iid}'";
					}
				}
			}
			else
			{
				if($arr_tmall_c_value_base_year_prop_value[$bf_c_value]['all'])
				{
					$arr_required_props[] = $arr_tmall_c_value_base_year_prop_value[$bf_c_value]['all'];
				}
				else
				{
					$arr_required_props[] = $arr_tmall_c_value_base_year_prop_value[$bf_c_value][$year_m_idx];
				}
				$sku_market_season = $arr_tmall_4_season_string[$year_m_idx];
				$sku_market_start_date = $arr_tmall_4_season_start_date[$sku_market_season];
				$sku_market_start_date = $year_y_idx."-".$sku_market_start_date;
				if($sku_market_start_date)
				{
					if($sku_market_start_date != $db_sku_markettime)
					{
						$db_sku_markettime = $sku_market_start_date;
						$update_sku_markettime_q = "UPDATE {$tmall_db}.tmall_item SET list_time='{$db_sku_markettime} 00:00:00' WHERE num_iid='{$num_iid}'";
					}
				}
				/*
if($arr_sku_markettime_c_value_base_date_value[$bf_c_value]['all'])
				{
					$temp_static_sku_markettime = $arr_sku_markettime_c_value_base_date_values[$bf_c_value]['all'];
				}
*/
			}
		}
		else if(count($arr_tmall_cid_base_year_prop_value[$cid]) > 0)
		{
			$year_y_idx = date('Y');
			$year_m_idx = date('m');
			if($db_sku_market_y) $year_y_idx=$db_sku_market_y;
			if($db_sku_market_m) $year_m_idx=$db_sku_market_m;
			$sku_market_season = $arr_tmall_4_season_string[$year_m_idx];
			if($is_static_season<1 && $sku_market_season=='summer' && in_array($cid, $arr_replace_summer_autumn_cid))
			{
				$sku_market_season = "autumn";
			}
			else if(($is_static_season<1) && ($sku_market_season=='spring'||$sku_market_season=='summer') && (in_array($cid, $arr_replace_ss_winter_cid)))
			{
				$sku_market_season = "winter";
			}
			else if(($is_static_season<1) && ($sku_market_season=='spring'||$sku_market_season=='summer'||$sku_market_season=='autumn') && (in_array($cid, $arr_replace_ssa_winter_cid)))
			{
				$sku_market_season = "winter";
			}
			else if(($is_static_season<1) && ($sku_market_season=='spring'||$sku_market_season=='autumn'||$sku_market_season=='winter') && (in_array($cid, $arr_replace_saw_summer_cid)))
			{
				$sku_market_season = "summer";
			}
			$sku_market_start_date = $arr_tmall_4_season_start_date[$sku_market_season];
			$season_key = $year_y_idx."_".$sku_market_season;
			$is_multi_season = 0;
			$db_season_key = "";
			$db_year_pid = "";
			$db_year_vid = "";
			if($sku_market_season=='spring' || $sku_market_season=='summer')
			{
				$multi_season_key = $year_y_idx."_ss";
				$query_ei = "SELECT season_key, pid, vid FROM {$tmall_db}.tmall_goods_cid_base_each_year_prop WHERE cid={$cid} AND season_key='{$multi_season_key}'";
			}
			else
			{
				$multi_season_key = $year_y_idx."_aw";
				$query_ei = "SELECT season_key, pid, vid FROM {$tmall_db}.tmall_goods_cid_base_each_year_prop WHERE cid={$cid} AND season_key='{$multi_season_key}'";
			}
			if($is_yes_print > 0)
			{
				echo $query_ei."\r\n";
			}
			$result_ei = dbQuery($query_ei,$dbconn);
			$row_ei = mysql_fetch_assoc($result_ei);
			if($row_ei['season_key'] && $row_ei['pid'] && $row_ei['vid'])
			{
				$is_multi_season = 1;
				$db_season_key = $row_ei['season_key'];
				$db_year_pid = $row_ei['pid'];
				$db_year_vid = $row_ei['vid'];
			}
			if($is_multi_season < 1)
			{
				$query_ei = "SELECT season_key, pid, vid FROM {$tmall_db}.tmall_goods_cid_base_each_year_prop WHERE cid={$cid} AND season_key='{$season_key}'";
				if($is_yes_print > 0)
				{
					echo $query_ei."\r\n";
				}
				$result_ei = dbQuery($query_ei,$dbconn);
				$row_ei = mysql_fetch_assoc($result_ei);
				if($row_ei['season_key'] && $row_ei['pid'] && $row_ei['vid'])
				{
					$db_season_key = $row_ei['season_key'];
					$db_year_pid = $row_ei['pid'];
					$db_year_vid = $row_ei['vid'];
				}
			}
			if($db_season_key && $db_year_pid && $db_year_vid)
			{
				$arr_required_props[] = $db_year_pid.":".$db_year_vid;
				$sku_market_start_date = $year_y_idx."-".$sku_market_start_date;
				if($sku_market_start_date)
				{
					if($sku_market_start_date != $db_sku_markettime)
					{
						$db_sku_markettime = $sku_market_start_date;
						$update_sku_markettime_q = "UPDATE {$tmall_db}.tmall_item SET list_time='{$db_sku_markettime} 00:00:00' WHERE num_iid='{$num_iid}'";
					}
				}
			}
			else
			{
				if($arr_tmall_cid_base_year_prop_value[$cid]['all'])
				{
					$arr_required_props[] = $arr_tmall_cid_base_year_prop_value[$cid]['all'];
				}
				else
				{
					$arr_required_props[] = $arr_tmall_cid_base_year_prop_value[$cid][$year_m_idx];
				}
				$sku_market_start_date = $year_y_idx."-".$sku_market_start_date;
				if($sku_market_start_date && $db_sku_markettime)
				{
					if($sku_market_start_date != $db_sku_markettime)
					{
						$db_sku_markettime = $sku_market_start_date;
						$update_sku_markettime_q = "UPDATE {$tmall_db}.tmall_item SET list_time='{$db_sku_markettime} 00:00:00' WHERE num_iid='{$num_iid}'";
					}
				}
				/*
if($arr_sku_markettime_cid_base_date_value[$cid]['all'])
				{
					$temp_static_sku_markettime = $arr_sku_markettime_cid_base_date_value[$cid]['all'];
				}
				else
				{
					$temp_static_sku_markettime = $arr_sku_markettime_cid_base_date_value[$cid][$year_m_idx];
				}
*/
			}
		}
		else if(in_array($cid, $arr_tmall_need_prop_year_cid))
		{
			$year_pid_month_idx = "1_".date('m');
			$arr_required_props[] = $arr_tmall_prop_year_month_pid_vid[$year_pid_month_idx];
		}
		else if(in_array($cid, $arr_tmall_need_prop_year_2_cid))
		{
			$year_pid_month_idx = "2_".date('m');
			$arr_required_props[] = $arr_tmall_prop_year_month_pid_vid[$year_pid_month_idx];
		}
		else if(in_array($cid, $arr_tmall_need_prop_year_3_cid))
		{
			$year_pid_month_idx = "3_".date('m');
			$arr_required_props[] = $arr_tmall_prop_year_month_pid_vid[$year_pid_month_idx];
		}
		else if(in_array($cid, $arr_tmall_change_need_prop_year_cid))
		{
			$year_pid_month_idx = "5_".date('m');
			$arr_required_props[] = $arr_tmall_prop_year_month_pid_vid[$year_pid_month_idx];
		}
		else if(in_array($cid, $arr_tmall_change_need_prop_year_3_cid))
		{
			$year_pid_month_idx = "6_".date('m');
			$arr_required_props[] = $arr_tmall_prop_year_month_pid_vid[$year_pid_month_idx];
		}
		else if(in_array($cid, $arr_tmall_need_prop_year_etc_cid))
		{
			$year_pid_month_idx = "1_etc";
			$arr_required_props[] = $arr_tmall_prop_year_month_pid_vid[$year_pid_month_idx];
		}
		if($db_sku_markettime)
		{
			unset($arr_db_sku_markettime);
		}
		if($update_sku_markettime_q)
		{
			dbQuery($update_sku_markettime_q,$dbconn);
			if($is_yes_print > 0)
			{
				echo $update_sku_markettime_q."\r\n";
			}
		}
			
		if($is_yes_print > 0)
		{
			echo "arr_required_props = \r\n";
			print_r($arr_required_props);
		}
		//print_r($arr_required_props);
		if(count($arr_required_props) > 0)
		{
			$arr_required_props = array_unique($arr_required_props);
			$required_props = implode(";",$arr_required_props);
			unset($arr_required_props);
			if($props)
			{
				$props = $props.";".$required_props;
			}
			else
			{
				$props = $required_props;
			}
		}
		if($temp_static_sku_markettime)	
		{
			$static_sku_markettime = $temp_static_sku_markettime;
		}
		else if($tmall_created_date)
		{
			if($tmall_created_term_day < 731)
			{
				$static_sku_markettime = $tmall_created_date;
			}
			else
			{
				$tmall_created_date = "";
				$static_sku_markettime = "";
			}
		}	
		
		$arr_schema_props = array();
		if($props)
		{
			$arr_temp_props = explode(";", $props);
			foreach($arr_temp_props AS $temp_props)
			{
				$temp_props = trim($temp_props);
				if(!$temp_props) continue;
				$arr_schema_props[] = $temp_props;
			}
			if(count($arr_schema_props) > 0)
			{
				$props = implode(";",$arr_schema_props);
			}
		}
		//echo "props-2 = ".$props."\r\n";
		
		if(in_array($cid, $arr_normal_price_cid))
		{
			$arr_input_info[] = "6103476:".$arr_price_info['bf_selling_price']."元";
		}
		if(in_array($cid, $arr_bra_add_input_cid))
		{
			#$arr_input_info[] = "122276391:无结果";//14.02.25 50880002->122276391
			$arr_input_info[] = "50876006:无结果";
			#$arr_input_info[] = "122276389:无结果";//14.02.25 50864024->122276389
			$arr_input_info[] = "50860007:无结果";
		}
		$arr_input_pids = array();
		$arr_input_str = array();
		if($is_yes_print > 0)
		{
			echo "arr_input_info=\r\n";
			print_r($arr_input_info);
		}
		foreach($arr_input_info AS $input_info)
		{
			$input_info = trim($input_info);
			if(!$input_info) continue;
			$arr_input_2_info = explode(":", $input_info);
			$arr_input_pids[] = trim($arr_input_2_info['0']);
			$input_2_str = trim($arr_input_2_info['2']);
			$input_3_str = trim($arr_input_2_info['3']);
			if($input_2_str && $input_3_str)
			{
				if($arr_static_brand_props_g_uid[$g_uid])
				{
					$arr_input_str[] = trim($arr_input_2_info['1']).";".$input_2_str.";".$input_3_str;
				}
				else if($row['cid']=='50012018' && $b_code_t=='37')// 箱包皮具/热销女包/男包 > 钱包卡套 > coach
				{
					$arr_input_str[] = trim($arr_input_2_info['1']).";".$input_2_str.";".$input_3_str;
				}
				else if($row['cid']=='50012010' || $row['cid']=='50012018')
				{
					$arr_input_str[] = trim($arr_input_2_info['1']);
				}
				else
				{
					$arr_input_str[] = trim($arr_input_2_info['1']).";".$input_2_str.";".$input_3_str;
				}
			}
			else
			{
				$arr_input_str[] = trim($arr_input_2_info['1']);
			}
		}
		
		$input_pids = implode(",",$arr_input_pids);
		$input_str = implode(",",$arr_input_str);
		if($is_yes_print > 0)
		{
			echo "input_pids = {$input_pids}\r\n";
			echo "input_str = {$input_str}\r\n";
		}
		/* 3dept : Required props end  */
		/* 2dept : props end */
		/* 1dept : tmall- props, sku_props end  */
		//exit;
		
		if(count($arr_property_alias) > 0)
		{
			foreach($arr_property_alias AS $barcode_property_alias)
			{
				$barcode_property_alias = trim($barcode_property_alias);
				if(!$barcode_property_alias) continue;
			}
			$property_alias = implode(";",$arr_property_alias);
			unset($arr_property_alias);
		}
		//echo "props = {$props}\r\n";
		//echo "property_alias = {$property_alias}\r\n";
		
		$now_is_sale = 0;
		
		if($search_no_urlencode > 0)
		{
		}
		else
		{
			$search_en_b_name = urlencode($search_en_b_name);
		}
		
		if($arr_detail_link_static_b_name[$b_code_t])
		{
			$link_b_name = $arr_detail_link_static_b_name[$b_code_t];
		}
		else
		{
			$link_b_name = $b_name;
		}
		$brand_linkNsale_price_str = "<a href=\"http://buyfine.tmall.com/search.htm?search=y&keyword=".$search_en_b_name."&scene=taobao_shop&orderType=newOn_desc\" target=\"_blank\"><u style=\"color:#585858;\"><strong>查看更多 {$link_b_name} 商品</strong></u></a><br /><br />";
		$wap_sale_price_str = "";
		$arr_schema_use_bf_sale_str = array();
		$schema_use_sp_bf_sale_rate_t_str = "";
		if(($arr_price_info['sp_bf_str']) && ($arr_price_info['bf_selling_price']>$arr_price_info['sp_bf_selling_price']))//now_sale
		{
			$now_is_sale = 1;
			//$arr_seller_cids[] = $tmall_sale_scid;
			
			$sp_bf_sale_price_t = $arr_price_info['bf_selling_price']-$arr_price_info['sp_bf_selling_price'];
			$sp_bf_sale_rate_t = ($sp_bf_sale_price_t/$arr_price_info['bf_selling_price'])*100;
			$sp_bf_sale_rate_t = (100-$sp_bf_sale_rate_t)/10;
			$sp_bf_sale_rate_t = round($sp_bf_sale_rate_t,1);
			
			if($sp_bf_sale_rate_t < 3.01)
			{
				$arr_seller_cids[] = $tmall_sale_70_over_scid;//三折以下
			}
			else if($sp_bf_sale_rate_t>3 && $sp_bf_sale_rate_t<5.01)
			{
				$arr_seller_cids[] = $tmall_sale_50_69_scid;//三折到五折
			}
			else
			{
				$arr_seller_cids[] = $tmall_sale_50_unser_scid;//五折以上
			}
			
			$schema_use_sp_bf_sale_rate_t_str = $sp_bf_sale_rate_t."折";
			$len_was_price = strlen($arr_price_info['bf_selling_price']);
			/*原价는 사용하지 못하는 문구임 그래서 17.08.03 09쯤 변경함 原价 문구가 관련된 변수는 = $arr_schema_use_bf_sale_str[$g_uid]['was_price_str'] 그래서 sale_rate_str 변경함
			if($len_was_price < 6)
			{
				$arr_schema_use_bf_sale_str[$g_uid]['was_price_str'] = $arr_price_info['bf_selling_price']."元";
			}
			else
			{
				$arr_schema_use_bf_sale_str[$g_uid]['sale_rate_str'] = $sp_bf_sale_rate_t."折";
			}
			*/
			$arr_schema_use_bf_sale_str[$g_uid]['sale_rate_str'] = $sp_bf_sale_rate_t."折";
			
			/* 			 
			$brand_linkNsale_price_str, $wap_sale_price_str 이 두변수에도 原价라는 문구가 들어감
			*/
			//$brand_linkNsale_price_str = $brand_linkNsale_price_str."<strong>特惠价格说明：</strong><br />该{$link_b_name} 商品原价为<strong style=\"color:#c56780;\">".number_format($arr_price_info['bf_selling_price'])."元</strong>，现在优惠<strong style=\"color:#c56780;\">".number_format($sp_bf_sale_price_t)."元</strong>（约<strong style=\"color:#c56780;\">".$sp_bf_sale_rate_t."折</strong>）后现价为<strong style=\"font-size:13px;color:#b8002f;\">".number_format($arr_price_info['sp_bf_selling_price'])."元</strong>。<br /><br />";
			//$wap_sale_price_str = "特惠价格说明：<br />该{$link_b_name} 商品原价为".number_format($arr_price_info['bf_selling_price'])."元，现在优惠".number_format($sp_bf_sale_price_t)."元（约".$sp_bf_sale_rate_t."折）后现价为".number_format($arr_price_info['sp_bf_selling_price'])."元。<br /><br />";
			$brand_linkNsale_price_str = $brand_linkNsale_price_str."<strong>特惠价格说明：</strong><br />该{$link_b_name} 商品yuan价<strong style=\"color:#c56780;\">".number_format($arr_price_info['bf_selling_price'])."元</strong>，现价<strong style=\"color:#b8002f;\">".number_format($arr_price_info['sp_bf_selling_price'])."元</strong>，现在优惠<strong style=\"color:#c56780;\">".number_format($sp_bf_sale_price_t)."元</strong>（约<strong style=\"color:#c56780;\">".$sp_bf_sale_rate_t."折</strong>）<br /><br />";
			$wap_sale_price_str = "特惠价格说明：<br />该{$link_b_name} 商品yuan价".number_format($arr_price_info['bf_selling_price'])."元，现在优惠".number_format($sp_bf_sale_price_t)."元（约".$sp_bf_sale_rate_t."折）后现价为".number_format($arr_price_info['sp_bf_selling_price'])."元。<br /><br />";
		}
		
		if($row['isAvailable']>0 && $tmall_no_sale_soldout_g_cost_usd>0 && $is_no_soldout_goods<1)//$tmall_no_sale_soldout_g_cost_usd assign tmall/config.inc.php
		{
			$arr_tmall_skip_vars = array(
				'is_no_need_continue'=>1,
				'tmall_no_sale_soldout_g_cost_usd'=>$tmall_no_sale_soldout_g_cost_usd,
				'g_cost'=>$row['g_cost'],
				'g_cost_h'=>$row['g_cost_h'],
				'c_value'=>$bf_c_value,
				'now_is_sale'=>$now_is_sale,
				'is_yes_print'=>$is_yes_print
			);
			$arr_tmall_skip_result = func_tmall_img_skip_OR_no_isAvailable($arr_tmall_skip_vars);
			unset($arr_tmall_skip_vars);
			if($arr_tmall_skip_result['is_skip'] > 0)
			{
				$row['isAvailable'] = 0;
			}
			unset($arr_tmall_skip_result);
		}
		
		//print_r($arr_seller_cids);
		if(count($arr_seller_cids) > 0)
		{
			$seller_cids = implode(",",$arr_seller_cids);
		}
		//echo "seller_cids = {$seller_cids}\r\n";
		//echo "price = {$arr_price_info['sp_bf_selling_price']}\r\n";
		if($is_yes_print > 0)
		{
			echo "title - 6 = {$title}\r\n";
		}
		//echo "isAvailable = {$row['isAvailable']}\r\n";
		//$title = str_cut($title,70,false);
		if($ARR_TMALL_STATIC_TITLE_INFO[$row['view_g_uid']])
		{
			$title = $ARR_TMALL_STATIC_TITLE_INFO[$row['view_g_uid']];
			if($b_code_t == '250294')//SSU
			{
				/*
if(!preg_match("/{$outer_id}/i", $title))
				{
					$title = $title." ".$outer_id;
				}
*/
			}
			//if($add_on_sale_g_title && $b_code_t!='250294')
			if($add_on_sale_g_title)
			{
				if(!preg_match("/{$add_on_sale_g_title}/i", $title))
				{
					$title = $add_on_sale_g_title.$title;
				}
			}
		}
		else if($b_code_t=='250293' && $row['real_g_title'])//Tonefine
		{
			$arr_view_g_title = explode("^^",$row['real_g_title']);
			$arr_view_g_title = explode("<br />",$arr_view_g_title['0']);
			$arr_view_g_title['0'] = str_ireplace("cashmere","",$arr_view_g_title['0']);
			if($g_uid=='9013858')
			{
				$arr_view_g_title['0'] = "秋冬新款中长款高领宽松时尚开叉女纯羊绒衫";
			}
			$title = @trim(preg_replace("/\s+/"," ",$arr_view_g_title['0']));//공백 2칸이상 1칸으로
			$title = "TONEFINE ".$arr_view_g_title['0'];
			if(!preg_match("/{$outer_id}/i", $title))
			{
				$title = $title." ".$outer_id;
			}
			unset($arr_view_g_title);
		}
		if($is_yes_print > 0)
		{
			echo "title - 7 = {$title}\r\n";
		}
		
		if(in_array($num_iid, $ARR_TMALL_ADD_STR_TITLE_NUMIID_1))
		{
			$title = $ADD_STR_TITLE_1.$title;
		}
		$title = str_ireplace("e-Gold", "e Gold", $title);
		if($is_yes_print > 0)
		{
			echo "title - 8 = {$title}\r\n";
		}
		
		dbClose($dbconn);
		if($row['isAvailable']>0  && $is_no_soldout_goods<1)
		{
			$arr_tmall_skip_vars = array(
				'is_no_need_continue'=>1,
				'site_code'=>$row['site_code'],
				'is_yes_print'=>$is_yes_print
			);
			$arr_tmall_skip_result = func_tmall_img_skip_OR_no_isAvailable($arr_tmall_skip_vars);
			unset($arr_tmall_skip_vars);
			$is_not_in_site_code_sold_out = 0;
			if($arr_tmall_skip_result['is_skip'] > 0)
			{
				$row['isAvailable'] = 0;
				$is_not_in_site_code_sold_out = 1;
			}
			unset($arr_tmall_skip_result);
		}
		if($row['isAvailable']>0 && $is_no_soldout_goods<1)
		{
			$no_s_g_info_str = "";
			if($row['g_info'])
			{
				$no_s_g_info_str = strip_tags(strtolower(func_str_no_space($row['g_info'],2)));
			}
			$arr_tmall_skip_vars = array(
				'is_no_need_continue'=>1,
				'g_uid'=>$g_uid,
				'cid'=>$row['cid'],
				'b_code'=>$b_code_t,
				'c_code'=>$row['c_code'],
				'arr_inactive_c_code'=>$arr_inactive_c_code,
				'arr_inactive_b_code'=>$arr_inactive_b_code,
				'no_s_g_info_str'=>$no_s_g_info_str,
				'is_yes_print'=>$is_yes_print
			);
			$arr_tmall_skip_result = func_tmall_img_skip_OR_no_isAvailable($arr_tmall_skip_vars);
			unset($arr_tmall_skip_vars);
			if($arr_tmall_skip_result['is_skip'] > 0)
			{
				$row['isAvailable'] = 0;
			}
			unset($arr_tmall_skip_result);
		}		
		/* func_tmall_img_skip_OR_no_isAvailable 대체
		if(count($arr_inactive_c_code) > 0)
		{
			if(in_array($c_code, $arr_inactive_c_code))
			{
				$row['isAvailable'] = 0;
			}
		}
		if($is_yes_print > 0)
		{
			echo "ARR_TMALL_NOT_IN_B_CODE \r\n";
			print_r($ARR_TMALL_NOT_IN_B_CODE);
		}
		if(count($ARR_TMALL_NOT_IN_B_CODE) > 0)
		{
			if(in_array($b_code_t, $ARR_TMALL_NOT_IN_B_CODE))
			{
				$row['isAvailable'] = 0;
			}
		}
		if($is_yes_print > 0)
		{
			echo "ARR_TMALL_NOT_IN_SITE_CODE \r\n";
			print_r($ARR_TMALL_NOT_IN_SITE_CODE);
		}
		$is_not_in_site_code_sold_out = 0;
		if(count($ARR_TMALL_NOT_IN_SITE_CODE) > 0)
		{
			if(in_array($row['site_code'], $ARR_TMALL_NOT_IN_SITE_CODE))
			{
				$row['isAvailable'] = 0;
				$is_not_in_site_code_sold_out = 1;
			}
		}
		if($is_yes_print > 0)
		{
			echo "ARR_TMALL_NOT_IN_CID \r\n";
			print_r($ARR_TMALL_NOT_IN_CID);
		}
		if(count($ARR_TMALL_NOT_IN_CID) > 0)
		{
			if(in_array($row['cid'], $ARR_TMALL_NOT_IN_CID))
			{
				$row['isAvailable'] = 0;
			}
		}
		if(count($ARR_TMALL_SOLDOUT_G_UID) > 0)
		{
			if(in_array($row['g_uid'], $ARR_TMALL_SOLDOUT_G_UID))
			{
				$row['isAvailable'] = 0;
			}
		}
		if(count($ARR_TMALL_NOT_USE_B_CODE_C_CODE[$b_code_t]) > 0)
		{
			if(in_array($c_code,$ARR_TMALL_NOT_USE_B_CODE_C_CODE[$b_code_t]))
			{
				$row['isAvailable'] = 0;
			}
		}
		if($row['isAvailable'] > 1)
		{
			if(count($ARR_TMALL_B_CODE_G_INFO_SKIP_STR[$b_code_t]) > 0)
			{
				$no_s_g_info_str = strtolower(func_str_no_space($row['g_info'],2));
				if($no_s_g_info_str)
				{
					foreach($ARR_TMALL_B_CODE_G_INFO_SKIP_STR[$b_code_t] AS $skip_g_info_str)
					{
						if(preg_match("/{$skip_g_info_str}/i", $no_s_g_info_str))
						{
							$row['isAvailable'] = 0;
							break;
						}
					}
				}
			}
		}
		*/
		if($is_yes_print > 0)
		{
			echo "isAvailable-1 = ".$row['isAvailable']."\r\n";
		}
		
		if($row['isAvailable'] < 2)
		{
			$is_loop_img_change = 0;
			$is_just_need_vertical_img = 0;
			$is_just_need_white_bg_img = 0;
			$is_check_just_proc_img = 0;
		}
		
		if(count($ARR_TMALL_TEMP_NOT_IN_SITE_CODE) > 0) // $ARR_TMALL_TEMP_NOT_IN_SITE_CODE assign COMM_FUNC.inc 이 변수는 일시적으로 소스사이트에서 이미지를 못가져오는 경우 이 변수에 site_code를 추가해 준다
		{
			if(in_array($row['site_code'], $ARR_TMALL_TEMP_NOT_IN_SITE_CODE))
			{
				$is_loop_img_change = 0;
				$is_just_need_vertical_img = 0;
				$is_just_need_white_bg_img = 0;
				$is_check_just_proc_img = 0;
			}
		}
		
		$color_img_list = "";
		$now_color_img_list = "";
		$pic_url = "";
		$arr_item_stillcut_overlap_idx = array();
		if($is_loop_img_change>0 || $is_just_need_vertical_img>0 || $is_just_need_white_bg_img>0)
		{
			$color_img_list = $row['color_img_list']; //BLACK~~0***SABLE~~1
			$now_color_img_list = $color_img_list;
			
			$is_auto_bg_copy = 0;
			$is_no_lasso = 0;
			if(in_array($row['site_code'], $ARR_LASSO_IMG_IN_SITE_CODE))
			{
				$is_no_lasso = 0;
				$is_auto_bg_copy = 1;	
			}
			
			if($is_auto_bg_copy == 1)
			{
				foreach($ARR_SKIP_AUTO_BG_COPY_C_VALUE AS $skip_auto_bg_copy_c_value)// ARR_SKIP_AUTO_BG_COPY_C_VALUE assign COMM_FUNC.inc
				{
					$skip_auto_bg_copy_count = substr_count($row['c_value'], $skip_auto_bg_copy_c_value); 
					if($skip_auto_bg_copy_count > 0)
					{
						$is_auto_bg_copy = 0;
						break;
					}
				}
			}
			
			if($is_root_auto_bg_copy < 1)
			{
				$is_auto_bg_copy = 0;
			}
			
			if(in_array($row['g_uid'], $arr_bf_img_use_g_uid))
			{
				$is_bf_image_use = 1;
			}
			else
			{
				$is_bf_image_use = 0;
			}	
			
			$img_view_g_uid = $row['view_g_uid'];
			if($row['sl_uid']=='0' && $is_static_img_info<1)
			{
				$is_bf_image_use = 1;
				$img_view_g_uid = $row['g_uid'];
			}
			
			$echo_print = 0;
			if($is_yes_print > 0)
			{
				$echo_print = 1;
			}
			
			$arr_ss_var = array(
				'site_code'=>$row['site_code'],
				'sl_uid'=>$row['sl_uid'],
				'view_g_uid'=>$img_view_g_uid,
				'colorStr'=>$row['colorinfo'],
				'color_img_list'=>$color_img_list,
				'arr_color'=>$arr_color,
				'is_bf_image_use'=>$is_bf_image_use,
				'c_value'=>$row['c_value'],
				'stillStr'=>$row['stillinfo'],
				'still_img_list'=>$row['still_img_list'],
				'img_cache_num'=>$row['img_cache_num'],
				'img_host'=>$row['img_host'],
				'is_just_last_use_still'=>1,
				'is_static_img_info'=>$is_static_img_info,
				'dbconn'=>'',
				'echo_print'=>$echo_print,
				'is_need_trick_img'=>1
			);
			//print_r($arr_ss_var);
			$arr_ss_color_each_img = func_get_ss_color_each_img($arr_ss_var);
			if($is_yes_print > 0)
			{
				echo "func_get_ss_color_each_img = ";
				print_r($arr_ss_var);
				print_r($arr_ss_color_each_img);
			}
			$major_color = $arr_ss_color_each_img['major_color'];
			$major_no_s_color = strtolower(func_tmall_str_no_space($major_color, 1));
			if($major_no_s_color == 'null')
			{
				$major_color = "One Color";
				$major_no_s_color = "onecolor";
			}
			$major_img = $arr_ss_color_each_img['major_img'];
			$arr_match_img = $arr_ss_color_each_img['arr_match_img'];
			$color_count = count($arr_match_img);
			$arr_last_use_still_img = $arr_ss_color_each_img['arr_last_use_still_img'];
			$img_type = $arr_ss_color_each_img['img_type'];
			
			$arr_img_url_or_byte = array();
			$arr_vertical_img_loc = array();
			$arr_white_bg_img_loc = array();
			if($img_type>0 && $major_img) 
			{
				if($is_yes_print > 0)
				{
					echo "arr_color_img_props = ";
					print_r($arr_color_img_props);
					echo "arr_ss_color_each_img = ";
					print_r($arr_ss_color_each_img);
				}
				$arr_propimg_uri = func_tmall_get_propimg_uri($arr_color_img_props, $arr_ss_color_each_img, $row['site_code'], $is_loop_img_change, 1);
				//echo("<pre>");print_r($arr_propimg_uri);echo("</pre>");
				$img_api_type = "";
				if($arr_propimg_uri['img_api_type'])
				{
					$img_api_type = $arr_propimg_uri['img_api_type'];
				}
				else
				{
					$arr_err_info[$g_uid][] = "{$err_default_str} : img_api_type null err";
					$arr_err_cid[$g_uid] = $cid;
					continue;
				}
				$arr_merge_img = array();
				if(count($arr_propimg_uri['arr_propimg_or_img']) > 0)
				{
					$arr_merge_img = $arr_propimg_uri['arr_propimg_or_img'];
				}
				if($arr_propimg_uri['check_info'])
				{
					$arr_check_info[$g_uid][] = "cid={$cid} ".$arr_propimg_uri['check_info'];
				}
				if($is_yes_print > 0)
				{
					echo "func_tmall_get_propimg_uri = ";
					print_r($arr_propimg_uri);
					echo "img_api_type = {$img_api_type}\r\n";
					print_r($arr_merge_img);
				}
				//exit;
				
				if(count($arr_merge_img) < 1)
				{
					$arr_err_info[$g_uid][] = "{$err_default_str} : arr_merge_img count zero err";
					$arr_err_cid[$g_uid] = $cid;
					continue;
				}
				
				$vertical_img_num = 0;
				if($is_need_vertical_img > 0)
				{
					if($arr_choose_vertical_img_g_uid[$g_uid])
					{
						$vertical_img_num = $arr_choose_vertical_img_g_uid[$g_uid];
					}
					else if($arr_choose_vertical_img_site_code[$row['site_code']])
					{
						if($row['site_code']==15)//ralphlauren 소스사이트 내부화 작업하면서 임시로 이로직을 추가했으면 추후 100%내부화되면 이로직은 삭제하고 ralphlauren도 $arr_choose_vertical_img_site_code 여기에서 삭제시킬것
						{
							$vertical_img_num = $arr_choose_vertical_img_site_code[$row['site_code']];
							if(in_array($row['site_code'], $ARR_BF_SOURCE_SITE_CODE))
							{
								$vertical_img_num = 1;
							}
						}
						else
						{
							$vertical_img_num = $arr_choose_vertical_img_site_code[$row['site_code']];
						}
					}
					else
					{
						$vertical_img_num = 1;
					}
				}
				$white_bg_img_num = 0;
				if($is_need_white_bg_img > 0)
				{
					if($arr_choose_vertical_img_g_uid[$g_uid])
					{
						$white_bg_img_num = $arr_choose_vertical_img_g_uid[$g_uid];
					}
					else if($arr_choose_vertical_img_site_code[$row['site_code']])
					{
						if($row['site_code']==15)//ralphlauren 소스사이트 내부화 작업하면서 임시로 이로직을 추가했으면 추후 100%내부화되면 이로직은 삭제하고 ralphlauren도 $arr_choose_vertical_img_site_code 여기에서 삭제시킬것
						{
							$white_bg_img_num = $arr_choose_vertical_img_site_code[$row['site_code']];
							if(in_array($row['site_code'], $ARR_BF_SOURCE_SITE_CODE))
							{
								$white_bg_img_num = 1;
							}
						}
						else
						{
							$white_bg_img_num = $arr_choose_vertical_img_site_code[$row['site_code']];
						}
					}
					else
					{
						$white_bg_img_num = 1;
					}
				}
				
				$rotate_img_angle = 0;
				if($arr_b_code_rotate_img[$b_code_t] > 0)//$arr_b_code_rotate_img assign config.inc.php
				{
					$rotate_img_angle = $arr_b_code_rotate_img[$b_code_t];//왼쪽으로 1도 회전 - 소수점도 가능함 즉 0.1 가능
				}
				
				$arr_wget_default_vars = array(
					'view_g_uid'=>$row['view_g_uid'],
					"site_code"=>$row['site_code'],
					"img_type"=>$img_type,
					"c_value"=>$row['c_value'],
					"is_auto_bg_copy"=>$is_auto_bg_copy,
					"is_url_and_now_del_img"=>1,
					"is_http_url"=>0,
					"is_need_byte_img"=>0,
					"is_update_img"=>1,
					"vertical_img_num"=>$vertical_img_num,
					"white_bg_img_num"=>$white_bg_img_num,
					"is_just_need_vertical_img"=>$is_just_need_vertical_img,
					"is_just_need_white_bg_img"=>$is_just_need_white_bg_img,
					"rotate_img_angle"=>$rotate_img_angle,
					"is_yes_print"=>$is_yes_print
				);
				$wget_img_count = 0;
				$is_now_del_img = 0;
				$img_name_num = 1;
				$no_byte_img_dir = "";
				$is_done_trick_img = 0;
				$arr_each_major_img_key = array();
				foreach($arr_merge_img AS $img_key=>$merge_img)
				{
					$is_trick_img = 0;
					$arr_check_trick_img = explode("^|",$merge_img);
					if(count($arr_check_trick_img) > 2)
					{
						$is_trick_img = 1;
					}
					unset($arr_check_trick_img);
					if($is_trick_img>0 && $is_done_trick_img>0)
					{
						continue;
					}
					
					if($is_just_need_vertical_img > 0)
					{
						if($img_name_num < $vertical_img_num)
						{
							$img_name_num++;
							continue;
						}
					}
					if($is_just_need_white_bg_img > 0)
					{
						if($img_name_num < $white_bg_img_num)
						{
							$img_name_num++;
							continue;
						}
					}
					
					$arr_vars = array(
						"source_img"=>$merge_img,
						"img_name_num"=>$img_name_num,
						"img_file_name"=>"{$only_tmall_uid}_{$img_name_num}",
						"vertical_img_file_name"=>"{$only_tmall_uid}_vertical",
						"white_bg_img_file_name"=>"{$only_tmall_uid}_white_bg",
						"is_yes_print"=>$is_yes_print
					);
					$arr_vars = array_merge($arr_vars, $arr_wget_default_vars);
					$arr_wget_result = func_tmall_wget_img($arr_vars);
					//print_r($arr_wget_result);
					//exit;
					unset($arr_vars);
					if($arr_wget_result['result'] == 1)
					{
						if($arr_wget_result['url_or_byte'])
						{
							$arr_check_each_major_img_key = explode("___", $img_key);
							$each_major_img_key = $arr_check_each_major_img_key['0'];
							$arr_each_major_img_key[$each_major_img_key] = 1;
							unset($arr_check_each_major_img_key);
							$arr_img_url_or_byte[$img_key] = $arr_wget_result['url_or_byte'];
						}
						$wget_img_count++;
						if($arr_wget_result['vertical_img_loc'])
						{
							$arr_vertical_img_loc[]  = $arr_wget_result['vertical_img_loc'];
							if($is_just_need_vertical_img > 0)
							{
								break;
							}
						}
						if($arr_wget_result['white_bg_img_loc'])
						{
							$arr_white_bg_img_loc[]  = $arr_wget_result['white_bg_img_loc'];
							if($is_just_need_white_bg_img > 0)
							{
								break;
							}
						}
					}
					if($arr_wget_result['check_info'])
					{
						$arr_check_info[$g_uid][] = $arr_wget_result['check_info'];
					}
					if($arr_wget_result['no_byte_img_dir'])
					{
						$no_byte_img_dir = $arr_wget_result['no_byte_img_dir'];
					}
					if($arr_wget_result['is_now_del_img'] > 0)
					{
						$is_now_del_img = 1;
					}
					
					//$arr_img_lists = glob($root_url_update_src."/*");
					//print_r($arr_img_lists);
					
					if($arr_wget_result['result'] == 1)
					{
						$img_name_num++;
					}
				}
				unset($arr_wget_result);
				if($wget_img_count < 1)
				{
					if($is_now_del_img > 0)
					{
						foreach($arr_server_del_img_ext AS $server_del_img_ext)//$arr_server_del_img_ext assign config.inc.php
						{
							$del_color_img_exec = "rm -rf ".$root_url_update_src."/{$only_tmall_uid}_*.{$server_del_img_ext}";
							if($is_yes_print > 0)
							{
								echo $del_color_img_exec."\r\n";
							}
							if($is_server_del_img > 0)
							{
								exec($del_color_img_exec,$arr_del_color_out_str,$del_color_return_num);
								unset($arr_del_color_out_str);
							}
						}
					}
					/*
					$arr_err_info[$g_uid][] = "{$err_default_str} : wget_img_count count zero err";
					$arr_err_cid[$g_uid] = $cid;
					*/
					
					if(in_array($row['site_code'], $ARR_BF_SOURCE_SITE_CODE))
					{
						if(in_array($row['site_code'], $ARR_USBF_IMG_SITE_CODE))
						{
							$arr_err_null_img_usbf_view_g_uid[] = $row['view_g_uid'];
						}
						else
						{
							$arr_err_null_img_bf_view_g_uid[] = $row['view_g_uid'];
						}
					}
					else
					{
						$prodinc = str_ireplace($SELLER_Q_SRC_STR,"",$row['view_g_uid']);
						$arr_err_null_img_cosmos_prodinc[] = $prodinc;
					}
					
					continue;
				}
				
				if(!$arr_color_img_props[$major_no_s_color])//tmall같은 경우는 칼라별 속성아이디가 존재하는데 이값은 많아야 30개를 넘지 않으므로 그이상일경우에는 major_color값인데 속성아이디가 없을경우가 있음 그래서 아이디값이 있는걸로 대체한다.
				{
					$arr_replace_major_color = array();
					foreach($arr_img_url_or_byte AS $no_s_color_img_key=>$temp_value_uri)
					{
						$arr_no_s_color_img_key = explode("___", $no_s_color_img_key);
						$temp_no_s_color_img_key = $arr_no_s_color_img_key['0'];
						$arr_replace_major_color[$temp_no_s_color_img_key] += 1;
					}
					arsort($arr_replace_major_color);//이미지 많이 가지고 있는 칼라로 대체함.
					//echo("<pre>");print_r($arr_replace_major_color);echo("</pre>");
					$arr_key_replace_major_color = array_keys($arr_replace_major_color);
					$changed_no_s_major_color = $arr_key_replace_major_color['0'];
					//echo $changed_no_s_major_color;
					//echo("<pre>");print_r(array_keys($arr_replace_major_color));echo("</pre>");
					unset($arr_replace_major_color);
					unset($arr_key_replace_major_color);
					
					if($changed_no_s_major_color)
					{
						if($arr_color_img_props[$changed_no_s_major_color])
						{
							if($is_yes_print > 0)
							{
								echo "속성 아이디 값이 없어 major_color 대체 되었음 \r\n";
								echo $major_color." -> ";
							}
							$major_no_s_color = $changed_no_s_major_color;
							$major_color = $arr_ori_color_str[$major_no_s_color];
							if($is_yes_print > 0)
							{
								echo $major_color."\r\n";
							}
						}
					}
				}
				
				if($is_yes_print > 0)
				{	
					echo "arr_img_url_or_byte-1 = ";
					print_r($arr_img_url_or_byte);
					echo "major_no_s_color = {$major_no_s_color}\r\n";
					echo "arr_vertical_img_loc - 1 = ";
					print_r($arr_vertical_img_loc);
					echo "arr_white_bg_img_loc - 1 = ";
					print_r($arr_white_bg_img_loc);
					echo "arr_each_major_img_key = ";
					print_r($arr_each_major_img_key);
					echo "rotate_img_angle = {$rotate_img_angle}\r\n";
				}
				
				$is_replace_img_key = 0;
				foreach($arr_each_major_img_key AS $each_major_img_key=>$each_major_img_value)
				{
					if(!$arr_img_url_or_byte[$each_major_img_key])
					{
						foreach($arr_img_url_or_byte AS $replace_each_major_img_key=>$replace_each_major_img_value)
						{
							$arr_check_each_major_img_key = explode("___", $replace_each_major_img_key);
							if($each_major_img_key == $arr_check_each_major_img_key['0'])
							{
								$is_replace_img_key = 1;
								$arr_img_url_or_byte[$each_major_img_key] = $replace_each_major_img_value;
								unset($arr_img_url_or_byte[$replace_each_major_img_key]);
								break;
							}
						}
					}
				}
				unset($arr_each_major_img_key);
				if($is_replace_img_key > 0)
				{
					ksort($arr_img_url_or_byte);
				}
				if($is_yes_print > 0)
				{	
					echo "replace arr_img_url_or_byte = ";
					print_r($arr_img_url_or_byte);
				}
				
				if(!$arr_img_url_or_byte[$major_no_s_color] && $is_check_just_proc_img<1)
				{
					if(count($arr_img_url_or_byte) > 0)
					{
						$arr_new_img_url_or_byte = array();
						$is_change_major_img_done = 0;
						foreach($arr_img_url_or_byte AS $temp_major_no_s_color_key=>$temp_major_no_s_color_value)
						{
							$temp_major_no_s_color_value = trim($temp_major_no_s_color_value);
							if(!$temp_major_no_s_color_value) continue;
							$arr_temp_major_no_s_color_key = explode("___", $temp_major_no_s_color_key);
							$change_major_no_s_color = $arr_temp_major_no_s_color_key['0'];
							if($is_change_major_img_done<1 && $change_major_no_s_color==$major_no_s_color)
							{
								$arr_new_img_url_or_byte[$major_no_s_color] = $temp_major_no_s_color_value;
								$is_change_major_img_done = 1;
							}
							else
							{
								$arr_new_img_url_or_byte[$temp_major_no_s_color_key] = $temp_major_no_s_color_value;
							}
						}
						if(count($arr_new_img_url_or_byte) > 0)
						{
							$arr_img_url_or_byte = $arr_new_img_url_or_byte;
							unset($arr_new_img_url_or_byte);
							if($is_yes_print > 0)
							{	
								echo "arr_img_url_or_byte-2 = ";
								print_r($arr_img_url_or_byte);
							}
						}
					}
				}
				
				$is_major_img = is_file($arr_img_url_or_byte[$major_no_s_color]);
				if(!$is_major_img && $is_check_just_proc_img<1)
				{
					if($is_now_del_img > 0)
					{
						foreach($arr_server_del_img_ext AS $server_del_img_ext)//$arr_server_del_img_ext assign config.inc.php
						{
							$del_color_img_exec = "rm -rf ".$root_url_update_src."/{$only_tmall_uid}_*.{$server_del_img_ext}";
							if($is_yes_print > 0)
							{
								echo $del_color_img_exec."\r\n";
							}
							if($is_server_del_img > 0)
							{
								exec($del_color_img_exec,$arr_del_color_out_str,$del_color_return_num);
								unset($arr_del_color_out_str);
							}
						}
					}
					/*
					$arr_err_info[$g_uid][] = "{$err_default_str} : wget major img null err";
					$arr_err_cid[$g_uid] = $cid;
					*/
					
					if(in_array($row['site_code'], $ARR_BF_SOURCE_SITE_CODE))
					{
						if(in_array($row['site_code'], $ARR_USBF_IMG_SITE_CODE))
						{
							$arr_err_null_img_usbf_view_g_uid[] = $row['view_g_uid'];
						}
						else
						{
							$arr_err_null_img_bf_view_g_uid[] = $row['view_g_uid'];
						}
					}
					else
					{
						$prodinc = str_ireplace($SELLER_Q_SRC_STR,"",$row['view_g_uid']);
						$arr_err_null_img_cosmos_prodinc[] = $prodinc;
					}
					
					continue;
				}
				
				$is_only_vertical_img = 0;
				$is_only_white_bg_img = 0;
				if($is_just_need_vertical_img > 0)
				{
					$is_only_vertical_img = 1;
				}
				else if($is_just_need_white_bg_img > 0)
				{
					$is_only_white_bg_img = 1;
				}
				
				if(in_array($g_uid, $arr_event_watermark_img_g_uid))//$arr_event_watermark_img_g_uid assign config.inc.php
				{
					$event_sale_price = $arr_price_info['sp_bf_selling_price']*0.95;
					$event_sale_price = ceil($event_sale_price);
					$event_watermark_text = $event_sale_price;
					$len_event_watermark_text = strlen($event_watermark_text);
					$event_save_filename = $root_event_watermark_update_src."/".$only_tmall_uid."_eventwatermark_".date('ymdHis').".jpg";//$root_event_watermark_update_src assign config.inc.php
					$event_text_pos_y = 126;
					if($len_event_watermark_text == 4)
					{
						//$event_text_pos_x = 60;//1000,2000=55 3000=54, 4000이상=54
						//$event_font_size = 50;//1000,2000=30 3000=30,  4000이상=28
						//$event_text_pos_x = 56;//d=39, 1137=45, 1121=42
						//$event_font_size = 36;//d=38, 2643|2034|2399=36, 1121=39
						$event_text_pos_x = 518;
						$event_font_size = 74;
					}
					else if($len_event_watermark_text == 5)
					{
						//$event_text_pos_x = 54;
						//$event_font_size = 30;
						$event_text_pos_y = 122;
						$event_text_pos_x = 510;
						$event_font_size = 66;
					}
					else
					{
						//$event_text_pos_x = 65;
						//$event_font_size = 63;
						//$event_text_pos_x = 59;//d=45, 913=49
						//$event_font_size = 44;
						$event_text_pos_x = 542;
						$event_font_size = 74;
					}
					//$event_watermark_src_image, $event_watermark_font_loc assign config.inc.php
					$make_event_watermark_img = func_text_base_watermark_img($event_watermark_text, $event_watermark_src_image, $event_save_filename, $event_text_pos_x, $event_text_pos_y, $event_watermark_font_loc, $event_font_size, 'UTF-8', 0, 0, 100, 'gif', 'black');
					if($make_event_watermark_img == 1)
					{
						if($arr_img_url_or_byte[$major_no_s_color])
						{
							/* 
							$arr_img_url_or_byte[$major_no_s_color] 사이즈=750x750, $event_save_filename size=222x152 -> x=750-222=528, y=750-152=598
							function func_bf_watermark_goods_img($file_loc, $save_filename, $water_file_loc, $is_save_jpg_name=0, $is_dest_no_need_ext=0, $transparency=100, $dest_x=0, $dest_y=0, $dest_quality=100) 
							*/
							$merge_watermark = func_bf_watermark_goods_img($arr_img_url_or_byte[$major_no_s_color], $arr_img_url_or_byte[$major_no_s_color], $event_save_filename, 1, 1, 100, 0, 626, 100,'gif');//func_bf_watermark_goods_img assign func_extra.inc
							unset($merge_watermark);
						}
						if(count($arr_vertical_img_loc) > 0)
						{
							/* 
							$arr_vertical_img_loc['0'] 사이즈=800x120, $event_save_filename size=324x257 -> x=800-324=476, y=1200-257=943
							function func_bf_watermark_goods_img($file_loc, $save_filename, $water_file_loc, $is_save_jpg_name=0, $is_dest_no_need_ext=0, $transparency=100, $dest_x=0, $dest_y=0, $dest_quality=100) 
							*/
							
							//case-1 : 아래는 위 func_text_base_watermark_img 에서 가져온 자동금액생성 이미지를 같은사이즈 그대로 사용할경우 이용함
							//$merge_watermark = func_bf_watermark_goods_img($arr_vertical_img_loc['0'], $arr_vertical_img_loc['0'], $event_save_filename, 1, 1, 100, 476, 943, 100,'gif');//func_bf_watermark_goods_img assign func_extra.inc
							
							//case-2 : 아래는 위 func_text_base_watermark_img 에서 가져온 자동금액생성 이미지와 다른 사이즈를 이용할경우 이용함.
							$event_save_filename = $root_event_watermark_update_src."/".$only_tmall_uid."_v_eventwatermark_".date('ymdHis').".jpg";//$root_event_watermark_update_src assign config.inc.php
							$event_text_pos_y = 137;
							if($len_event_watermark_text == 4)
							{
								//$event_text_pos_x = 60;
								//$event_font_size = 50;
								//$event_text_pos_x = 77;//d=55, 1137=62, 1877=56, 1121=58
								//$event_font_size = 53;//d=54, 1137=56, 1877=55, 2643|2034|2399=52, 1121=55
								$event_text_pos_x = 506;
								$event_font_size = 80;
							}
							else if($len_event_watermark_text == 5)
							{
								$event_text_pos_y = 132;
								$event_text_pos_x = 500;
								$event_font_size = 70;
							}
							else
							{
								//$event_text_pos_x = 65;
								//$event_font_size = 63;
								//$event_text_pos_x = 80;//d=57, 913=60
								//$event_font_size = 68;
								$event_text_pos_x = 532;
								$event_font_size = 80;
							}
							//$event_watermark_src_v_image, $event_watermark_font_loc assign config.inc.php
							$make_event_watermark_img = func_text_base_watermark_img($event_watermark_text, $event_watermark_src_v_image, $event_save_filename, $event_text_pos_x, $event_text_pos_y, $event_watermark_font_loc, $event_font_size, 'UTF-8', 0, 0, 100, 'gif', 'black');
							if($make_event_watermark_img == 1)
							{
								$merge_watermark = func_bf_watermark_goods_img($arr_vertical_img_loc['0'], $arr_vertical_img_loc['0'], $event_save_filename, 1, 1, 100, 0, 999, 100,'gif');//func_bf_watermark_goods_img assign func_extra.inc
								unset($merge_watermark);
							}
						}
					}
					unset($make_event_watermark_img);
				}
				
				//Required var = $arr_color_img_props, $arr_img_url_or_byte, $outer_id, $g_uid
				$is_update_picture_upload = 1;
				include "/home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/api_picture_upload.inc";
				//Return var = $arr_picture_info, $arr_sort_item_img, $arr_err_img
				if(count($arr_err_img) > 0)
				{
					$err_str = implode(" | ", $arr_err_img);
					$arr_err_info[$g_uid][] =  $apiName." : {$err_default_str} : ".$err_str;
					$arr_err_cid[$g_uid] = $cid;
					unset($arr_err_img);
				}
				else if(count($arr_picture_info[$g_uid]['picture_info']) < 1)
				{
					$arr_err_info[$g_uid][] =  $apiName." : {$err_default_str} : arr_picture_info zero error";
					$arr_err_cid[$g_uid] = $cid;
				}
				else
				{
					$is_picture_upload_done = 1;
				}
				
				if($is_yes_print > 0)
				{	
					echo "arr_picture_info = ";
					print_r($arr_picture_info);
				}
				
				if($is_check_just_proc_img < 1)
				{
					$arr_stillcut_html = array();
					$arr_img_color_name_overlap_check = array();
					$arr_wap_desc = array();
					$pic_url = "";
					$stillcut_idx = 1;
					if(count($arr_picture_info[$g_uid]['picture_info']) > 0)
					{
						foreach($arr_picture_info[$g_uid]['picture_info'] AS $temp_key=>$arr_temp_value)
						{
							if(in_array($arr_temp_value['img_type'], $ARR_ONLY_TMALL_USE_PICTURE_INFO_IMG_TYPE))//$ARR_ONLY_TMALL_USE_PICTURE_INFO_IMG_TYPE assign COMM_FUNC.inc
							{
								continue;
							}
							$url_or_byte_key = $arr_temp_value['url_or_byte_key'];
							$url = $arr_temp_value['url'];
							$url = func_tmall_img_uri_replace($url);
							
							if($stillcut_idx == 1)
							{
								$pic_url = $url;
							}
							
							$arr_key = explode("___",$url_or_byte_key);
							$color_key = trim($arr_key['0']);
							if($arr_ori_color_str[$color_key])
							{
								$arr_wap_desc['03_stillcut'][] = "image^|{$url}_600x600.jpg";
								$stillcut_color_str = "";	
								if(!$arr_img_color_name_overlap_check[$color_key])
								{
									$arr_wap_desc['03_stillcut'][] = "text^|{$arr_ori_color_str[$color_key]}";
									$stillcut_color_str = "<br /><div style='font-weight:bold;font-size:13px;'>{$arr_ori_color_str[$color_key]}</div><br />";
									$arr_img_color_name_overlap_check[$color_key] = 1;
								}
								$stillcut_html = "<div><img src=\"{$url}\" /></div>{$stillcut_color_str}";
							}
							else
							{
								$stillcut_html = "<div><img src=\"{$url}\" /></div>";
								$arr_wap_desc['03_stillcut'][] = "image^|{$url}_600x600.jpg";
							}
							$arr_stillcut_html[] = $stillcut_html;
							$stillcut_idx++;
						}
					}
				}
			}
		}
		$schema_item_execution_file_type = "update";
		$g_info = $row['g_info'];
		$b_code = $b_code_t;
		$g_info_cn = $row['g_info_cn'];
		$is_translate = $row['is_translate'];
		$site_code = $row['site_code'];
		$add_g_info_str = g_info_ca_base_str_add($row['c_value']);
		if($add_g_info_str)
		{
			$add_g_info_str = "<strong style='color:#d27e93;'>* {$add_g_info_str}</strong><br /><br />";
		}
		include "/home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/desc_info.inc";
		//echo $desc."\r\n";
		//exit;
		/*  
		update loop start  
		가격, 상품명, 상품설명, props, property_alias, input_pids, input_str, seller_cids, price, name, desc - taobao.item.update
		활성화/비활성화 - taobao.item.update.listing / taobao.item.update.delisting
		칼라/사이즈 - taobao.item.sku.add / taobao.item.sku.delete 
		*/
		
		if($is_yes_print > 0)
		{
			echo "isAvailable-2 = ".$row['isAvailable']."\r\n";
		}
		
		$is_update_product_result = 0;
		$is_invalid_sku_properties = 0;
		$is_re_updateNimg = 0;
		if($row['isAvailable'] == 2)
		{
			$is_loop_delisting = 0;
			$is_loop_no_err = 1;
			
			/* 수동 삭제
			$arr_del_sku_properties = array(
				'1627207:80882;21923:28316',
				'1627207:3232483;21923:28315'
			);
			*/
			$arr_del_success_sku_id = array();
			$is_loop_continue = 0;
			$is_sku_price_err_update = 0;
			$is_notfound_item = 0;
			$is_item_del = 0;
			
			$arr_get_sku_del = array();
			$arr_tmall_properties = array();
			$arr_bf_del_sku_id = array();
			$is_not_same_sku_price = 0;
			//if((count($arr_sku_id)>0) && ($is_loop_no_err>0))
			if(count($arr_sku_id) > 0)
			{	
				if(count($arr_api_return_value[$g_uid]['arr_sku']) > 0)
				{
					//buyfine db에없고, tmall디비에만 있는경우 tmall propertiesr값을 삭제
					$arr_tmall_sku_price = array();
					foreach($arr_api_return_value[$g_uid]['arr_sku'] AS $arr_get_sku_info)
					{
						$get_properties = $arr_get_sku_info['properties'];
						$arr_tmall_sku_price[] = $arr_get_sku_info['price'];
						$arr_get_properties = explode(";", $get_properties);
						$arr_new_get_properties = array();
						foreach($arr_get_properties AS $new_get_properties)
						{
							$new_get_properties = trim($new_get_properties);
							if(!$new_get_properties) continue;
							$arr_new_get_properties[] = $new_get_properties;
						}
						if(count($arr_new_get_properties) > 0)
						{
							$new_get_properties = implode(";", $arr_new_get_properties);
							$now_tmall_sku_id = trim($arr_get_sku_info['sku_id']);
							$arr_tmall_properties[$now_tmall_sku_id] = $new_get_properties;
							if(!$arr_sku_id[$new_get_properties])
							{
								$arr_get_sku_del[] = $new_get_properties;
							}
						}
					}
					
					if(count($arr_tmall_sku_price) > 0)
					{
						$arr_tmall_sku_price = array_unique($arr_tmall_sku_price);
						if(count($arr_tmall_sku_price) > 1)
						{
							$is_not_same_sku_price = 1;
						}
						if($is_yes_print > 0)
						{
							echo "arr_tmall_sku_price = \r\n";
							print_r($arr_tmall_sku_price);
						}
						unset($arr_tmall_sku_price);
					}
					else
					{
						$is_not_same_sku_price = 1;	
					}
					
					//buyfine db에는 등록된걸로 되어있으나 tmall db에는 없는경우 $arr_add_sku_property 값 제외하고 buyfine propertiesr값을 삭제
					foreach($arr_sku_id AS $sku_properties=>$sku_id)
					{
						if(count($arr_add_sku_property) > 0)
						{
							if(in_array($sku_properties, $arr_add_sku_property))
							{
								continue;
							}
						}
						
						if(!$arr_tmall_properties[$sku_id])
						{
							$arr_bf_del_sku_id[] = "'".$sku_id."'";
						}
					}
				}
			}
			else
			{
				//buyfine DB에 sku정보가 하나도 없고 Tmall에는 sku정보가 있는경우 삭제처리함.
				if($is_db_all_update > 0)
				{
					/*
					$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
					$apiName = "taobao.item.delete";
					$apiParams = array(
						"format" => "json",
						"num_iid" => $num_iid
					);
					$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
					if(is_array($apiReturnJson))
					{
						if($apiReturnJson['item']['num_iid'])
						{
							$check_err_num = 0;
							$is_item_del = 1;
							$arr_notfound_g_uid[] = $g_uid;
						}
						else
						{
							$err_key =implode(", ",array_keys($apiReturnJson));
							$err_str = $err_key." - ".implode(", ",$apiReturnJson);
							$is_loop_no_skip_err = 1;
							foreach($ARR_SKIP_ERR_INFO_STR AS $skip_err_str)//$ARR_SKIP_ERR_INFO_STR assign config.inc.php 
							{
								if(preg_match("/{$skip_err_str}/i", $err_str))
								{
									$is_loop_no_skip_err = 0;
									break;
								}
							}
							if($is_loop_no_skip_err > 0)
							{
								$arr_err_info[$g_uid][] =  $apiName." : ".$err_str;
							}
						}
					}
					else
					{
						$arr_err_info[$g_uid][] = $apiName." : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
					}
					unset($apiClass);
					unset($apiParams);
					unset($apiReturnJson);
					*/
				}
				else
				{
					if($is_yes_print > 0)
					{
						echo "!!!!!! buyfine DB에 sku정보가 하나도 없고 Tmall에는 sku정보가 있는경우 \r\n";
					}
				}
			}
			
			$is_no_err_price = 1;
			$is_sku_price_update = 0;
			//if($is_loop_no_err > 0)
			if($is_item_del < 1)
			{
				$now_bf_price_str = str_replace(",","",$arr_price_info['sp_bf_selling_price']);
				//$now_bf_price_str = str_replace(".","",$now_bf_price_str);
				$now_bf_price_str = trim($now_bf_price_str);
				if($is_yes_print > 0)
				{
					echo "BF_Price={$now_bf_price_str} ({$arr_price_info['sp_bf_selling_price']}), Tmall_Price={$now_tmall_price_str} ({$now_tmall_price_num})\r\n";
				}
				if($is_not_same_sku_price > 0)
				{
					$is_sku_price_update = 1;
				}
				elseif($now_bf_price_str != $now_tmall_price_str)
				{
					$is_sku_price_update = 1;
				}
				else if($db_price != $arr_price_info['sp_bf_selling_price'])
				{
					$is_sku_price_update = 1;
				}
				else if($is_sku_price_err_update > 0)
				{
					$is_sku_price_update = 1;
				}
			}
			
			if($is_yes_print > 0)
			{
				echo "Get del sku ";
				print_r($arr_get_sku_del);
				
				echo "Get now tmall_properties ";
				print_r($arr_tmall_properties);
				
				echo "BF sku del ";
				print_r($arr_bf_del_sku_id);
			}
			if(count($arr_get_sku_del) > 0)
			{
				$arr_del_sku_properties = array_merge($arr_del_sku_properties, $arr_get_sku_del);
				$arr_del_sku_properties = array_unique($arr_del_sku_properties);
			}
			if($is_yes_print > 0)
			{
				echo "del sku properties ";
				print_r($arr_del_sku_properties);
			}
			
			//if($is_loop_no_err > 0)
			if($is_item_del < 1)
			{
				$arr_add_success_sku_id = array();
				if(count($arr_add_sku_property) > 0)
				{
					foreach($arr_add_sku_property AS $add_sku_properties)
					{
						//new add start
						$t_sku_count += $loop_init_stock_num;
						$sku_outer_id = $outer_id."_".$next_sku_outer_id_num;
						$arr_add_success_sku_id[$sku_outer_id]['sku_outer_id'] = $sku_outer_id;
						$arr_add_success_sku_id[$sku_outer_id]['sku_properties'] = $add_sku_properties;
						$arr_add_success_sku_id[$sku_outer_id]['sku_alias_value'] = $arr_add_sku_alias_value[$add_sku_properties];
						$next_sku_outer_id_num++;
						$arr_colorNsize_change_item[] = $g_uid;
						//new add end
					}
					unset($arr_add_sku_property);
					unset($arr_add_sku_alias_value);
				}
				if($is_loop_continue > 0)
				{
					$is_loop_no_err = 0;
				}
			}
			
			//if((count($arr_del_sku_properties)>0) && ($is_loop_no_err>0))
			if((count($arr_del_sku_properties)>0) && ($is_item_del<1))
			{
				foreach($arr_del_sku_properties AS $del_sku_properties)
				{
					//new add start
					if($arr_sku_id[$del_sku_properties])
					{
						$arr_del_success_sku_id[] = "'".$arr_sku_id[$del_sku_properties]."'";
					}
					$arr_colorNsize_change_item[] = $g_uid;
					//new add end
				}
				//unset($arr_del_sku_properties); !!!!! 아래 sku 가격 수정에 이용하기 때문에 unset하지 말것
			}
			if($is_loop_continue > 0)
			{
				$is_loop_no_err = 0;
			}
			//exit;		
			unset($arr_del_sku_properties);
			
			//$arr_bf_del_sku_id
			if(count($arr_bf_del_sku_id) > 0)
			{
				$arr_del_success_sku_id = array_merge($arr_del_success_sku_id, $arr_bf_del_sku_id);
				$arr_del_success_sku_id = array_unique($arr_del_success_sku_id);
			}
			
			$is_need_item_images = 0;
			if($is_loop_img_change > 0)
			{
				$is_need_item_images = 1;
			}
			else if($is_absolute_need_item_images > 0)
			{
				$is_need_item_images = 1;
			}
			
			if($is_yes_print > 0)
			{	
				echo "is_need_item_images = {$is_need_item_images}\r\n";
			}
			
			$schema_xml = "";
			$is_match_size_skus = 1;
			
			$schema_only_tmall_uid = $row['only_tmall_uid'];
			include "/home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/schema_item_field.inc";
			//return var = $schema_xml, $is_match_size_skus
			if($is_yes_print > 0)
			{	
				echo "is_match_size_skus = {$is_match_size_skus}\r\n";
			}
			if($is_match_size_skus < 1)
			{
				$is_loop_delisting = 1;
			}
			
			$is_need_schema_update = 0;
			if($is_just_need_vertical_img>0 || $is_loop_img_change>0 || $is_just_need_white_bg_img>0)
			{
				$is_need_schema_update = 1;
			}
			//$is_need_schema_update = 1;
			$now_bf_no_s_title = strtolower(func_tmall_str_no_space($title, 1));
			$now_bf_price_num = intval($arr_price_info['sp_bf_selling_price']);
			if($is_need_schema_update < 1)
			{
				$arr_vars = array(
					'g_uid'=>$g_uid,
					'is_loop_img_change'=>$is_loop_img_change,
					'is_increment_updatea'=>$is_increment_updatea,
					'now_tmall_approve_status'=>$now_tmall_approve_status,
					'now_bf_status'=>$row['isAvailable'],
					'now_tmall_no_s_title'=>$now_tmall_no_s_title,
					'now_bf_no_s_title'=>$now_bf_no_s_title,
					'now_tmall_price_num'=>$now_tmall_price_num,
					'now_bf_price_num'=>$now_bf_price_num,
					'now_tmall_property_alias'=>$arr_api_return_value[$g_uid]['property_alias'],
					'arr_now_tmall_skus'=>$arr_api_return_value[$g_uid]['arr_sku'],
					'arr_bf_tmall_skus'=>$arr_compare_skus,#assign schema_item_field.inc
					'arr_now_bf_ori_size'=>$arr_now_ori_size,
					'is_code_skus'=>$is_code_skus,#assign schema_item_field.inc
					#'arr_in_sku_no_s_color_str'=>$arr_in_sku_no_s_color_str, #assign schema_item_field.inc
					#'arr_ori_alias_size'=>$arr_ori_alias_size, #assign schema_item_field.inc
					'now_tmall_seller_cids'=>$arr_api_return_value[$g_uid]['seller_cids'],
					'arr_bf_tmall_seller_cids'=>$arr_seller_cids,#assign schema_item_field.inc
					'now_tmall_state'=>$arr_api_return_value[$g_uid]['location_state'],
					'now_tmall_city'=>$arr_api_return_value[$g_uid]['location_city'],
					'now_bf_state'=>$location_state,#assign schema_item_field.inc
					'now_bf_city'=>$location_city,#assign schema_item_field.inc
					'now_tmall_valid_thru'=>$arr_api_return_value[$g_uid]['valid_thru'],
					'now_bf_valid_thru'=>$tmall_valid_thru,
					'is_yes_print'=>$is_yes_print
				);
				unset($arr_seller_cids);
				if($is_yes_print>0)
				{
					echo "arr_vars = ";
					echo("<pre>");print_r($arr_vars);echo("</pre>");
				}
				$arr_is_schema_update = func_tmall_compare_update_data($arr_vars);
				$is_need_schema_update = $arr_is_schema_update['is_update'];
				if($is_yes_print>0)
				{
					echo "arr_is_schema_update = ";
					echo("<pre>");print_r($arr_is_schema_update);echo("</pre>");
				}
				unset($arr_vars);
				unset($arr_is_schema_update);
			}
			if($is_yes_print > 0)
			{
				echo "is_need_schema_update = {$is_need_schema_update}\r\n";
				echo "is_loop_delisting = {$is_loop_delisting}\r\n";
				echo "title_mb_len = {$title_mb_len}\r\n";
				echo "title_byte_len = {$title_byte_len}\r\n";
				echo "arr_del_success_sku_id =\r\n";
				print_r($arr_del_success_sku_id);
				echo "arr_add_success_sku_id =\r\n";
				print_r($arr_add_success_sku_id);
			}
			
			$is_product_schema_update_key = 0;
			$arr_product_properties_value = array(#!!!중요 = 새로 추가되는 정보가 있으면 이 두개 변수에 다 포함 시켜 줄것 - $arr_product_properties_value, $arr_product_properties_error 그리고 tmall_goods_category_props_match에도 추가해줄것
				'50012772'=>array(#女士内衣/男士内衣/家居服 > 睡衣/家居服套装
					'1'=>array(
						'singleCheck'=>array(
							'0'=>array(
								'id'=>'prop_20021',
								'value'=>'20213'
							)
						)
					)
				),
				'50008882'=>array(#女士内衣/男士内衣/家居服 > 内裤
					'1'=>array(
						'singleCheck'=>array(
							'0'=>array(
								'id'=>'prop_20021',
								'value'=>'20213'
							)
						)
					)
				),
				'50012010'=>array(#箱包皮具/热销女包/男包 > 包袋
					'1'=>array(
						'singleCheck'=>array(
							'0'=>array(
								'id'=>'prop_20021',
								'value'=>'3239306'
							)
						)
					)
				),
				'121434005'=>array(#钱包
					'1'=>array(
						'singleCheck'=>array(
							'0'=>array(
								'id'=>'prop_20021',
								'value'=>'29228'
							)
						)
					)
				)
			);
			//exit;
			//if($is_loop_no_err > 0)
			if($is_item_del<1 && $is_match_size_skus>0 && $is_increment_updatea<1)
			{
				$apiName = "tmall.item.schema.update";
				if($is_need_schema_update < 1)
				{
					$is_schema_update_success = 1;
					if($is_yes_print > 0)
					{
						echo "\n\n\n !!! skip update - {$apiName} - {$num_iid} success !!! \n\n\n";
					}
				}
				else
				{
					$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
					$apiParams = array(
						"format" => "json",
						"item_id" => $num_iid,
						"xml_data"=>$schema_xml
					);
					
					$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
					//print_r($apiReturnJson);
					//exit;
					if(is_array($apiReturnJson))
					{
						if($is_yes_print > 0)
						{
							echo "{$apiName} - apiReturnJson\r\n";
							print_r($apiReturnJson);
						}
						if($apiReturnJson['update_item_result'] == $num_iid)
						{
							$is_schema_update_success = 1;
							if($is_yes_print > 0)
							{
								echo "\n\n\n {$apiName} - {$num_iid} success!!! \n\n\n";
							}
						}
						else
						{
							$is_skip_err_sub_code = 0;
							$err_sub_code = strtolower(trim($apiReturnJson['sub_code']));
							$err_sub_msg = strtolower(trim($apiReturnJson['sub_msg']));
							if($is_yes_print > 0)
							{
								echo "{$apiName} - sub_code = {$err_sub_code}\r\n";
								echo "{$apiName} - sub_msg = {$err_sub_msg}\r\n";
							}
							
							if($err_sub_code=='isv.invalid-parameter:sku-price' || $err_sub_code=='isv.invalid-parameter:sku-price-tmall')//sku별 가격이 틀릴경우 발생하는 에러
							{
								$is_sku_price_err_update = 1;
							}
							else if($err_sub_code=='isv.item-get-service-error:item_not_found-tmall' || $err_sub_code=='isv.item-is-delete:invalid-numiid-or-iid' || $err_sub_code=='isv.item-get-service-error:item_not_found' || $err_sub_code=='isv.item-is-delete:invalid-numiid-or-iid-tmall' || $err_sub_code=='isv.item-is-delete:invalid-numiid-or-iid' || $err_sub_code=='isv.item-service-error:ic_checkstep_sku_prop_not_found_in_item')
							{
								$check_err_num = 0;
								if($IS_WGET_RE_PROC_RSYNC_TEMP_HOLDING<1 && $is_work_server>0 && $is_no_delete_goods<1)//$IS_WGET_RE_PROC_RSYNC_TEMP_HOLDING assign COMM_FUNC.inc
								{
									$is_notfound_item = 1;
									$arr_notfound_g_uid[] = $g_uid;
									$is_wget_re_proc++; 
									//$arr_err_null_img_bf_view_g_uid[] = $row['view_g_uid'];
								}
								$is_loop_no_err = 0;
							}
							else if($err_sub_code=='isv.item-update-service-error:ic_checkstep_sku_prop_not_found_in_item' || $err_sub_code=='isv.item-update-service-error:ic_checkstep_sku_prop_not_found_in_item-tmall')
							{
								$check_err_num = 0;
								$arr_sku_notfound_g_uid[] = $g_uid;
								$is_skip_err_sub_code = 1;
							}
							else if($err_sub_code =='isv.invalid-permission:non_migration_item_update')
							{
								$check_err_num = 0;
								$is_loop_delisting = 1;
								$is_loop_delistNdel = 1;
								$is_loop_no_err = 0;
							}
							else if($IS_WGET_RE_PROC_RSYNC_TEMP_HOLDING<1 && $is_work_server>0 && $err_sub_code=='isv.item-service-error:item_properties_error')
							{
								/* 예전에는 product schema 속성 정보가 추가 되면 item삭제하고 새로 상품을 등록을 하였는데 17.07.11부터는  tmall.product.schema.update 이용하여 필욕한 속성을 추가수정해주고 성공하면 tmall.item.schema.update을 다시 처리해줌
								$is_del_properties_error = 0;
								$arr_item_properties_error = array('女裤裤型','大小','腰型、裙长','衣长、袖长','材质成分','款式','适用对象','质地');
								foreach($arr_item_properties_error AS $item_properties_error)
								{
									if(preg_match("/{$item_properties_error}/i", $err_sub_msg))
									{
										if(preg_match("/类目属性在标准属性中不存在/i", $err_sub_msg))
										{
											$is_del_properties_error = 1;
											break;
										}
										else if(preg_match("/类目必选属性未填写/i", $err_sub_msg))
										{
											$is_del_properties_error = 1;
											break;
										}
									}
								}
								if($is_del_properties_error > 0)
								{
									$check_err_num = 0;
									$is_loop_delisting = 1;
									$is_loop_delistNdel = 1;
									$is_loop_no_err = 0;
									$arr_notfound_g_uid[] = $g_uid;
									$is_wget_re_proc++; 
									//$arr_err_null_img_bf_view_g_uid[] = $row['view_g_uid'];
								}
								*/
								$arr_product_properties_error = array(
									'50012772'=>array('1'=>'面料主材质'),
									'50008882'=>array('1'=>'材质'),
									'50012010'=>array('1'=>'质地'),
									'121434005'=>array('1'=>'质地')
								);#!!!중요 = 새로 추가되는 정보가 있으면 이 두개 변수에 다 포함 시켜 줄것 - $arr_product_properties_value, $arr_product_properties_error 그리고 tmall_goods_category_props_match에도 추가해줄것
								if(count($arr_product_properties_error[$cid]) > 0)
								{
									foreach($arr_product_properties_error[$cid] AS $item_properties_key=>$item_properties_error)
									{
										if(preg_match("/{$item_properties_error}/i", $err_sub_msg))
										{
											$is_product_schema_update_key = $item_properties_key;
											break;
										}
									}
								}
								if($is_product_schema_update_key > 0)
								{
									$check_err_num = 0;
									$is_skip_err_sub_code = 1;
								}
							}
							else if($IS_WGET_RE_PROC_RSYNC_TEMP_HOLDING<1 && $is_work_server>0 && $err_sub_code=='isv.invalid-parameter:props,input_str')
							{
								$arr_item_b_code_properties_error = array('72837','3604');//L.K. Bennett, Valentino
								if(in_array($b_code_t, $arr_item_b_code_properties_error))
								{
									if(preg_match("/商品品牌未授权/i", $err_sub_msg))
									{
										$check_err_num = 0;
										$is_loop_delisting = 1;
										$is_loop_delistNdel = 1;
										$is_loop_no_err = 0;
										$arr_notfound_g_uid[] = $g_uid;
										$is_wget_re_proc++; 
										//$arr_err_null_img_bf_view_g_uid[] = $row['view_g_uid'];
									}
								}
							}
							else if($IS_WGET_RE_PROC_RSYNC_TEMP_HOLDING<1 && $is_work_server>0 && $err_sub_code=='isv.missing-parameter:short_title;isv.invalid-parameter:desc_modules' && $cid!=$api_get_cid)
							{
								$check_err_num = 0;
								$is_loop_delisting = 1;
								$is_loop_delistNdel = 1;
								$is_loop_no_err = 0;
								$arr_notfound_g_uid[] = $g_uid;
								$is_wget_re_proc++; 
								//$arr_err_null_img_bf_view_g_uid[] = $row['view_g_uid'];
							}
							else if($err_sub_code=='isv.invalid-parameter:sku_properties')
							{
								//$check_err_num = 0;
								if($is_proc_reupdate < 1)
								{
									if(!preg_match("/上市年份季节/i", $err_sub_msg))
									{
										if(!preg_match("/销售属性必须包含所有sku的属性/i", $err_sub_msg))
										{
											//$is_invalid_sku_properties = 1;//이게 1 값이면 tmall_item_skus 삭제 처리하고 다시 업데이트 처리한다.
										}
									}
								}
							}
							else if($err_sub_code=='isv.invalid-parameter:white_bg_image' || $err_sub_code=='isp.remote-service-error:white_bg_image' || $err_sub_code=='isp.remote-service-error:vertical_image;isp.remote-service-error:white_bg_image')//
							{
								$is_loop_yes_re_white_bg = 1;
								/*
								if(preg_match("/请确认图片底色是否白底或透明并且不能为空白图/i", $err_sub_msg))
								{
									if($row['site_code']==91)//jcrew
									{
									}
									else
									{
										$is_loop_yes_re_white_bg = 0;
									}
								}
								*/								
								if($is_loop_yes_re_white_bg > 0)
								{
									$is_skip_err_sub_code = 1;
									$check_err_num = 0;
									if($is_proc_re_white_bg_img < 1)
									{
										$is_re_updateNimg = 1;//이게 1 값이면 white_bg_image를 예전에 투명이미지를 gif로 만들고 확장자만 png로 처리한경우 에러가 발생하였기때문에 이미지를 정상적으로 png로 만들어서 다시 업데이트 처리한다.
									}
								}
							}
							
							$is_re_img_update = 0;
							if($is_need_item_images<1 && $is_sku_price_err_update<1 && $is_notfound_item<1 && $is_re_updateNimg<1)
							{
								$err_key =implode(", ",array_keys($apiReturnJson));
								$err_str = $err_key." - ".implode(", ",$apiReturnJson);
								foreach($ARR_IMG_ERR_INFO_STR AS $img_err_str)//$ARR_IMG_ERR_INFO_STR assign config.inc.php 
								{
									if(preg_match("/{$img_err_str}/i", $err_str))
									{
										$is_re_img_update = 1;
										break;
									}
								}
							}
							if($is_re_img_update > 0)
							{
								$arr_re_updateNimg_g_uid[] = $g_uid;
								$check_err_num = 0;
							}
							else
							{
								if(in_array($err_sub_code, $ARR_TMALL_SKIP_ERR_SUB_CODE)) // $ARR_TMALL_SKIP_ERR_SUB_CODE assign config.inc.php
								{
									$check_err_num = 0;
									$is_skip_err_sub_code = 1;
								}
								
								if(in_array($cid, $arr_temp_not_insert_cid)) // $arr_temp_not_insert_cid assign schema.inc
								{
									$check_err_num = 0;
									$is_skip_err_sub_code = 1;
								}
								
								$is_loop_err_update_log = 0;
								$add_err_default_str = "";
								if($IS_ABSOLTED_ERR_LOG_UPDATE > 0)
								{
									$is_loop_err_update_log = 1;
									$add_err_default_str = "-ABSOLTED Update Log";
								}
								else if($is_skip_err_sub_code<1 && $is_sku_price_err_update<1 && $is_notfound_item<1)
								{
									$is_loop_err_update_log = 1;
								}
								if($is_yes_print > 0)
								{
									echo "{$apiName} - is_loop_err_update_log = {$is_loop_err_update_log}\r\n";
								}
								if($is_loop_err_update_log > 0)
								{
									$err_key =implode(", ",array_keys($apiReturnJson));
									$err_str = $err_key." - ".implode(", ",$apiReturnJson);
									$is_loop_no_skip_err = 1;
									if($IS_ABSOLTED_ERR_LOG_UPDATE < 1)
									{
										foreach($ARR_SKIP_ERR_INFO_STR AS $skip_err_str)//$ARR_SKIP_ERR_INFO_STR assign config.inc.php 
										{
											if(preg_match("/{$skip_err_str}/i", $err_str))
											{
												$is_loop_no_skip_err = 0;
												break;
											}
										}
									}
									if($is_loop_no_skip_err > 0)
									{
										$arr_err_info[$g_uid][] =  $apiName." : {$err_default_str}{$add_err_default_str} : ".$err_str;
										$arr_err_cid[$g_uid] = $cid;
									}
									$check_err_num++;
									//$is_loop_no_err = 0;
								}
							}
						}
					}
					else
					{
						$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						$arr_err_cid[$g_uid] = $cid;
						$check_err_num++;
					}
					unset($apiClass);
					unset($apiParams);
					unset($apiReturnJson);
									
					/*
		if(count($arr_schema_increment_xml)>0 && $g_uid==6873091)//$arr_schema_increment_xml assign schema_item_field.inc
					{
						$schema_increment_xml = implode("\n", $arr_schema_increment_xml);
						unset($arr_schema_increment_xml);
						$schema_increment_xml = <<<EOD
		<itemParam>
		{$schema_increment_xml}
		</itemParam>
		EOD;
						$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
						$apiName = "tmall.product.schema.update";
						$apiParams = array(
							"format" => "json",
							"product_id" => $product_id,
							"xml_data"=>$schema_increment_xml
						);
						$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
						//print_r($apiReturnJson);
						//exit;
						if(is_array($apiReturnJson))
						{
							if($is_yes_print > 0)
							{
								echo "{$apiName} - apiReturnJson\r\n";
								print_r($apiReturnJson);
							}
						}
						else
						{
							$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
							$arr_err_cid[$g_uid] = $cid;
							$check_err_num++;
						}
						
						unset($apiClass);
						unset($apiParams);
						unset($apiReturnJson);
						unset($schema_increment_xml);
					}
		*/
				}
			}
			
			if($product_id && $is_product_schema_update_key>0 && count($arr_product_properties_value[$cid][$is_product_schema_update_key])>0)
			{
				$arr_product_update_schema_xml = array();
				if(count($arr_product_properties_value[$cid][$is_product_schema_update_key]['singleCheck']) > 0)
				{
					$pUSSingleCheckField = new SingleCheckField();
					$pUSSxmlObj = "";
					foreach($arr_product_properties_value[$cid][$is_product_schema_update_key]['singleCheck'] AS $arr_temp_p_value)
					{
						if($arr_temp_p_value['id'] && $arr_temp_p_value['value'])
						{
							$pUSSingleCheckField->setId($arr_temp_p_value['id']);
							$pUSSingleCheckField->setValue($arr_temp_p_value['value']);
							if($pUSSxmlObj)
							{
								$arr_product_update_schema_xml[] = $pUSSingleCheckField->toParamElement($pUSSxmlObj->addChild("field"))->asXML();
							}
							else
							{
								$pUSSxmlObj = $pUSSingleCheckField->toParamElement();
								$arr_product_update_schema_xml[] = $pUSSxmlObj->asXML();
							}
						}
					}
					unset($pUSSingleCheckField);
					unset($pUSSxmlObj);
				}
				if(count($arr_product_update_schema_xml) > 0)
				{
					$product_update_schema_xml = implode("\n", $arr_product_update_schema_xml);
					$product_update_schema_xml = <<<EOD
<itemrule>
{$product_update_schema_xml}
</itemrule>
EOD;
					$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
					$apiName = "tmall.product.schema.update";
					$apiParams = array(
						"format" => "json",
						"product_id" => $product_id,
						"xml_data"=>$product_update_schema_xml
					);
					$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
					if(is_array($apiReturnJson))
					{
						if($is_yes_print > 0)
						{
							echo "{$apiName} - apiReturnJson\r\n";
							print_r($apiReturnJson);
						}
						if($apiReturnJson['update_product_result'])
						{
							$is_update_product_result = 1;
						}
						else
						{
							$err_sub_code = strtolower(trim($apiReturnJson['sub_code']));
							$err_sub_msg = strtolower(trim($apiReturnJson['sub_msg']));
							if($is_yes_print > 0)
							{
								echo "{$apiName} - sub_code = {$err_sub_code}\r\n";
								echo "{$apiName} - sub_msg = {$err_sub_msg}\r\n";
							}
						}
					}
					else
					{
						$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						$arr_err_cid[$g_uid] = $cid;
						$check_err_num++;
					}
					unset($product_update_schema_xml);
					unset($apiClass);
					unset($apiParams);
					unset($apiReturnJson);
				}
				unset($arr_product_update_schema_xml);
			}
		
			if($is_item_del<1 && $is_increment_updatea>0)
			{
				$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
				$apiName = "tmall.item.schema.increment.update";
				$apiParams = array(
					"format" => "json",
					"item_id" => $num_iid,
					"xml_data"=>$schema_xml
				);
				$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
				//print_r($apiReturnJson);
				//exit;
				if(is_array($apiReturnJson))
				{
					if($is_yes_print > 0)
					{
						echo "{$apiName} - apiReturnJson\r\n";
						print_r($apiReturnJson);
					}
					if($apiReturnJson['update_item_result'] == $num_iid)
					{
						$is_schema_update_success = 1;
						if($is_yes_print > 0)
						{
							echo "{$apiName} - {$num_iid} success!!!\r\n";
						}
					}
					else
					{
						$err_sub_code = strtolower(trim($apiReturnJson['sub_code']));
						$err_sub_msg = strtolower(trim($apiReturnJson['sub_msg']));
						if($is_yes_print > 0)
						{
							echo "{$apiName} - sub_code = {$err_sub_code}\r\n";
							echo "{$apiName} - sub_msg = {$err_sub_msg}\r\n";
						}
					}
				}
				else
				{
					$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
					$arr_err_cid[$g_uid] = $cid;
					$check_err_num++;
				}
				unset($apiClass);
				unset($apiParams);
				unset($apiReturnJson);
			}
			
			unset($schema_xml);
					
			//$is_loop_no_err>0
			$is_loop_db_update = 0;
			if($is_sku_price_update>0 || $is_sku_quantity_change>0 || $is_remain_img_update>0)
			{
				if($is_loop_no_err > 0)
				{
					$is_loop_db_update = 1;
				}
			}
			
			if((count($arr_del_success_sku_id)>0) || (count($arr_add_success_sku_id)>0))
			{
				$is_loop_db_update = 1;
			}
			
			$arr_del_propimg_id = array();
			$arr_del_img_id = array();
			$arr_del_img_g_uid = array();
			$arr_deleted_picture_id = array();
			$is_total_loop_img_change = 0;
			if($is_loop_img_change>0 && $is_item_del<1 && $is_match_size_skus>0)
			{
				$is_total_loop_img_change = 1;
			}
			if($is_yes_print > 0)
			{
				echo "is_total_loop_img_change={$is_total_loop_img_change}\r\n";
				echo "is_just_need_vertical_img={$is_just_need_vertical_img}\r\n";
				echo "is_just_need_white_bg_img={$is_just_need_white_bg_img}\r\n";
			}
			
			if($is_total_loop_img_change>0 || $is_just_need_vertical_img>0 || $is_just_need_white_bg_img>0)
			{
				if(count($arr_api_return_value[$g_uid]['prop_img']) > 0)
				{
					if($is_yes_print > 0)
					{
						echo "update prop_img -\r\n";
						print_r($arr_api_return_value[$g_uid]['prop_img']);
					}
					$is_loop_db_update = 1;
				}
				if(count($arr_api_return_value[$g_uid]['item_img']) > 0)
				{
					$is_loop_db_update = 1;
				}
				
				if(count($arr_item_propimg_id)>0 && $is_check_just_proc_img<1)
				{
					foreach($arr_item_propimg_id AS $del_id)
					{
						$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
						$apiName = "taobao.item.propimg.delete";
						$apiParams = array(
							"format" => "json",
							"num_iid" => $num_iid,
							"id" => $del_id
						);
						$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
						if(is_array($apiReturnJson))
						{
							if($is_yes_print > 0)
							{
								echo "{$apiName} - apiReturnJson\r\n";
								print_r($apiReturnJson);
							}
							if($apiReturnJson['prop_img']['id'])
							{
								$arr_del_propimg_id[] = "'".$del_id."'";
								$arr_del_img_g_uid[] = $g_uid;
							}
							else
							{
								$err_key =implode(", ",array_keys($apiReturnJson));
								$err_str = $err_key." - ".implode(", ",$apiReturnJson);
								$is_loop_no_skip_err = 1;
								foreach($ARR_SKIP_ERR_INFO_STR AS $skip_err_str)//$ARR_SKIP_ERR_INFO_STR assign config.inc.php 
								{
									if(preg_match("/{$skip_err_str}/i", $err_str))
									{
										$is_loop_no_skip_err = 0;
										break;
									}
								}
								if($is_loop_no_skip_err > 0)
								{
									$arr_err_info[$g_uid][] =  $apiName." : ".$err_str;
								}
							}
						}
						else
						{
							$arr_err_info[$g_uid][] = $apiName." : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						}
						unset($apiClass);
						unset($apiParams);
						unset($apiReturnJson);
					}
					unset($arr_item_propimg_id);
					if(count($arr_del_propimg_id) > 0)
					{
						$is_loop_db_update = 1;
					}
				}
				
				if(count($arr_api_return_value[$g_uid]['arr_item_img'])>0 && $is_check_just_proc_img<1)
				{
					//foreach($arr_item_img_id AS $del_id)
					foreach($arr_api_return_value[$g_uid]['arr_item_img'] AS $arr_del_item_img)
					{
						if($arr_del_item_img['id'] < 1)
						{
							continue;
						}
						$del_id = $arr_del_item_img['id'];
						
						$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
						$apiName = "taobao.item.img.delete";
						$apiParams = array(
							"format" => "json",
							"num_iid" => $num_iid,
							"id" => $del_id
						);
						$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
						if(is_array($apiReturnJson))
						{
							if($is_yes_print > 0)
							{
								echo "{$apiName} - apiReturnJson\r\n";
								print_r($apiReturnJson);
							}
							if($apiReturnJson['item_img']['id'])
							{
								$arr_del_img_id[] = "'".$del_id."'";
							}
							else
							{
								$err_key =implode(", ",array_keys($apiReturnJson));
								$err_str = $err_key." - ".implode(", ",$apiReturnJson);
								$is_loop_no_skip_err = 1;
								foreach($ARR_SKIP_ERR_INFO_STR AS $skip_err_str)//$ARR_SKIP_ERR_INFO_STR assign config.inc.php 
								{
									if(preg_match("/{$skip_err_str}/i", $err_str))
									{
										$is_loop_no_skip_err = 0;
										break;
									}
								}
								if($is_loop_no_skip_err > 0)
								{
									$arr_err_info[$g_uid][] =  $apiName." : ".$err_str;
								}
							}
						}
						else
						{
							$arr_err_info[$g_uid][] = $apiName." : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						}
						unset($apiClass);
						unset($apiParams);
						unset($apiReturnJson);
					}
					unset($arr_item_img_id);
					if(count($arr_del_img_id) > 0)
					{
						$is_loop_db_update = 1;
					}
				}
				
				if(count($arr_db_del_picture_id) > 0)
				{
					$arr_del_picture_id = array();
					foreach($arr_db_del_picture_id AS $del_id)
					{
						if($is_just_need_vertical_img>0 && count($arr_vertical_img_id)>0)
						{
							if(!in_array($del_id, $arr_vertical_img_id))
							{
								continue;
							}
						}
						if($is_just_need_white_bg_img>0 && count($arr_white_bg_img_id)>0)
						{
							if(!in_array($del_id, $arr_white_bg_img_id))
							{
								continue;
							}
						}
						if($is_just_need_vertical_img>0 && count($arr_vertical_img_id)<1)
						{
							continue;
						}
						if($is_just_need_white_bg_img>0 && count($arr_white_bg_img_id)<1)
						{
							continue;
						}
						$arr_del_picture_id[] = $del_id;
					}
					unset($arr_db_del_picture_id);
					//required $arr_del_picture_id
					include "/home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/api_picture_delete.inc";
					//return $arr_deleted_picture_id
					unset($arr_del_picture_id);
					if(count($arr_deleted_picture_id) > 0)
					{
						$is_loop_db_update = 1;
					}
				}
				else
				{
					if($is_just_need_vertical_img > 0)
					{
						$is_loop_db_update = 1;
					}
					else if($is_just_need_white_bg_img > 0)
					{
						$is_loop_db_update = 1;
					}
				}
			}
			
			if($is_match_size_skus>0 && $is_item_del<1 && $is_need_item_images>0)//이상하게 xml로 처리해서 칼라이미지, 상품이미지 처리를 하면 처음에는 상품페이지에 그 이미지들이 나오지 않음 그래서 joint api를 이용해서 처리함.
			{
				$arr_joint_color_picture_info = array();
				if(count($arr_picture_info[$g_uid]['color_img'])>0 && $is_check_just_proc_img<1)
				{
					$arr_joint_color_picture_info = $arr_picture_info[$g_uid]['color_img'];
				}
				else if(count($arr_db_picture_info[$g_uid]['color_img']) > 0)
				{
					$arr_joint_color_picture_info = $arr_db_picture_info[$g_uid]['color_img'];
				}
				if(count($arr_joint_color_picture_info) > 0)
				{
					foreach($arr_joint_color_picture_info AS $joint_color_key=>$arr_joint_color_value)
					{
						$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
						$apiName = "taobao.item.joint.propimg";
						$arr_relative_path = func_tmall_get_uri_relative_path($arr_joint_color_value['url']);
						$apiParams = array(
							"format" => "json",
							"properties" => $arr_joint_color_value['properties'],
							"num_iid" => $num_iid,
							"pic_path" => $arr_relative_path['relative_path'],
							"position" => $arr_joint_color_value['position']
						);
						$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
						if(is_array($apiReturnJson))
						{
							if($is_yes_print > 0)
							{
								echo "{$apiName} - apiReturnJson\r\n";
								print_r($apiReturnJson);
							}
						}
						else
						{
							$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						}
						unset($apiClass);
						unset($apiParams);
						unset($apiReturnJson);
					}
				}
				unset($arr_joint_color_picture_info);
				
				$arr_joint_item_picture_info = array();
				$arr_joint_item_sort_item_img = array();
				if(count($arr_picture_info[$g_uid]['picture_info'])>0 && $is_check_just_proc_img<1)
				{
					$arr_joint_item_picture_info = $arr_picture_info[$g_uid]['picture_info'];
					$arr_joint_item_sort_item_img = $arr_sort_item_img;
				}
				else if(count($arr_db_picture_info[$g_uid]['picture_info']) > 0)
				{
					$arr_joint_item_picture_info = $arr_db_picture_info[$g_uid]['picture_info'];
					$arr_joint_item_sort_item_img = $arr_db_sort_item_img;
				}
				
				if(count($arr_joint_item_picture_info)>0 && count($arr_joint_item_sort_item_img)>0)
				{
					$arr_joint_item_img = array();
					ksort($arr_joint_item_sort_item_img);
					$count_product_img = 0;
					foreach($arr_joint_item_sort_item_img AS $img_position)
					{
						if($count_product_img >= $tmall_max_api_img_num)
						{
							break;
						}
						
						if(in_array($arr_joint_item_picture_info[$img_position]['img_type'], $ARR_ONLY_TMALL_USE_PICTURE_INFO_IMG_TYPE))//$ARR_ONLY_TMALL_USE_PICTURE_INFO_IMG_TYPE assign COMM_FUNC.inc
						{
							continue;
						}
						
						$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
						$apiName = "taobao.item.joint.img";
						$arr_relative_path = func_tmall_get_uri_relative_path($arr_joint_item_picture_info[$img_position]['url']);
						$joint_item_is_major = "false";
						if($arr_joint_item_picture_info[$img_position]['is_major'] == 1)
						{
							$joint_item_is_major = "true";
						}
						$apiParams = array(
							"format" => "json",
							"num_iid" => $num_iid,
							"pic_path" => $arr_relative_path['relative_path'],
							"is_major" => $joint_item_is_major,
							"position" => $count_product_img+1
						);
						$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
						if(is_array($apiReturnJson))
						{
							if($is_yes_print > 0)
							{
								echo "{$apiName} - apiReturnJson\r\n";
								print_r($apiReturnJson);
							}
						}
						else
						{
							$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						}
						unset($apiClass);
						unset($apiParams);
						unset($apiReturnJson);
						
						$count_product_img++;
					}
					$total_now_img_upload_count = $count_product_img;
				}
				unset($arr_joint_item_picture_info);
				unset($arr_joint_item_sort_item_img);
			}
			
			$is_remain_img_update = 0;
			if($is_match_size_skus>0 && $is_item_del<1 && $total_now_img_upload_count<$tmall_default_img_count)
			{
				$remain_up_img_count = $tmall_default_img_count-$total_now_img_upload_count;
				$start_remain_position = 6;
				for($r_u_i=1; $remain_up_img_count>=$r_u_i; $r_u_i++)
				{
					$pic_path = $ARR_TMALL_ETC_IMG['detail_trick_bf_0'.$r_u_i];
					$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
					$apiName = "taobao.item.joint.img";
					$apiParams = array(
						"format" => "json",
						"num_iid" => $num_iid,
						"pic_path" => $pic_path,
						"position" => $start_remain_position
					);
					$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
					if(is_array($apiReturnJson))
					{
						if($is_yes_print > 0)
						{
							echo "{$apiName} - apiReturnJson\r\n";
							print_r($apiReturnJson);
						}
						if($apiReturnJson['item_img']['id'])
						{
							$arr_api_return_value[$g_uid]['item_joint_img'][$r_u_i]['created'] = $apiReturnJson['item_img']['created'];
							$arr_api_return_value[$g_uid]['item_joint_img'][$r_u_i]['id'] = $apiReturnJson['item_img']['id'];
							$arr_api_return_value[$g_uid]['item_joint_img'][$r_u_i]['trick_img_num'] = $r_u_i;
							$is_remain_img_update = 1;
						}
					}
					else
					{
						$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						$check_err_num++;
					}
					unset($apiClass);
					unset($apiParams);
					unset($apiReturnJson);
					$start_remain_position++;
				}
			}
			
			if(count($arr_db_item_schema_prop['size_alias']) > 0)//$arr_db_item_schema_prop assign schema_item_field.inc
			{
				$is_loop_db_update = 1;
			}
	
			if($is_loop_db_update>0 && $is_match_size_skus>0 && $is_item_del<1)
			{
				$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
				
				if(count($arr_del_success_sku_id) > 0)
				{
					unset($in_del_success_sku_id);
					unset($arr_del_success_sku_id);
				}
				
				if(count($arr_add_success_sku_id) > 0)
				{
					unset($arr_add_success_sku_id);
				}
				
				if($property_alias)
				{
					$arr_len_max_var = array(
						'property_alias'=>$property_alias
					);
					$arr_str_len_result = func_tmall_over_str_len_check($arr_len_max_var);
					if($arr_str_len_result['is_over'] == 1)
					{
						$arr_check_info[$g_uid][] = $arr_str_len_result['over_info'];
					}
				}
				
				if($db_price!=$arr_price_info['sp_bf_selling_price'] || $was_cid!=$cid)
				{
					if($is_no_err_price > 0)
					{
						$query_ei = "
							UPDATE 
								{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_skus TIS
							SET 
								TI.cid={$cid}, TI.price={$arr_price_info['sp_bf_selling_price']}, TIS.sku_price={$arr_price_info['sp_bf_selling_price']}
							WHERE TI.num_iid=TIS.num_iid
							AND TI.num_iid='{$num_iid}'
						";
						if($is_yes_print > 0)
						{
							echo $query_ei."\r\n";
						}
						dbQuery($query_ei,$dbconn);
						$mysql_errno = mysql_errno($dbconn);
						if($mysql_errno > 0)
						{
							$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query_ei;	
						}
					}
				}
				
				if($is_sku_quantity_change > 0)
				{
				}
				
				if(count($arr_api_return_value[$g_uid]['item_joint_img']) > 0)
				{
					foreach($arr_api_return_value[$g_uid]['item_joint_img'] AS $arr_dbup_item_img)
					{
						$new_img_id = $arr_dbup_item_img['id'];
						$new_trick_img_num = $arr_dbup_item_img['trick_img_num'];
						$new_modified = $arr_dbup_item_img['created'];
						
						$loop_q = "INSERT INTO {$tmall_db}.tmall_item_joint_img (id,num_iid,trick_img_num,modified_time) VALUES ('{$new_img_id}','{$num_iid}',{$new_trick_img_num},'{$new_modified}')";
						dbQuery($loop_q,$dbconn);
						if($is_yes_print > 0)
						{
							echo $loop_q."\r\n";
						}
						$mysql_errno = mysql_errno($dbconn);
						if($mysql_errno > 0)
						{
							//mysql_errno = 1062 -> overlap error
							$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
						}
					}
				}
				
				if(count($arr_api_return_value[$g_uid]['prop_img'])>0 && $is_check_just_proc_img<1)
				{
					$tmall_img_uri = "";
					foreach($arr_api_return_value[$g_uid]['prop_img'] AS $arr_dbup_prop_img)
					{
						$new_img_id = $arr_dbup_prop_img['id'];
						$new_position = $arr_dbup_prop_img['position'];
						if(!$new_img_id) $new_img_id=$new_position."_".$num_iid;
						$new_tmall_img_position = $arr_dbup_prop_img['tmall_img_position'];
						$new_img_url = $arr_dbup_prop_img['url'];
						$new_img_props = $arr_dbup_prop_img['properties'];
						$new_img_color_str = $arr_dbup_prop_img['color_str'];
						$new_modified = $arr_dbup_prop_img['created'];
						if(!$new_position) $new_position=0;
						$is_use_desc = $arr_dbup_prop_img['is_use_desc'];
						if(!$is_use_desc) $is_use_desc=0;
						
						if($new_position == 1)
						{
							$tmall_img_uri = $new_img_url;
						}
						
						$is_new_img_insert = 0;
						if(count($arr_update_new_propimg_id) > 0)
						{
							if(in_array($new_img_id, $arr_update_new_propimg_id))
							{
								$is_new_img_insert = 1;
							}
						}
						
						if($is_new_img_insert > 0)
						{
							$loop_q = "INSERT INTO {$tmall_db}.tmall_item_propimg (id,num_iid,properties,url,color_str,position,tmall_position,is_use_desc,modified_time) VALUES ('{$new_img_id}','{$num_iid}','{$new_img_props}','{$new_img_url}','{$new_img_color_str}',{$new_position},{$new_tmall_img_position},{$is_use_desc},'{$new_modified}')";
						}
						else
						{
							$loop_q = "UPDATE {$tmall_db}.tmall_item_propimg SET properties='{$new_img_props}', url='{$new_img_url}', color_str='{$new_img_color_str}', position={$new_position}, tmall_position={$new_tmall_img_position}, is_use_desc={$is_use_desc}, modified_time='{$new_modified}' WHERE id='{$new_img_id}'";
						}
						dbQuery($loop_q,$dbconn);
						if($is_yes_print > 0)
						{
							echo $loop_q."\r\n";
						}
						$mysql_errno = mysql_errno($dbconn);
						if($mysql_errno > 0)
						{
							//mysql_errno = 1062 -> overlap error
							$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
						}
					}
					if($tmall_img_uri)
					{
						$is_tmall_img_host = 0;
						foreach($ARR_TMALL_IMG_CHECK_HOST_STR AS $check_host_str)//$ARR_TMALL_IMG_CHECK_HOST_STR assign COMM_FUNC.inc
						{
							if(preg_match("/{$check_host_str}/i", $tmall_img_uri))
							{
								$is_tmall_img_host = 1;
								break;
							}
						}
						
						$is_tmall_img_dir = 0;
						foreach($ARR_TMALL_IMG_URI_EXPLODE_STR AS $loop_explode_str)//$ARR_TMALL_IMG_URI_EXPLODE_STR assign COMM_FUNC.inc
						{
							$arr_tmall_img_uri = explode($loop_explode_str, $tmall_img_uri);
							if(count($arr_tmall_img_uri) > 1)
							{
								$is_tmall_img_dir = 1;
								break;
							}
						}
						if($is_tmall_img_host>0 && $is_tmall_img_dir>0)
						{
							$tmall_img_uri = str_ireplace(".jpg","",$arr_tmall_img_uri['1']);
							if($tmall_img_uri)
							{
								$loop_q = "UPDATE {$goods_db}.goods SET tmall_img_uri='{$tmall_img_uri}' WHERE g_uid={$g_uid}";
								if($is_yes_print > 0)
								{
									echo "1 - ".$loop_q."\r\n";
								}
								dbQuery($loop_q,$dbconn);
								$arr_already_update_tmall_img_uri_g_uid[] = $g_uid;
							}
						}
					}
				}
				
				if(count($arr_api_return_value[$g_uid]['item_img'])>0 && $is_check_just_proc_img<1)
				{
					foreach($arr_api_return_value[$g_uid]['item_img'] AS $arr_dbup_item_img)
					{
						$new_img_id = $arr_dbup_item_img['id'];
						$new_position = $arr_dbup_item_img['position'];
						if(!$new_img_id) $new_img_id=$new_position."_".$num_iid;
						$new_img_url = $arr_dbup_item_img['url'];
						$new_modified = $arr_dbup_item_img['created'];
						$new_url_or_byte_key = $arr_dbup_item_img['url_or_byte_key'];
						$is_use_desc = $arr_dbup_item_img['is_use_desc'];
						if(!$is_use_desc) $is_use_desc=0;
						
						$is_new_img_insert = 0;
						if(count($arr_update_new_img_id) > 0)
						{
							if(in_array($new_img_id, $arr_update_new_img_id))
							{
								$is_new_img_insert = 1;
							}
						}
						
						if($is_new_img_insert > 0)
						{
							$loop_q = "INSERT INTO {$tmall_db}.tmall_item_img (id,num_iid,url,position,url_or_byte_key,is_use_desc,modified_time) VALUES ('{$new_img_id}','{$num_iid}','{$new_img_url}',{$new_position},'{$new_url_or_byte_key}',{$is_use_desc},'{$new_modified}')";
						}
						else
						{
							$loop_q = "UPDATE {$tmall_db}.tmall_item_img SET url='{$new_img_url}', position={$new_position}, url_or_byte_key='{$new_url_or_byte_key}', is_use_desc={$is_use_desc}, modified_time='{$new_modified}' WHERE id='{$new_img_id}'";
						}
						dbQuery($loop_q,$dbconn);
						if($is_yes_print > 0)
						{
							echo $loop_q."\r\n";
						}
						$mysql_errno = mysql_errno($dbconn);
						if($mysql_errno > 0)
						{
							//mysql_errno = 1062 -> overlap error
							$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
						}
					}
				}
				
				if($is_yes_print > 0)
				{
					echo "is_wget_re_right_now_success 1 = ".$is_wget_re_right_now_success."\r\n";
				}
				if(count($arr_picture_info[$g_uid]['picture_info']) > 0)
				{
					$tmall_img_uri = "";
					foreach($arr_picture_info[$g_uid]['picture_info'] AS $arr_dbup_picture_info)
					{
						$new_img_id = $arr_dbup_picture_info['id'];
						$new_position = $arr_dbup_picture_info['position'];
						if(!$new_img_id) $new_img_id=$new_position."_".$g_uid;
						$new_is_major = $arr_dbup_picture_info['is_major'];
						$new_img_type = $arr_dbup_picture_info['img_type'];
						$new_url = $arr_dbup_picture_info['url'];
						$new_properties = $arr_dbup_picture_info['properties'];
						$new_url_or_byte_key = $arr_dbup_picture_info['url_or_byte_key'];
						$new_modified = $arr_dbup_picture_info['modified'];
						
						if($is_just_need_vertical_img > 0)
						{
							if($new_img_type != 4)
							{
								continue;
							}
						}
						else if($is_just_need_white_bg_img > 0)
						{
							if($new_img_type != 5)
							{
								continue;
							}
						}
						
						if($new_is_major == 1)
						{
							$tmall_img_uri = $new_url;
						}
						
						$loop_q = "INSERT INTO {$tmall_db}.tmall_picture_info (id,g_uid,position,is_major,img_type,url,properties,url_or_byte_key,modified_time) VALUES ('{$new_img_id}',{$g_uid},{$new_position},{$new_is_major},{$new_img_type},'{$new_url}','{$new_properties}','{$new_url_or_byte_key}','{$new_modified}')";
						dbQuery($loop_q,$dbconn);
						if($is_yes_print > 0)
						{
							echo $loop_q."\r\n";
						}
						$mysql_errno = mysql_errno($dbconn);
						if($mysql_errno > 0)
						{
							//mysql_errno = 1062 -> overlap error
							$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
						}
						else
						{
							if($is_wget_re_right_now_success < 1)
							{
								$is_wget_re_right_now_success = 1;
							}
						}
					}
					
					if($tmall_img_uri)
					{
						$is_tmall_img_host = 0;
						foreach($ARR_TMALL_IMG_CHECK_HOST_STR AS $check_host_str)//$ARR_TMALL_IMG_CHECK_HOST_STR assign COMM_FUNC.inc
						{
							if(preg_match("/{$check_host_str}/i", $tmall_img_uri))
							{
								$is_tmall_img_host = 1;
								break;
							}
						}
						
						$is_tmall_img_dir = 0;
						foreach($ARR_TMALL_IMG_URI_EXPLODE_STR AS $loop_explode_str)//$ARR_TMALL_IMG_URI_EXPLODE_STR assign COMM_FUNC.inc
						{
							$arr_tmall_img_uri = explode($loop_explode_str, $tmall_img_uri);
							if(count($arr_tmall_img_uri) > 1)
							{
								$is_tmall_img_dir = 1;
								break;
							}
						}
						if($is_tmall_img_host>0 && $is_tmall_img_dir>0)
						{
							$tmall_img_uri = str_ireplace(".jpg","",$arr_tmall_img_uri['1']);
							if($tmall_img_uri)
							{
								$loop_q = "UPDATE {$goods_db}.goods SET tmall_img_uri='{$tmall_img_uri}' WHERE g_uid={$g_uid}";
								if($is_yes_print > 0)
								{
									echo "2 - ".$loop_q."\r\n";
								}
								dbQuery($loop_q,$dbconn);
								$arr_already_update_tmall_img_uri_g_uid[] = $g_uid;
							}
						}
					}
				}
				
				if($is_yes_print > 0)
				{
					echo "is_wget_re_right_now_success 2 = ".$is_wget_re_right_now_success."\r\n";
				}
				if($is_wget_re_right_now_success>0 && $view_g_uid)
				{
					$loop_q = "UPDATE {$source_site_grep_db}.wget_re_right_now SET is_re=2, is_tmall_side_update=0, update_num=update_num+1 WHERE view_g_uid='{$view_g_uid}'";
					if($is_yes_print > 0)
					{
						echo $loop_q."\r\n";
					}
					dbQuery($loop_q,$dbconn);
				}
				
				if(count($arr_del_propimg_id)>0 && $is_check_just_proc_img<1)
				{
					$in_del_propimg_id = implode(",", $arr_del_propimg_id);
					$loop_q = "DELETE FROM {$tmall_db}.tmall_item_propimg WHERE id IN ({$in_del_propimg_id}) AND num_iid='{$num_iid}'";
					dbQuery($loop_q,$dbconn);
					if($is_yes_print > 0)
					{
						echo $loop_q."\r\n";
					}
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						//mysql_errno = 1062 -> overlap error
						$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
					}
					unset($arr_del_propimg_id);
					
					$arr_del_img_g_uid = array_unique($arr_del_img_g_uid);
					if(count($arr_already_update_tmall_img_uri_g_uid) > 0)
					{
						$arr_new_del_img_g_uid = array();
						foreach($arr_del_img_g_uid AS $del_img_g_uid)
						{
							if(in_array($del_img_g_uid, $arr_already_update_tmall_img_uri_g_uid))
							{
								continue;
							}
							else
							{
								$arr_new_del_img_g_uid[] = $del_img_g_uid;
							}
						}
						
						if(count($arr_new_del_img_g_uid) > 0)
						{
							$arr_del_img_g_uid = array();
							$arr_del_img_g_uid = $arr_new_del_img_g_uid;
							unset($arr_new_del_img_g_uid);
						}
						else
						{
							unset($arr_del_img_g_uid);
						}
					}
					
					if(count($arr_del_img_g_uid) > 0)
					{
						$arr_chunk_del_img_g_uid = array_chunk($arr_del_img_g_uid, 50);
						foreach($arr_chunk_del_img_g_uid AS $arr_del_img2_g_uid)
						{
							$in_del_img_g_uid = implode(",",$arr_del_img2_g_uid);
							$loop_q = "UPDATE {$goods_db}.goods SET tmall_img_uri='' WHERE g_uid IN ({$in_del_img_g_uid})";
							if($is_yes_print > 0)
							{
								echo "3 - ".$loop_q."\r\n";
							}
							dbQuery($loop_q,$dbconn);
						}
						unset($arr_del_img2_g_uid);
						unset($arr_del_img_g_uid);
					}
				}
				
				if(count($arr_del_img_id)>0 && $is_check_just_proc_img<1)
				{
					$in_del_img_id = implode(",", $arr_del_img_id);
					$loop_q = "DELETE FROM {$tmall_db}.tmall_item_img WHERE id IN ({$in_del_img_id}) AND num_iid='{$num_iid}'";
					dbQuery($loop_q,$dbconn);
					if($is_yes_print > 0)
					{
						echo $loop_q."\r\n";
					}
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						//mysql_errno = 1062 -> overlap error
						$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
					}
					unset($arr_del_img_id);
				}
				
				if(count($arr_deleted_picture_id) > 0)
				{
					$in_del_picture_img_id = implode(",", $arr_deleted_picture_id);
					$loop_q = "DELETE FROM {$tmall_db}.tmall_picture_info WHERE id IN ({$in_del_picture_img_id}) AND g_uid={$g_uid}";
					dbQuery($loop_q,$dbconn);
					if($is_yes_print > 0)
					{
						echo $loop_q."\r\n";
					}
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						//mysql_errno = 1062 -> overlap error
						$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
					}
					unset($arr_deleted_picture_id);
				}
				
				if(count($arr_db_item_schema_prop['size_alias'])>0 && $is_schema_update_success>0)
				{
					$size_alias = implode(";", $arr_db_item_schema_prop['size_alias']);
					$query_ei = "SELECT g_uid, size_alias FROM {$tmall_db}.tmall_item_schema_prop WHERE g_uid={$g_uid}";
					if($is_yes_print > 0)
					{
						echo $query_ei."\r\n";
					}
					$result_ei = dbQuery($query_ei,$dbconn);
					$row_ei = mysql_fetch_assoc($result_ei);
					if(!$row_ei['g_uid'])
					{
						$loop_q = "INSERT INTO {$tmall_db}.tmall_item_schema_prop (g_uid,size_alias) VALUES ({$g_uid},'{$size_alias}')";
						dbQuery($loop_q,$dbconn);
						if($is_yes_print > 0)
						{
							echo $loop_q."\r\n";
						}
						$mysql_errno = mysql_errno($dbconn);
						if($mysql_errno > 0)
						{
							//mysql_errno = 1062 -> overlap error
							$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
						}
					}
					else
					{
						$new_size_alias = "";
						if(!$row_ei['size_alias'])
						{
							$new_size_alias = $size_alias;
						}
						else
						{
							$arr_db_size_alias = explode(";", $row_ei['size_alias']);
							$arr_new_size_alias = array();
							if($is_yes_print > 0)
							{
								echo "arr_db_size_alias = ";
								print_r($arr_db_size_alias);
							}
							foreach($arr_db_item_schema_prop['size_alias'] AS $now_size_alias)
							{
								$no_s_now_size_alias = strtolower(func_tmall_str_no_space($now_size_alias, 1));
								$is_new_alias_size = 1;
								foreach($arr_db_size_alias AS $db_size_alias)
								{
									$no_s_db_size_alias = strtolower(func_tmall_str_no_space($db_size_alias, 1));
									if($no_s_now_size_alias == $no_s_db_size_alias)
									{
										$is_new_alias_size = 0;
										break;
									}
								}
								if($is_new_alias_size > 0)
								{
									$arr_new_size_alias[] = $now_size_alias;
								}
							}
							if(count($arr_new_size_alias) > 0)
							{
								$arr_new_size_alias = array_merge($arr_db_size_alias, $arr_new_size_alias);
								$new_size_alias = implode(";", $arr_new_size_alias);
								unset($arr_new_size_alias);
							}
							unset($arr_db_size_alias);
						}
						
						if($new_size_alias)
						{
							$loop_q = "UPDATE {$tmall_db}.tmall_item_schema_prop SET size_alias='{$new_size_alias}' WHERE g_uid={$g_uid}";
							dbQuery($loop_q,$dbconn);
							if($is_yes_print > 0)
							{
								echo $loop_q."\r\n";
							}
							$mysql_errno = mysql_errno($dbconn);
							if($mysql_errno > 0)
							{
								//mysql_errno = 1062 -> overlap error
								$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
							}
							unset($new_size_alias);
						}
					}
					unset($size_alias);
				}
				
				dbClose($dbconn);
				sleep(1);
			}
	
			if($is_loop_no_err>0 && $is_item_del<1 && $is_match_size_skus>0)
			{
				if($now_tmall_approve_status == 'onsale')
				{
					$check_soldout_num = 0;
					$check_err_num = 0;
					$arr_onsale_num_iid[] = "'".$num_iid."'";
				}
				else
				{
					$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
					$apiName = "taobao.item.update.listing";
					$apiParams = array(
						"format" => "json",
						"num_iid" => $num_iid,
						"num" => $t_sku_count
					);
					$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
					if(is_array($apiReturnJson))
					{
						//print_r($apiReturnJson);
						if($apiReturnJson['item']['num_iid'])
						{
							$check_soldout_num = 0;
							$check_err_num = 0;
							if($row['approve_status'] == 'instock')
							{
								$t_re_stock_num++;
							}
							
							$arr_onsale_num_iid[] = "'".$num_iid."'";
						}
						else
						{
							$err_sub_code = strtolower(trim($apiReturnJson['sub_code']));
							if($err_sub_code=='isv.item-is-delete:invalid-numiid-or-iid' || $err_sub_code=='isv.item-listing-service-error:item_not_found-tmall')//Tmall에서 삭제한경우
							{
								$check_err_num = 0;
								if($is_not_in_site_code_sold_out < 1)
								{
									$check_soldout_num++;
								}
								$arr_instock_num_iid[] = "'".$num_iid."'";
							}
							else
							{
								$err_key =implode(", ",array_keys($apiReturnJson));
								$err_str = $err_key." - ".implode(", ",$apiReturnJson);
								
								if(preg_match("/商品已删除/i", $err_str))
								{
									$check_err_num = 0;
									if($is_not_in_site_code_sold_out < 1)
									{
										$check_soldout_num++;
									}
									$arr_instock_num_iid[] = "'".$num_iid."'";
								}
								else
								{
									$is_loop_no_skip_err = 1;
									foreach($ARR_SKIP_ERR_INFO_STR AS $skip_err_str)//$ARR_SKIP_ERR_INFO_STR assign config.inc.php 
									{
										if(preg_match("/{$skip_err_str}/i", $err_str))
										{
											$is_loop_no_skip_err = 0;
											break;
										}
									}
									if($is_loop_no_skip_err > 0)
									{
										$arr_err_info[$g_uid][] =  $apiName." : {$err_default_str} : ".$err_str;
										$arr_err_cid[$g_uid] = $cid;
									}
									$check_err_num++;
									$is_loop_no_err = 0;
								}
							}
						}
					}
					else
					{
						$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
						$arr_err_cid[$g_uid] = $cid;
						$check_err_num++;
						$is_loop_no_err = 0;
					}
					unset($apiClass);
					unset($apiParams);
					unset($apiReturnJson);
				}
			}
		}
		else
		{
			$is_loop_delisting = 1;
		}
	}
	unset($now_tmall_desc);
	unset($now_bf_desc);	
	if($is_yes_print > 0)
	{
		echo "is_loop_delisting = ".$is_loop_delisting."\r\n";
		echo "is_loop_delistNdel = ".$is_loop_delistNdel."\r\n";
	}
	if($is_loop_delisting > 0)
	{
		if($now_tmall_approve_status == 'instock')
		{
			$check_err_num = 0;
			if($is_not_in_site_code_sold_out < 1)
			{
				$check_soldout_num++;
			}
			$arr_instock_num_iid[] = "'".$num_iid."'";
		}
		else
		{
			$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
			$apiName = "taobao.item.update.delisting";
			$apiParams = array(
				"format" => "json",
				"num_iid" => $num_iid
			);
			$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
			if(is_array($apiReturnJson))
			{
				if($is_yes_print > 0)
				{
					echo "{$apiName} - apiReturnJson\r\n";
					print_r($apiReturnJson);
				}
				if($apiReturnJson['item']['num_iid'])
				{
					$check_err_num = 0;
					if($is_not_in_site_code_sold_out < 1)
					{
						$check_soldout_num++;
					}
					$arr_instock_num_iid[] = "'".$num_iid."'";
				}
				else
				{
					//该商品已被删除
					$err_sub_code = strtolower(trim($apiReturnJson['sub_code']));
					if($err_sub_code=='isv.item-listing-service-error-tmall' || $err_sub_code=='isv.item-is-delete:invalid-numiid-or-iid' || $err_sub_code=='isv.item-listing-service-error:item_not_found-tmall')
					{
						$check_err_num = 0;
						if($is_not_in_site_code_sold_out < 1)
						{
							$check_soldout_num++;
						}
						$arr_instock_num_iid[] = "'".$num_iid."'";
					}
					else
					{
						$err_key =implode(", ",array_keys($apiReturnJson));
						$err_str = $err_key." - ".implode(", ",$apiReturnJson);
						$is_loop_no_skip_err = 1;
						foreach($ARR_SKIP_ERR_INFO_STR AS $skip_err_str)//$ARR_SKIP_ERR_INFO_STR assign config.inc.php 
						{
							if(preg_match("/{$skip_err_str}/i", $err_str))
							{
								$is_loop_no_skip_err = 0;
								break;
							}
						}
						if($is_loop_no_skip_err > 0)
						{
							$arr_err_info[$g_uid][] =  $apiName." : {$err_default_str} : ".$err_str;
							$arr_err_cid[$g_uid] = $cid;
						}
						$check_err_num++;
						continue;
					}
				}
			}
			else
			{
				$arr_err_info[$g_uid][] = $apiName." : {$err_default_str} : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
				$arr_err_cid[$g_uid] = $cid;
				$check_err_num++;
				continue;
			}
			unset($apiClass);
			unset($apiParams);
			unset($apiReturnJson);
		}
	}
	
	if(($is_loop_delistNdel>0) && ($is_db_all_update>0||$is_yes_print>0))
	{
		$apiClass = new JushitaTaobaoClient($tmall_serverUrl, $tmall_app_key, $tmall_app_secret, $tmall_connectTimeOut, $tmall_readTimeOut, $tmall_signMethod, $echoPrint, $echoBrStr);
		$apiName = "taobao.item.delete";
		$apiParams = array(
			"format" => "json",
			"num_iid" => $num_iid
		);
		$apiReturnJson = $apiClass->execute($apiName, $apiParams, $tmall_sessionkey);
		if(is_array($apiReturnJson))
		{
			if($is_yes_print > 0)
			{
				echo "{$apiName} - apiReturnJson\r\n";
				print_r($apiReturnJson);
			}
			if($apiReturnJson['item']['num_iid'])
			{
				$check_err_num = 0;
				$is_item_del = 1;
				$arr_notfound_g_uid[] = $g_uid;
			}
			else
			{
				$err_key =implode(", ",array_keys($apiReturnJson));
				$err_str = $err_key." - ".implode(", ",$apiReturnJson);
				$is_loop_no_skip_err = 1;
				foreach($ARR_SKIP_ERR_INFO_STR AS $skip_err_str)//$ARR_SKIP_ERR_INFO_STR assign config.inc.php 
				{
					if(preg_match("/{$skip_err_str}/i", $err_str))
					{
						$is_loop_no_skip_err = 0;
						break;
					}
				}
				if($is_loop_no_skip_err > 0)
				{
					$arr_err_info[$g_uid][] =  $apiName." : ".$err_str;
				}
			}
		}
		else
		{
			$arr_err_info[$g_uid][] = $apiName." : code=".$apiReturnJson->code.", ".$apiReturnJson->msg;
		}
		unset($apiClass);
		unset($apiParams);
		unset($apiReturnJson);
		
	}
	
	$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
	$add_update_str = "";
	if($is_loop_img_change > 0)
	{
		$add_update_str = ", is_color_changed=0";
	}
	
	if($is_loop_img_max_update>0 && $max_img_update_uid>0 && $is_max_img_continue_check>0)
	{
		dbQuery("UPDATE {$tmall_db}._proc_uid SET continue_stop_num=continue_stop_num-1, update_time=now() WHERE uid={$max_img_update_uid} AND continue_stop_num>0",$dbconn);
	}
	
	if($db_is_schema<1 && $is_schema_update_success>0)
	{
		$loop_query = "UPDATE {$tmall_db}.tmall_item SET is_schema=1 WHERE g_uid={$g_uid}";
		if($is_yes_print > 0)
		{
			echo $loop_query."\r\n";
		}
		dbQuery($loop_query,$dbconn);
	}
	
	$is_yes_update_tmall_img_uri = 1;
	if(count($arr_already_update_tmall_img_uri_g_uid) > 0)
	{
		if(in_array($g_uid, $arr_already_update_tmall_img_uri_g_uid))
		{
			$is_yes_update_tmall_img_uri = 0;
		}
	}
	if($is_yes_print > 0)
	{
		echo "is_yes_update_tmall_img_uri={$is_yes_update_tmall_img_uri}\r\n";
		echo "db_tmall_img_uri={$db_tmall_img_uri}\r\n";
		echo "now_db_tmall_img_uri={$now_db_tmall_img_uri}\r\n";
	}
	if($is_yes_update_tmall_img_uri>0 && !$db_tmall_img_uri && $now_db_tmall_img_uri)
	{
		$loop_q = "UPDATE {$goods_db}.goods SET tmall_img_uri='{$now_db_tmall_img_uri}' WHERE g_uid={$g_uid}";
		if($is_yes_print > 0)
		{
			echo "8 - ".$loop_q."\r\n";
		}
		dbQuery($loop_q,$dbconn);
	}
	
	$loop_query = "UPDATE {$tmall_db}.tmall_item_updated_g_uid SET is_check=1, is_batch_check=1, err_count=0, update_time=now(){$add_update_str} WHERE g_uid={$g_uid}";
	if($is_yes_print > 0)
	{
		echo $loop_query."\r\n";
	}
	dbQuery($loop_query,$dbconn);
	
	if($is_invalid_sku_properties > 0)
	{
		$loop_q = "DELETE FROM {$tmall_db}.tmall_item_skus WHERE g_uid={$g_uid}";
		dbQuery($loop_q,$dbconn);
		if($is_yes_print > 0)
		{
			echo $loop_q."\r\n";
		}
		$mysql_errno = mysql_errno($dbconn);
		if($mysql_errno > 0)
		{
			//mysql_errno = 1062 -> overlap error
			$arr_success_query_err[$g_uid][] = "mysql_errno = ".$mysql_errno." : ".$loop_q;	
		}
	}
	
	if($is_yes_print>0)
	{
		echo "is_work_server={$is_work_server}\n";
		echo "is_wget_re_proc={$is_wget_re_proc}\n";
	}
	if($IS_WGET_RE_PROC_RSYNC_TEMP_HOLDING<1 && $is_work_server>0 && $is_wget_re_proc>1)
	{
		$loop_query = "SELECT view_g_uid, is_re FROM {$source_site_grep_db}.wget_re_right_now WHERE view_g_uid='{$view_g_uid}'";
		if($is_yes_print > 0)
		{
			echo $loop_query."\r\n";
		}
		$loop_result = dbQuery($loop_query,$dbconn);
		$loop_row = mysql_fetch_assoc($loop_result);
		if($loop_row['view_g_uid'])
		{
			if($loop_row['is_re'] > 0)
			{
				$loop_query = "UPDATE {$source_site_grep_db}.wget_re_right_now SET is_re=0, priority_num=1, update_num=0, err_num=0, err_update_num=0, is_tmall_side_update=0 WHERE view_g_uid='{$view_g_uid}' AND is_re>0";
				if($is_yes_print > 0)
				{
					echo $loop_query."\r\n";
				}
				dbQuery($loop_query, $dbconn);
			}
		}
		else
		{
			$loop_query = "INSERT INTO {$source_site_grep_db}.wget_re_right_now (view_g_uid,priority_num,is_re) VALUES ('{$view_g_uid}',1,0)";
			if($is_yes_print > 0)
			{
				echo $loop_query."\r\n";
			}
			dbQuery($loop_query,$dbconn);
		}
	}
	dbClose($dbconn);
	usleep(600000);//wait for 0.6 seconds
	
	$is_rm_rf_loop_img = 0;
	if($is_loop_img_change>0 && $only_tmall_uid)
	{
		$is_rm_rf_loop_img = 1;
	}
	else if($is_just_need_vertical_img>0 && $only_tmall_uid)
	{
		$is_rm_rf_loop_img = 1;
	}
	else if($is_just_need_white_bg_img>0 && $only_tmall_uid)
	{
		$is_rm_rf_loop_img = 1;
	}
	if($g_uid == '8319058')
	{
		//$is_rm_rf_loop_img = 0;
	}
	
	if($is_rm_rf_loop_img > 0)
	{
		unset($arr_img_url_or_byte);
		unset($arr_ss_color_each_img);
		foreach($arr_server_del_img_ext AS $server_del_img_ext)//$arr_server_del_img_ext assign config.inc.php
		{
			$del_color_img_exec = "rm -rf ".$root_url_update_src."/{$only_tmall_uid}_*.{$server_del_img_ext}";
			if($is_yes_print > 0)
			{
				echo $del_color_img_exec."\r\n";
			}
			if($is_server_del_img > 0)
			{
				exec($del_color_img_exec,$arr_del_color_out_str,$del_color_return_num);
				unset($arr_del_color_out_str);
			}
		}
	}
	unset($arr_price_info);
	unset($arr_topdown);
	unset($arr_db_picture_info);
	unset($arr_db_sort_item_img);
	unset($arr_picture_info);
	unset($arr_vertical_img_id);
	unset($arr_white_bg_img_id);
	unset($arr_img_tmall_no_s_color);
	unset($arr_sort_item_img);
	unset($arr_already_update_tmall_img_uri_g_uid);
	unset($arr_db_item_schema_prop);
	unset($arr_api_return_value);
	
	if($is_update_product_result > 0)//원래는 tmall.product.schema.update 성공하면 바로 tmall.item.schema.update 하려고 했는데 tmall.product.schema.update 적용시간이 좀 걸려서 일단 보류시켰음
	{
	
	}
	if($is_invalid_sku_properties > 0)
	{
		$re_update_exec_str = "/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/02_item_update.html proc_reupdate {$g_uid} &";//proc_reupdate = 한번만 더 체크하기 위함임.
		if($is_yes_print>0)
		{
			echo $re_update_exec_str."\r\n";
		}
		exec($re_update_exec_str,$arr_re_out_str,$re_return_num);
		if($re_return_num == '0')
		{
		}
		else
		{
			if($is_yes_print>0)
			{
				echo "exec err\r\n";
			}
		}
		unset($arr_re_out_str);
		unset($re_return_num);	
		sleep(2);
	}
	else if($is_re_updateNimg>0 && $is_max_img_change_continue_update<1 && $is_loop_img_max_update<1)
	{
		$re_update_exec_str = "/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/02_item_update.html re_white_img {$g_uid} &";//proc_reupdate = 한번만 더 체크하기 위함임.
		if($is_yes_print>0)
		{
			echo $re_update_exec_str."\r\n";
		}
		exec($re_update_exec_str,$arr_re_out_str,$re_return_num);
		if($re_return_num == '0')
		{
		}
		else
		{
			if($is_yes_print>0)
			{
				echo "exec err\r\n";
			}
		}
		unset($arr_re_out_str);
		unset($re_return_num);	
		sleep(2);
	}
	if($IS_WGET_RE_PROC_RSYNC_TEMP_HOLDING<1 && $is_work_server>0 && $is_wget_re_proc>1)
	{
		$wget_re_exec_str = "/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/cosmos/wget_re_proc.html 4 {$g_uid} {$row['site_code']} {$row['site_name']} bf_ss 2 &";//if($wget_type=='4') 이면 wget_re_proc.html에서 티몰이미지 디비 겁색을 안하고 무조건 이미지 가져옴.
		if($is_yes_print>0)
		{
			echo $wget_re_exec_str."\r\n";
		}
		exec($wget_re_exec_str,$arr_re_out_str,$re_return_num);
		if($re_return_num == '0')
		{
		}
		else
		{
			if($is_yes_print>0)
			{
				echo "wget_re_proc exec err\r\n";
			}
		}
		unset($arr_re_out_str);
		unset($re_return_num);	
		sleep(2);
	}
}
/*  update loop end  */

$end_time = time(); 
$run_time = $end_time - $start_time;

sleep(1);

$t_active_num = count($arr_onsale_num_iid);
if($t_active_num > 0)
{
	$arr_chunk_num_iid = array_chunk($arr_onsale_num_iid, 100);
	foreach($arr_chunk_num_iid AS $arr_num_iid)
	{
		$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
		$in_num_iid = implode(",",$arr_num_iid);
		$query = "UPDATE {$tmall_db}.tmall_item SET approve_status='onsale' WHERE num_iid IN ({$in_num_iid})";
		//echo $query."\r\n";
		dbQuery($query,$dbconn);
		$mysql_errno = mysql_errno($dbconn);
		if($mysql_errno > 0)
		{
			//mysql_errno = 1062 -> overlap error
			$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
		}
		dbClose($dbconn);
		sleep(1);
	}	
	unset($arr_chunk_num_iid);
	unset($arr_onsale_num_iid);
}

$t_instock_num = count($arr_instock_num_iid);
if($t_instock_num > 0)
{
	$arr_chunk_num_iid = array_chunk($arr_instock_num_iid, 100);
	foreach($arr_chunk_num_iid AS $arr_num_iid)
	{
		$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
		$in_num_iid = implode(",",$arr_num_iid);
		$query = "UPDATE {$tmall_db}.tmall_item SET approve_status='instock' WHERE num_iid IN ({$in_num_iid})";
		//echo $query."\r\n";
		dbQuery($query,$dbconn);
		$mysql_errno = mysql_errno($dbconn);
		if($mysql_errno > 0)
		{
			//mysql_errno = 1062 -> overlap error
			$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
		}
		dbClose($dbconn);
		sleep(1);
	}	
	unset($arr_chunk_num_iid);
	unset($arr_instock_num_iid);
}

$notfound_num = count($arr_notfound_g_uid);
if($notfound_num > 0)
{
	$arr_notfound_g_uid = array_unique($arr_notfound_g_uid);
	$notfound_num = count($arr_notfound_g_uid);
}

if($is_yes_print > 0)
{
	echo "arr_err_info=";
	print_r($arr_err_info);
}
$t_err_num = count($arr_err_info);
if($t_err_num > 0)
{
	$arr_new_err_info = array();
	$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
	foreach($arr_err_info AS $g_uid=>$arr_str)
	{
		if($notfound_num > 0)
		{
			if(in_array($g_uid, $arr_notfound_g_uid))
			{
				continue;
			}
		}
		
		$cid = 0;
		$c_name = "";
		$c_value = "";
		if($arr_err_cid[$g_uid])
		{
			$cid = $arr_err_cid[$g_uid];
			
			$c_value = $arr_tmall_ca[$cid]['c_value'];
			$arr = explode("_",$c_value);
			$arr_c_name = array();
			foreach($arr AS $value)
			{
				$arr_c_name[] = $arr_tmall_ca[$value]['c_name'];
			}
			$c_name = implode(" > ", $arr_c_name);
			$c_name = $c_value." : ".$c_name;
		}
		
		$loop_err = $g_uid."---".$c_name."<br />".implode("<br />",$arr_str);
		$db_err = str_replace("<br />","------",$loop_err);
		$db_err = str_replace("'","`",$db_err);
		$db_err = str_replace("\"","`",$db_err);
		
		//b_code={$b_code_t}, b_name={$b_name}
		$arr_err_b_code = explode("b_code=", $db_err);
		$arr_err_b_code = explode(", b_name", $arr_err_b_code['1']);
		$err_b_code = trim($arr_err_b_code['0']);
		if(!$err_b_code) $err_b_code=0;
		
		$q_err = "INSERT INTO {$tmall_db}.err_tmall_item_update_log (uid,g_uid,cid,b_code,err_info,regist_time) VALUES (NULL,{$g_uid},{$cid},{$err_b_code},'{$db_err}',now())";
		//echo $q_err."\r\n";
		dbQuery($q_err, $dbconn);
		$q_err = "UPDATE {$tmall_db}.tmall_item_updated_g_uid SET err_count=err_count+1 WHERE g_uid={$g_uid}";
		//echo $q_err."\r\n";
		dbQuery($q_err,$dbconn);
		$arr_new_err_info[] = $loop_err;
	}
	dbClose($dbconn);
	sleep(1);
	
	$err = implode("<br /><br />",$arr_new_err_info);	
	//$subject = "[!!!BUYFINE-Tmall] Err - {$execution_file} - ".date("Y-m-d H:i:s");
	//fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
	unset($arr_err_info);
	unset($arr_new_err_info);
	unset($err);
	unset($db_err);
	unset($loop_err);
	unset($arr_err_cid);
}

$sku_notfound_num = count($arr_sku_notfound_g_uid);
if($sku_notfound_num > 0)
{
	$arr_sku_notfound_g_uid = array_unique($arr_sku_notfound_g_uid);
	$sku_notfound_num = count($arr_sku_notfound_g_uid);
	$arr_chunk_g_uid = array_chunk($arr_sku_notfound_g_uid, 50);
	foreach($arr_chunk_g_uid AS $arr_g_uid)
	{
		$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
		foreach($arr_g_uid AS $not_g_uid)
		{
			$query = "INSERT INTO {$tmall_db}._notfound_sku_g_uid (g_uid,regist_time) VALUES ({$not_g_uid},now())";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query, $dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				if($mysql_errno == 1062)
				{
					$query = "UPDATE {$tmall_db}._notfound_sku_g_uid SET err_ct=err_ct+1, regist_time=now() WHERE g_uid={$not_g_uid}";
					dbQuery($query, $dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;
						break;
					}
				}
				else
				{
					$is_no_loop_err = 0;
					$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					break;
				}
			}
		}
		dbClose($dbconn);
		sleep(1);
	}
	
	/*
	$err = implode("\r\n\r\n",$arr_sku_notfound_g_uid);
	$subject = "[!!!BUYFINE-Tmall] SKU NotFound g_uid - {$execution_file} - ".date("Y-m-d H:i:s");
	fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,'text/plain');
	unset($err);
	unset($arr_sku_notfound_g_uid);
	*/
}

$bak_overlap_insert_num = 0;
$is_notfound_query = 1;
$arr_del_picture2_id = array();
//if($notfound_num>0 && $is_notfound_query>0 && $is_db_all_update>0)
$is_insert_notfound_g_uid = 0;
if($is_db_all_update>0 || $is_yes_print>0)
{
	$is_insert_notfound_g_uid = 1;
}
if($is_yes_print > 0)
{
	echo "notfound_num={$notfound_num}, is_insert_notfound_g_uid={$is_insert_notfound_g_uid} \r\n arr_notfound_g_uid=";
	print_r($arr_notfound_g_uid);
}
if($notfound_num>0 && $is_notfound_query>0 && $is_insert_notfound_g_uid>0)
{
	$arr_chunk_g_uid = array_chunk($arr_notfound_g_uid, 50);
	foreach($arr_chunk_g_uid AS $arr_g_uid)
	{
		$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
		$in_del_g_uid = implode(",",$arr_g_uid);		
		
		$is_no_loop_err = 1;
		
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			foreach($arr_g_uid AS $not_g_uid)
			{
				$query = "INSERT INTO {$tmall_db}._notfound_g_uid (g_uid,regist_time) VALUES ({$not_g_uid},now())";
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				dbQuery($query, $dbconn);
				$mysql_errno = mysql_errno($dbconn);
				if($mysql_errno > 0)
				{
					if($mysql_errno == 1062)
					{
						$query = "UPDATE {$tmall_db}._notfound_g_uid SET err_ct=err_ct+1, regist_time=now() WHERE g_uid={$not_g_uid}";
						dbQuery($query, $dbconn);
						$mysql_errno = mysql_errno($dbconn);
						if($mysql_errno > 0)
						{
							$is_no_loop_err = 0;
							$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;
							break;
						}
					}
					else
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
						break;
					}
				}
			}
		}
		
		/*
		$is_no_loop_err = 0;
		if($in_g_uid == '5432734')
		{
			$is_no_loop_err = 1;
		}
		*/
		// tmall product_bak insert start
		$arr_bak_g_uid = array();
		$arr_bak_overlap_g_uid = array();
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "SELECT g_uid FROM {$tmall_bak_db}.tmall_product WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			$result = dbQuery($query, $dbconn);
			while($row=mysql_fetch_assoc($result))
			{
				if(in_array($row['g_uid'], $arr_g_uid))
				{
					$arr_bak_overlap_g_uid[] = $row['g_uid'];
					continue;
				}
			}			
			foreach($arr_g_uid AS $bak_g_uid)
			{
				if(in_array($bak_g_uid, $arr_bak_overlap_g_uid))
				{
					continue;
				}
				$arr_bak_g_uid[] = $bak_g_uid;
			}
			
			if(count($arr_bak_g_uid) > 0)
			{
				$in_bak_g_uid = implode(",",$arr_bak_g_uid);
				$query = "
					INSERT INTO {$tmall_bak_db}.tmall_product
					SELECT * FROM {$tmall_db}.tmall_product WHERE g_uid IN ({$in_bak_g_uid})
				";
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				dbQuery($query,$dbconn);
				$mysql_errno = mysql_errno($dbconn);
				if($mysql_errno > 0)
				{
					$is_no_loop_err = 0;
					$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_product_desc
						SELECT 
							TPD.*
						FROM 
							{$tmall_db}.tmall_product TP, {$tmall_db}.tmall_product_desc TPD 
						WHERE TP.product_id=TPD.product_id
						AND TP.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_product_img
						SELECT 
							TPI.*
						FROM 
							{$tmall_db}.tmall_product TP, {$tmall_db}.tmall_product_img TPI 
						WHERE TP.product_id=TPI.product_id
						AND TP.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_product_propimg
						SELECT 
							TPP.*
						FROM 
							{$tmall_db}.tmall_product TP, {$tmall_db}.tmall_product_propimg TPP 
						WHERE TP.product_id=TPP.product_id
						AND TP.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
			}
		}
		
		// tmall product_bak insert end
		// tmall item_bak insert start
		$arr_bak_g_uid = array();
		$arr_bak_overlap_g_uid = array();
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "SELECT g_uid FROM {$tmall_bak_db}.tmall_item WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			$result = dbQuery($query, $dbconn);
			while($row=mysql_fetch_assoc($result))
			{
				if(in_array($row['g_uid'], $arr_g_uid))
				{
					$arr_bak_overlap_g_uid[] = $row['g_uid'];
					continue;
				}
			}			
			foreach($arr_g_uid AS $bak_g_uid)
			{
				if(in_array($bak_g_uid, $arr_bak_overlap_g_uid))
				{
					continue;
				}
				$arr_bak_g_uid[] = $bak_g_uid;
			}
			
			if(count($arr_bak_g_uid) > 0)
			{
				$in_bak_g_uid = implode(",",$arr_bak_g_uid);
				$query = "
					INSERT INTO {$tmall_bak_db}.tmall_item
					SELECT * FROM {$tmall_db}.tmall_item WHERE g_uid IN ({$in_bak_g_uid})
				";
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				dbQuery($query,$dbconn);
				$mysql_errno = mysql_errno($dbconn);
				if($mysql_errno > 0)
				{
					$is_no_loop_err = 0;
					$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
				}
				
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_info
						SELECT 
							TII.*
						FROM 
							{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_info TII 
						WHERE TI.num_iid=TII.num_iid
						AND TI.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_info_etc
						SELECT 
							TIIE.*
						FROM 
							{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_info_etc TIIE 
						WHERE TI.num_iid=TIIE.num_iid
						AND TI.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_info_prop
						SELECT 
							TIIP.*
						FROM 
							{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_info_prop TIIP 
						WHERE TI.num_iid=TIIP.num_iid
						AND TI.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_img
						SELECT 
							TIIG.*
						FROM 
							{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_img TIIG 
						WHERE TI.num_iid=TIIG.num_iid
						AND TI.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_propimg
						SELECT 
							TIPG.*
						FROM 
							{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_propimg TIPG 
						WHERE TI.num_iid=TIPG.num_iid
						AND TI.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_skus
						SELECT 
							TIS.*
						FROM 
							{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_skus TIS 
						WHERE TI.num_iid=TIS.num_iid
						AND TI.g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_updated_g_uid
						SELECT * FROM {$tmall_db}.tmall_item_updated_g_uid WHERE g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_item_schema_prop
						SELECT * FROM {$tmall_db}.tmall_item_schema_prop WHERE g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				if($is_no_loop_err>0)
				{
					$query = "
						INSERT INTO {$tmall_bak_db}.tmall_picture_info
						SELECT * FROM {$tmall_db}.tmall_picture_info WHERE g_uid IN ({$in_bak_g_uid})
					";
					if($is_yes_print > 0)
					{
						echo $query."\r\n";
					}
					dbQuery($query,$dbconn);
					$mysql_errno = mysql_errno($dbconn);
					if($mysql_errno > 0)
					{
						$is_no_loop_err = 0;
						$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
					}
				}
				unset($arr_bak_g_uid);
			}
		}
		// tmall item_bak insert end
		// tmall product delete start
		
		if($is_no_loop_err>0 && $in_del_g_uid)
		{	
			$query = "
				DELETE
					TPD
				FROM
					{$tmall_db}.tmall_product TP, {$tmall_db}.tmall_product_desc TPD
				WHERE TP.product_id=TPD.product_id
				AND TP.g_uid IN ({$in_del_g_uid})
			";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{	
			$query = "
				DELETE
					TPI
				FROM
					{$tmall_db}.tmall_product TP, {$tmall_db}.tmall_product_img TPI
				WHERE TP.product_id=TPI.product_id
				AND TP.g_uid IN ({$in_del_g_uid})
			";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{	
			$query = "
				DELETE
					TPP
				FROM
					{$tmall_db}.tmall_product TP, {$tmall_db}.tmall_product_propimg TPP 	
				WHERE TP.product_id=TPP.product_id
				AND TP.g_uid IN ({$in_del_g_uid})
			";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "DELETE FROM {$tmall_db}.tmall_product WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		// tmall product delete end
		// tmall item delete start
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "
				DELETE
					TII
				FROM
					{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_info TII
				WHERE TI.num_iid=TII.num_iid
				AND TI.g_uid IN ({$in_del_g_uid})
			";
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "
				DELETE
					TIIE
				FROM
					{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_info_etc TIIE
				WHERE TI.num_iid=TIIE.num_iid
				AND TI.g_uid IN ({$in_del_g_uid})
			";
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "
				DELETE
					TIIP
				FROM
					{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_info_prop TIIP
				WHERE TI.num_iid=TIIP.num_iid
				AND TI.g_uid IN ({$in_del_g_uid})
			";
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "
				DELETE
					TIIG
				FROM
					{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_img TIIG
				WHERE TI.num_iid=TIIG.num_iid
				AND TI.g_uid IN ({$in_del_g_uid})
			";
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "
				DELETE
					TIPG
				FROM
					{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_propimg TIPG
				WHERE TI.num_iid=TIPG.num_iid
				AND TI.g_uid IN ({$in_del_g_uid})
			";
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "
				DELETE
					TIS
				FROM
					{$tmall_db}.tmall_item TI, {$tmall_db}.tmall_item_skus TIS 	
				WHERE TI.num_iid=TIS.num_iid
				AND TI.g_uid IN ({$in_del_g_uid})
			";
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "DELETE FROM {$tmall_db}.tmall_item WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "DELETE FROM {$tmall_db}.tmall_item_updated_g_uid WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "DELETE FROM {$tmall_db}.tmall_item_schema_prop WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			//상품 삭제시 이미지도 삭제해주는데 한번이라도 결제된 상품이면 taobao.picture.upload 에 등록된 이미지는 삭제를 하지않고 디비에서만 삭제처리해준다. 이유는 구매된 상품의 상세보기에서는 주문했을때의 이미지 값을 가지고 있기때문임  (참고: 단 item.img.delete, item.propimg.delete api는 실행함 이유는 해당 api는 이미지 개수 제한이 있기때문임) - 15.06.29 추가
			$query = "SELECT g_uid FROM {$tmall_db}.tmall_payment_each WHERE g_uid IN ({$in_del_g_uid})";
			$result = dbQuery($query,$dbconn);
			$arr_paid_g_uid = array();
			while($row=mysql_fetch_assoc($result))
			{
				$arr_paid_g_uid[] = $row['g_uid'];
			}
			
			$query = "SELECT id, g_uid FROM {$tmall_db}.tmall_picture_info WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			$result = dbQuery($query, $dbconn);
			$num_picture = 0;
			while($row=mysql_fetch_assoc($result))
			{
				$is_del_picture = 1;
				if(count($arr_paid_g_uid) > 0)
				{
					if(in_array($row['g_uid'], $arr_paid_g_uid))
					{
						$is_del_picture = 0;
					}
				}
				if($is_del_picture > 0)
				{
					$arr_del_picture2_id[] = $row['id'];
				}
				$num_picture++;
			}
			unset($arr_paid_g_uid);
			
			if($num_picture > 0)
			{
				$query = "DELETE FROM {$tmall_db}.tmall_picture_info WHERE g_uid IN ({$in_del_g_uid})";
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				dbQuery($query,$dbconn);
				$mysql_errno = mysql_errno($dbconn);
				if($mysql_errno > 0)
				{
					$is_no_loop_err = 0;
					$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
				}
			}
		}
		// tmall item delete start
		// buyfine goods_info update start
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "UPDATE {$goods_db}.goods_info SET is_tmall=0 WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
			
			$query = "UPDATE {$goods_db}.goods SET tmall_img_uri='' WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo "4 - ".$query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}
		//buyfine goods_info update end
		if($is_no_loop_err>0 && $in_del_g_uid)
		{
			$query = "DELETE FROM {$tmall_db}._notfound_g_uid WHERE g_uid IN ({$in_del_g_uid})";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
			$mysql_errno = mysql_errno($dbconn);
			if($mysql_errno > 0)
			{
				$is_no_loop_err = 0;
				$arr_success_query_err[] = "mysql_errno = ".$mysql_errno." : ".$query;	
			}
		}

		dbClose($dbconn);
		sleep(1);
	}	
	unset($arr_chunk_g_uid);
	
	/*
	$err = implode(",",$arr_notfound_g_uid);
	$subject = "[!!!BUYFINE-Tmall] NotFound g_uid - {$execution_file} - ".date("Y-m-d H:i:s");
	fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
	*/
	
	unset($arr_notfound_g_uid);
}

if(count($arr_del_picture2_id) > 0)
{
	$arr_del_picture_id = array();
	$arr_del_picture_id = $arr_del_picture2_id;
	unset($arr_del_picture2_id);
	include "/home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/api_picture_delete.inc";
}

$null_img_err_num = count($arr_err_null_img_usbf_view_g_uid)+count($arr_err_null_img_bf_view_g_uid)+count($arr_err_null_img_cosmos_prodinc);
if(count($arr_err_null_img_usbf_view_g_uid) > 0)
{
	$dbconn = dbSelect($source_site_grep_db,dbConn($source_site_grep_host));
	$arr_err_null_img_usbf_view_g_uid = array_unique($arr_err_null_img_usbf_view_g_uid);
	foreach($arr_err_null_img_usbf_view_g_uid AS $view_g_uid)
	{
		$view_g_uid = trim($view_g_uid);
		if(!$view_g_uid) continue;
		$query = "SELECT view_g_uid, is_re FROM {$source_site_grep_db}.wget_re_right_now WHERE view_g_uid='{$view_g_uid}'";
		if($is_yes_print > 0)
		{
			echo $query."\r\n";
		}
		$result = dbQuery($query,$dbconn);
		$row = mysql_fetch_assoc($result);
		if($row['view_g_uid'])
		{
			if($row['is_re'] > 0)
			{
				$query = "UPDATE {$source_site_grep_db}.wget_re_right_now SET is_re=-1, priority_num=1, update_num=0, err_num=0, err_update_num=0, is_tmall_side_update=0 WHERE view_g_uid='{$view_g_uid}' AND is_re>0";
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				dbQuery($query, $dbconn);
			}
		}
		else
		{
			$query = "INSERT INTO {$source_site_grep_db}.wget_re_right_now (view_g_uid,priority_num,is_re) VALUES ('{$view_g_uid}',1,-1)";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
		}
	}
	dbClose($dbconn);
	unset($arr_err_null_img_usbf_view_g_uid);
	sleep(1);
}
if(count($arr_err_null_img_bf_view_g_uid) > 0)
{
	$dbconn = dbSelect($source_site_grep_db,dbConn($source_site_grep_host));
	$arr_err_null_img_bf_view_g_uid = array_unique($arr_err_null_img_bf_view_g_uid);
	foreach($arr_err_null_img_bf_view_g_uid AS $view_g_uid)
	{
		$view_g_uid = trim($view_g_uid);
		if(!$view_g_uid) continue;
		$query = "SELECT view_g_uid, is_re FROM {$source_site_grep_db}.wget_re_right_now WHERE view_g_uid='{$view_g_uid}'";
		if($is_yes_print > 0)
		{
			echo $query."\r\n";
		}
		$result = dbQuery($query,$dbconn);
		$row = mysql_fetch_assoc($result);
		if($row['view_g_uid'])
		{
			if($row['is_re'] > 0)
			{
				$query = "UPDATE {$source_site_grep_db}.wget_re_right_now SET is_re=0, priority_num=1, update_num=0, err_num=0, err_update_num=0, is_tmall_side_update=0 WHERE view_g_uid='{$view_g_uid}' AND is_re>0";
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				dbQuery($query, $dbconn);
			}
		}
		else
		{
			$query = "INSERT INTO {$source_site_grep_db}.wget_re_right_now (view_g_uid,priority_num,is_re) VALUES ('{$view_g_uid}',1,0)";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
		}
	}
	dbClose($dbconn);
	unset($arr_err_null_img_bf_view_g_uid);
	sleep(1);
}
if(count($arr_err_null_img_cosmos_prodinc) > 0)
{
	$dbconn = dbSelect($cosmos_db,dbConn($cosmos_host));
	$arr_err_null_img_cosmos_prodinc = array_unique($arr_err_null_img_cosmos_prodinc);
	foreach($arr_err_null_img_cosmos_prodinc AS $prodinc)
	{
		$prodinc = trim($prodinc);
		if(!$prodinc) continue;
		$query = "SELECT prodinc, is_re FROM {$cosmos_db}.wget_re_right_now WHERE prodinc='{$prodinc}'";
		if($is_yes_print > 0)
		{
			echo $query."\r\n";
		}
		$result = dbQuery($query,$dbconn);
		$row = mysql_fetch_assoc($result);
		if($row['prodinc'])
		{
			if($row['is_re'] > 0)
			{
				$query = "UPDATE {$cosmos_db}.wget_re_right_now SET is_re=0, priority_num=1, update_num=0, err_num=0, err_update_num=0 WHERE prodinc={$prodinc} AND is_re>0";
				if($is_yes_print > 0)
				{
					echo $query."\r\n";
				}
				dbQuery($query, $dbconn);
			}
		}
		else
		{
			$query = "INSERT INTO {$cosmos_db}.wget_re_right_now (prodinc,priority_num,is_re) VALUES ({$prodinc},1,0)";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query,$dbconn);
		}
	}
	dbClose($dbconn);
	unset($arr_err_null_img_cosmos_prodinc);
	sleep(1);
}

if(count($arr_check_bad_size) > 0)
{
	$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
	
	foreach($arr_check_bad_size AS $cid=>$arr_bad_size)
	{
		foreach($arr_bad_size AS $bad_size)
		{
			$query = "INSERT INTO {$tmall_db}.err_cid_bad_size (uid,cid,bad_size,regist_time) VALUES (NULL,{$cid},'{$bad_size}',now())";
			if($is_yes_print > 0)
			{
				echo $query."\r\n";
			}
			dbQuery($query, $dbconn);
		}
	}
	unset($arr_check_bad_size);
	
	dbClose($dbconn);
	sleep(1);
}

if($is_proc_check > 0)
{
	$dbconn = dbSelect($tmall_db,dbConn($tmall_host));
	dbQuery("UPDATE {$tmall_db}._proc_uid SET is_proc=1 WHERE uid={$execution_proc_id}",$dbconn);
	dbClose($dbconn);
}

if($is_yes_print > 0)
{
	echo "arr_check_info=";
	print_r($arr_check_info);
}
if(count($arr_check_info) > 0)
{
	$arr_new_check_info = array();
	foreach($arr_check_info AS $g_uid=>$arr_str)
	{
		$loop_check = $g_uid."<br />".implode("<br />",$arr_str);
		$arr_new_check_info[] = $loop_check;
	}
	$err = implode("<br /><br />",$arr_new_check_info);
	$subject = "[BUYFINE-Tmall] Check info - {$execution_file} - ".date("Y-m-d H:i:s");
	//fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,$mail_type);
	unset($arr_check_info);
	unset($arr_new_check_info);
	unset($err);
	unset($loop_check);
}

if(count($arr_success_query_err) > 0)
{
	$err = implode("\r\n\r\n",$arr_success_query_err);
	$subject = "[!!!BUYFINE-Tmall] Query err - {$execution_file} - ".date("Y-m-d H:i:s");
	fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$err,'text/plain');
	unset($err);
	unset($arr_success_query_err);
}

if($max_err_str)
{
	$subject = "[!!!BUYFINE-Tmall] {$max_err_str} - {$execution_file} - ".date("Y-m-d H:i:s");
	fsockopen_mail($to_mail,$from_mail,$from_name,$subject,$subject,$mail_type);
}

$t_colorNsize_change_num = 0;
if(count($arr_colorNsize_change_item) > 0)
{
	$arr_colorNsize_change_item = array_unique($arr_colorNsize_change_item);
	$t_colorNsize_change_num = count($arr_colorNsize_change_item);
	unset($arr_colorNsize_change_item);
}

if($is_yes_print > 0)
{
	echo "arr_re_updateNimg_g_uid=";
	print_r($arr_re_updateNimg_g_uid);
}
if(count($arr_re_updateNimg_g_uid) > 0)
{
	$arr_re_updateNimg_g_uid = array_unique($arr_re_updateNimg_g_uid);
	$arr_chunk_re_img_g_uid = array_chunk($arr_re_updateNimg_g_uid, 5);
	foreach($arr_chunk_re_img_g_uid AS $arr_update_g_uid)
	{
		$updateNimg_g_uid = implode(",",$arr_update_g_uid);
		$exec_str = "/usr/local/php/bin/php /home/server/SERVER_SCRIPT/BUYFINE/tmall/goods/02_item_update.html updateNimg {$updateNimg_g_uid} &";
		if($is_yes_print>0)
		{
			echo $exec_str."\r\n";
		}
		exec($exec_str,$arr_out_str,$return_num);
		if($return_num == '0')
		{
		}
		else
		{
			if($is_yes_print>0)
			{
				echo "exec err\r\n";
			}
		}
		unset($arr_out_str);
		unset($return_num);	
	}
	unset($arr_chunk_re_img_g_uid);
	unset($arr_re_updateNimg_g_uid);
}

echo $execution_file." : ".date("Y-m-d H:i:s")." -> RunTime={$run_time}, Total={$t_run_num}, Onsale={$t_active_num}, Instock={$t_instock_num} , Restock={$t_re_stock_num}, Sku_change={$t_colorNsize_change_num}, Not Found={$notfound_num}, SKU Not Found={$sku_notfound_num}, Bak Overlap={$bak_overlap_insert_num}, Err={$t_err_num}, IMG_Err={$null_img_err_num} End\r\n";
?>